<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام تتبع الاستثمارات</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #F2EDD1;
            --secondary: #F9CB99;
            --accent: #280A3E;
            --green: #689B8A;
            --light-bg: #F2EDD1;
            --dark-bg: #1a0f1e;
            --text-light: #2c2c2c;
            --text-dark: #e0e0e0;
            --border-light: #e0d5c7;
            --border-dark: #3a2950;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
        }

        html {
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            scroll-behavior: smooth;
        }

        body {
            background: var(--light-bg);
            color: var(--text-light);
            transition: all 0.4s ease;
            line-height: 1.6;
            display: flex;
        }

        body[data-theme="dark"] {
            background: var(--dark-bg);
            color: var(--text-dark);
        }

        /* Sidebar Navigation - Icons Only */
        .sidebar {
            width: 70px;
            background: white;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            position: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 0;
            z-index: 200;
        }

        body[data-theme="dark"] .sidebar {
            background: #2a1f35;
            box-shadow: 2px 0 8px rgba(0,0,0,0.3);
        }

        .nav-logo {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            border-radius: 10px;
            background: var(--green);
            color: white;
            font-size: 24px;
        }

        .nav-item {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 10px;
            margin: 6px 0;
            transition: all 0.3s ease;
            font-size: 20px;
            color: #999;
            position: relative;
        }

        .nav-item:hover {
            background: var(--primary);
            color: var(--green);
            transform: scale(1.1);
        }

        .nav-item.active {
            background: var(--green);
            color: white;
            box-shadow: 0 4px 12px rgba(104, 155, 138, 0.3);
        }

        .nav-separator {
            width: 30px;
            height: 1px;
            background: var(--border-light);
            margin: 10px 0;
        }

        body[data-theme="dark"] .nav-separator {
            background: var(--border-dark);
        }

        .nav-item.top-section {
            margin-top: auto;
        }

        /* Main Content */
        .main-content {
            margin-right: 70px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 3px solid var(--green);
            padding: 16px 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        body[data-theme="dark"] .header {
            background: #2a1f35;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-left h1 {
            font-size: 24px;
            color: var(--accent);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        body[data-theme="dark"] .header-left h1 {
            color: var(--secondary);
        }

        .header-left p {
            font-size: 13px;
            color: var(--green);
            margin-top: 4px;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .fund-selector {
            padding: 10px 12px;
            border: 2px solid var(--green);
            border-radius: 8px;
            font-family: Cairo;
            font-size: 13px;
            min-width: 200px;
            background: white;
            color: var(--text-light);
            cursor: pointer;
        }

        body[data-theme="dark"] .fund-selector {
            background: #3a2950;
            color: var(--text-dark);
            border-color: var(--green);
        }

        /* Content Area */
        .content-wrapper {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        body[data-theme="dark"] .card {
            background: #2a1f35;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body[data-theme="dark"] .card-title {
            color: var(--secondary);
        }

        /* Grid */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        @media (max-width: 1024px) {
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
            .grid-2 { grid-template-columns: 1fr; }
        }

        @media (max-width: 1024px) {
            .header-controls { gap: 8px; flex-wrap: wrap; }
            .fund-selector { min-width: 160px; }
        }

        @media (max-width: 768px) {
            .sidebar { width: 60px; }
            .nav-item { width: 45px; height: 45px; font-size: 18px; }
            .nav-logo { width: 45px; height: 45px; font-size: 20px; }
            .main-content { margin-right: 60px; }
            .grid-2, .grid-4 { grid-template-columns: 1fr; }
            .content-wrapper { padding: 12px; }
            .header { padding: 12px 16px; }
            .header-left h1 { font-size: 18px; }
            .header-left p { font-size: 12px; }
            .fund-selector { min-width: 120px; font-size: 11px; }
            .card { padding: 14px; margin-bottom: 12px; }
            .card-title { font-size: 14px; }
            .metric-box { padding: 12px; }
            .metric-label { font-size: 11px; }
            .metric-value { font-size: 20px; }
        }

        @media (max-width: 480px) {
            .sidebar { width: 55px; padding: 10px 0; }
            .nav-item { width: 40px; height: 40px; font-size: 16px; margin: 4px 0; }
            .nav-logo { width: 40px; height: 40px; font-size: 18px; margin-bottom: 5px; }
            .main-content { margin-right: 55px; }
            .content-wrapper { padding: 8px; }
            .header { padding: 8px 12px; }
            .header-left h1 { font-size: 16px; gap: 6px; }
            .header-left p { font-size: 11px; }
            .header-controls { gap: 4px; }
            .fund-selector { min-width: 100px; font-size: 10px; padding: 8px 10px; }
            .card { padding: 10px; margin-bottom: 10px; }
            .card-title { font-size: 13px; margin-bottom: 10px; }
            .btn { padding: 8px 12px; font-size: 12px; }
            .btn-group { gap: 6px; }
            .metric-box { padding: 10px; }
            .metric-label { font-size: 10px; margin-bottom: 3px; }
            .metric-value { font-size: 18px; }
            .recommendation-box { padding: 10px 12px; }
            .recommendation-action { font-size: 14px; margin-bottom: 4px; }
            table { font-size: 11px; }
            th, td { padding: 8px; }
            .form-group label { font-size: 12px; }
            .form-group input, .form-group select { padding: 8px 10px; font-size: 13px; }
            .modal-content { padding: 16px; }
            .chart-container { height: 250px; }
        }

        /* Metric Box */
        .metric-box {
            background: linear-gradient(135deg, var(--green) 0%, var(--accent) 100%);
            color: white;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .metric-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            word-break: break-word;
        }

        /* Recommendation Box */
        .recommendation-box {
            background: white;
            color: var(--text-light);
            border-radius: 8px;
            padding: 14px 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
            border-left: 4px solid var(--green);
        }

        body[data-theme="dark"] .recommendation-box {
            background: #2a1f35;
            color: var(--text-dark);
        }

        .recommendation-action {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .recommendation-confidence {
            font-size: 11px;
            opacity: 0.75;
            margin-top: 6px;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 320px;
            margin-bottom: 16px;
        }

        /* Table */
        .table-responsive {
            overflow-x: auto;
            margin-bottom: 16px;
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        body[data-theme="dark"] table {
            background: #2a1f35;
        }

        th {
            background: var(--green);
            color: white;
            padding: 12px;
            text-align: right;
            font-weight: 600;
            font-size: 13px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-light);
            font-size: 13px;
        }

        body[data-theme="dark"] td {
            border-bottom-color: var(--border-dark);
        }

        /* Form */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-light);
            font-size: 13px;
            display: block;
        }

        body[data-theme="dark"] .form-group label {
            color: var(--text-dark);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Cairo', sans-serif;
            background: white;
            color: var(--text-light);
        }

        body[data-theme="dark"] .form-group input,
        body[data-theme="dark"] .form-group select {
            background: #3a2950;
            color: var(--text-dark);
            border-color: var(--border-dark);
        }

        /* Button */
        .btn {
            background: var(--green);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            font-family: 'Cairo', sans-serif;
            font-weight: 500;
        }

        .btn:hover {
            background: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn.secondary {
            background: var(--secondary);
            color: var(--accent);
        }

        .btn.danger {
            background: var(--danger);
            color: white;
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        body[data-theme="dark"] .modal-content {
            background: #2a1f35;
        }

        @media print {
            .sidebar, .header { display: none !important; }
            .main-content { margin-right: 0; }
        }
    </style>
</head>
<body data-theme="light" data-lang="ar">
    <!-- Sidebar Navigation - Icons Only -->
    <div class="sidebar">
        <div class="nav-logo" title="Investment Tracker">
            <i class="fas fa-chart-line"></i>
        </div>
        
        <div class="nav-item active" onclick="switchTab('dashboard')" title="Dashboard">
            <i class="fas fa-chart-pie"></i>
        </div>
        
        <div class="nav-item" onclick="switchTab('transactions')" title="Transactions">
            <i class="fas fa-exchange-alt"></i>
        </div>
        
        <div class="nav-item" onclick="switchTab('funds')" title="Funds">
            <i class="fas fa-list"></i>
        </div>
        
        <div class="nav-item" onclick="switchTab('prices')" title="Prices">
            <i class="fas fa-tag"></i>
        </div>
        
        <div class="nav-item" onclick="switchTab('analytics')" title="Analytics">
            <i class="fas fa-chart-bar"></i>
        </div>
        
        <div class="nav-item" onclick="switchTab('export')" title="Export">
            <i class="fas fa-download"></i>
        </div>

        <div class="nav-separator"></div>

        <div class="nav-item top-section" onclick="toggleTheme()" title="Toggle Theme">
            <i class="fas fa-moon" id="theme-icon"></i>
        </div>

        <div class="nav-item top-section" onclick="toggleLanguage()" title="Toggle Language">
            <i class="fas fa-globe"></i>
        </div>

        <div class="nav-item top-section" onclick="showAddFundModal()" title="Add Fund">
            <i class="fas fa-plus"></i>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1><i class="fas fa-chart-line"></i> <span data-ar="نظام تتبع الاستثمارات" data-en="Investment Tracker">نظام تتبع الاستثمارات</span></h1>
                    <p id="current-fund-display" data-ar="اختر صندوق" data-en="Select a fund">اختر صندوق</p>
                </div>
                <div class="header-controls">
                    <select id="fund-select" class="fund-selector"></select>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-wrapper">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="content active">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-wallet"></i>
                        <span data-ar="ملخص المحفظة" data-en="Portfolio Summary">ملخص المحفظة</span>
                    </div>
                    <div class="grid-4">
                        <div class="metric-box">
                            <div class="metric-label"><i class="fas fa-cubes"></i> <span data-ar="إجمالي الوثائق" data-en="Total Units">إجمالي الوثائق</span></div>
                            <div class="metric-value" id="total-units">0</div>
                        </div>
                        <div class="metric-box secondary" style="background: linear-gradient(135deg, var(--secondary) 0%, #f0c67e 100%); color: var(--accent);">
                            <div class="metric-label"><i class="fas fa-coins"></i> <span data-ar="متوسط الشراء" data-en="Avg Buy">متوسط الشراء</span></div>
                            <div class="metric-value" id="avg-price">0</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label"><i class="fas fa-tag"></i> <span data-ar="السعر الحالي" data-en="Current Price">السعر الحالي</span></div>
                            <div class="metric-value" id="current-price">0</div>
                        </div>
                        <div class="metric-box" id="value-box">
                            <div class="metric-label"><i class="fas fa-dollar-sign"></i> <span data-ar="القيمة الحالية" data-en="Current Value">القيمة الحالية</span></div>
                            <div class="metric-value" id="current-value">0</div>
                        </div>
                    </div>
                </div>

                <!-- Recommendation Box -->
                <div id="recommendation-box" class="recommendation-box">
                    <div class="recommendation-action">
                        <i class="fas fa-lightbulb"></i>
                        <span id="recommendation-text" data-ar="احسب البيانات" data-en="Calculate Data">احسب البيانات</span>
                    </div>
                    <div id="recommendation-explanation"></div>
                    <div class="recommendation-confidence" id="recommendation-confidence"></div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-title"><i class="fas fa-chart-area"></i> <span data-ar="أداء المحفظة" data-en="Performance">أداء المحفظة</span></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <div style="font-size: 11px; color: #999; margin-bottom: 4px;"><span data-ar="إجمالي الاستثمار" data-en="Total Invested">إجمالي الاستثمار</span></div>
                                <div style="font-size: 18px; font-weight: 700; color: var(--green);" id="total-invested">0</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #999; margin-bottom: 4px;"><span data-ar="الربح/الخسارة" data-en="Profit/Loss">الربح/الخسارة</span></div>
                                <div style="font-size: 18px; font-weight: 700;" id="net-profit">0</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #999; margin-bottom: 4px;"><span data-ar="العائد %" data-en="Return %">العائد %</span></div>
                                <div style="font-size: 18px; font-weight: 700;" id="return-pct">0%</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #999; margin-bottom: 4px;"><span data-ar="آخر تحديث" data-en="Last Update">آخر تحديث</span></div>
                                <div style="font-size: 13px; font-weight: 600;" id="last-update">--</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title"><i class="fas fa-history"></i> <span data-ar="تصدير الأسعار" data-en="Export Prices">تصدير جميع الأسعار</span></div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 12px;">
                            <span data-ar="عدد الأسعار المسجلة:" data-en="Prices recorded:">عدد الأسعار المسجلة:</span>
                            <strong id="prices-count">0</strong>
                        </div>
                        <div class="btn-group">
                            <button class="btn" onclick="exportPricesPDF()">
                                <i class="fas fa-file-pdf"></i> <span data-ar="PDF" data-en="PDF">PDF</span>
                            </button>
                            <button class="btn" onclick="exportPricesExcel()">
                                <i class="fas fa-file-excel"></i> <span data-ar="Excel" data-en="Excel">Excel</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-history"></i> <span data-ar="آخر 30 سعر" data-en="Last 30 Prices">آخر 30 سعر</span></div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th><i class="fas fa-calendar"></i> <span data-ar="التاريخ" data-en="Date">التاريخ</span></th>
                                    <th><i class="fas fa-tag"></i> <span data-ar="السعر" data-en="Price">السعر</span></th>
                                    <th><i class="fas fa-arrow-up-down"></i> <span data-ar="التغير %" data-en="Change %">التغير %</span></th>
                                    <th><i class="fas fa-circle"></i> <span data-ar="الحالة" data-en="Status">الحالة</span></th>
                                </tr>
                            </thead>
                            <tbody id="price-history-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div id="transactions" class="content">
                <div class="card">
                    <div class="card-title"><i class="fas fa-plus-circle"></i> <span data-ar="إضافة معاملة" data-en="Add Transaction">إضافة معاملة</span></div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label data-ar="التاريخ" data-en="Date">التاريخ</label>
                            <input type="date" id="tx-date">
                        </div>
                        <div class="form-group">
                            <label data-ar="النوع" data-en="Type">النوع</label>
                            <select id="tx-type">
                                <option value="buy" data-ar="شراء" data-en="Buy">شراء</option>
                                <option value="sell" data-ar="بيع" data-en="Sell">بيع</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-ar="عدد الوثائق" data-en="Units">عدد الوثائق</label>
                            <input type="number" id="tx-units" placeholder="0" step="any">
                        </div>
                        <div class="form-group">
                            <label data-ar="سعر الوثيقة" data-en="Price">سعر الوثيقة</label>
                            <input type="number" id="tx-price" placeholder="0" step="any">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="addTransaction()">
                            <i class="fas fa-check"></i> <span data-ar="إضافة" data-en="Add">إضافة</span>
                        </button>
                        <button class="btn secondary" onclick="clearTxForm()">
                            <i class="fas fa-redo"></i> <span data-ar="مسح" data-en="Clear">مسح</span>
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-list"></i> <span data-ar="سجل المعاملات" data-en="Transactions Log">سجل المعاملات</span></div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th><i class="fas fa-calendar"></i> <span data-ar="التاريخ" data-en="Date">التاريخ</span></th>
                                    <th><i class="fas fa-exchange-alt"></i> <span data-ar="النوع" data-en="Type">النوع</span></th>
                                    <th><i class="fas fa-cubes"></i> <span data-ar="الوثائق" data-en="Units">الوثائق</span></th>
                                    <th><i class="fas fa-tag"></i> <span data-ar="السعر" data-en="Price">السعر</span></th>
                                    <th><i class="fas fa-money-bill"></i> <span data-ar="المبلغ" data-en="Amount">المبلغ</span></th>
                                    <th><i class="fas fa-percent"></i> <span data-ar="الرسوم" data-en="Fees">الرسوم</span></th>
                                    <th><i class="fas fa-check"></i> <span data-ar="صافي" data-en="Net">صافي</span></th>
                                    <th><i class="fas fa-trash"></i> <span data-ar="حذف" data-en="Delete">حذف</span></th>
                                </tr>
                            </thead>
                            <tbody id="transactions-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Funds Tab -->
            <div id="funds" class="content">
                <div class="card">
                    <div class="card-title"><i class="fas fa-list"></i> <span data-ar="قائمة الصناديق" data-en="Funds List">قائمة الصناديق</span></div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th><i class="fas fa-info"></i> <span data-ar="الاسم" data-en="Name">الاسم</span></th>
                                    <th><i class="fas fa-code"></i> <span data-ar="الكود" data-en="Code">الكود</span></th>
                                    <th><i class="fas fa-tag"></i> <span data-ar="السعر" data-en="Price">السعر</span></th>
                                    <th><i class="fas fa-exchange-alt"></i> <span data-ar="رسوم" data-en="Fees">رسوم</span></th>
                                    <th><i class="fas fa-trash"></i> <span data-ar="حذف" data-en="Delete">حذف</span></th>
                                </tr>
                            </thead>
                            <tbody id="funds-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Prices Tab -->
            <div id="prices" class="content">
                <div class="card">
                    <div class="card-title"><i class="fas fa-calendar-alt"></i> <span data-ar="تاريخ اليوم" data-en="Today">تاريخ اليوم</span>: <span id="today-date" style="color: var(--green); font-weight: 700;">--</span></div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-edit"></i> <span data-ar="تحديث سعر الوثيقة" data-en="Update Price">تحديث سعر الوثيقة</span></div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label data-ar="اسم الصندوق" data-en="Fund Name">اسم الصندوق</label>
                            <input type="text" id="price-fund-name" readonly style="background: #f0f0f0; cursor: not-allowed;">
                        </div>
                        <div class="form-group">
                            <label data-ar="السعر الجديد" data-en="New Price">السعر الجديد</label>
                            <input type="number" id="price-new" placeholder="0" step="any">
                        </div>
                    </div>
                    <div class="form-group">
                        <label data-ar="التاريخ" data-en="Date">التاريخ</label>
                        <input type="date" id="price-date">
                    </div>
                    <button class="btn" onclick="updatePrice()" style="width: 100%; justify-content: center;">
                        <i class="fas fa-check"></i> <span data-ar="تحديث" data-en="Update">تحديث</span>
                    </button>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="content">
                <div class="grid-2">
                    <div class="card">
                        <div class="card-title"><i class="fas fa-chart-line"></i> <span data-ar="تطور الأسعار" data-en="Price Evolution">تطور الأسعار</span></div>
                        <div class="chart-container">
                            <canvas id="priceChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title"><i class="fas fa-pie-chart"></i> <span data-ar="توزيع المحفظة" data-en="Portfolio Distribution">توزيع المحفظة</span></div>
                        <div class="chart-container">
                            <canvas id="portfolioChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-title"><i class="fas fa-chart-area"></i> <span data-ar="الأداء الشهري" data-en="Monthly Performance">الأداء الشهري</span></div>
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title"><i class="fas fa-percent"></i> <span data-ar="العائد على الاستثمار" data-en="Return on Investment">العائد على الاستثمار</span></div>
                        <div class="chart-container">
                            <canvas id="returnChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-chart-bar"></i> <span data-ar="إحصائيات شاملة" data-en="Complete Statistics">إحصائيات شاملة</span></div>
                    <div class="grid-2">
                        <div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 8px;"><i class="fas fa-list"></i> <span data-ar="عدد الصناديق" data-en="Number of Funds">عدد الصناديق</span></div>
                            <div style="font-size: 28px; font-weight: 700; color: var(--green);" id="stats-funds">0</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 8px;"><i class="fas fa-exchange-alt"></i> <span data-ar="عدد المعاملات" data-en="Total Transactions">عدد المعاملات</span></div>
                            <div style="font-size: 28px; font-weight: 700; color: var(--green);" id="stats-transactions">0</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 8px;"><i class="fas fa-trophy"></i> <span data-ar="أفضل صندوق" data-en="Best Fund">أفضل صندوق</span></div>
                            <div style="font-size: 18px; font-weight: 700; color: var(--success);" id="stats-best">--</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 8px;"><i class="fas fa-exclamation-triangle"></i> <span data-ar="أسوأ صندوق" data-en="Worst Fund">أسوأ صندوق</span></div>
                            <div style="font-size: 18px; font-weight: 700; color: var(--danger);" id="stats-worst">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Tab -->
            <div id="export" class="content">
                <div class="card">
                    <div class="card-title"><i class="fas fa-download"></i> <span data-ar="تصدير البيانات" data-en="Export Data">تصدير البيانات</span></div>
                    <div class="btn-group">
                        <button class="btn" onclick="exportJSON()">
                            <i class="fas fa-database"></i> JSON
                        </button>
                        <button class="btn" onclick="exportCSV()">
                            <i class="fas fa-file-csv"></i> CSV
                        </button>
                        <button class="btn" onclick="exportExcel()">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                        <button class="btn" onclick="exportPDF()">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-upload"></i> <span data-ar="استيراد البيانات" data-en="Import Data">استيراد البيانات</span></div>
                    <div class="form-group">
                        <label data-ar="اختر ملف" data-en="Choose File">اختر ملف</label>
                        <input type="file" id="import-file" accept=".json,.csv,.xlsx">
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="importFile()">
                            <i class="fas fa-check"></i> <span data-ar="استيراد" data-en="Import">استيراد</span>
                        </button>
                        <button class="btn danger" onclick="clearAllData()">
                            <i class="fas fa-trash"></i> <span data-ar="مسح الكل" data-en="Clear All">مسح الكل</span>
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-info-circle"></i> <span data-ar="معلومات التطبيق" data-en="App Info">معلومات التطبيق</span></div>
                    <div style="font-size: 13px; color: #666;">
                        <p><span data-ar="الصناديق:" data-en="Funds:">الصناديق:</span> <strong id="info-funds">0</strong></p>
                        <p><span data-ar="المعاملات:" data-en="Transactions:">المعاملات:</span> <strong id="info-transactions">0</strong></p>
                        <p><span data-ar="آخر تحديث:" data-en="Last Updated:">آخر تحديث:</span> <strong id="info-updated">--</strong></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Fund Modal -->
    <div id="fundModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid var(--border-light);">
                <h2 style="color: var(--accent); font-size: 18px; font-weight: 600;"><i class="fas fa-plus-circle"></i> <span data-ar="إضافة صندوق جديد" data-en="Add New Fund">إضافة صندوق جديد</span></h2>
                <button onclick="closeFundModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            <div class="form-group">
                <label data-ar="اسم الصندوق" data-en="Fund Name">اسم الصندوق</label>
                <input type="text" id="fund-name" placeholder="">
            </div>
            <div class="form-group">
                <label data-ar="كود الصندوق" data-en="Fund Code">كود الصندوق</label>
                <input type="text" id="fund-code" placeholder="">
            </div>
            <div class="form-group">
                <label data-ar="السعر الحالي" data-en="Current Price">السعر الحالي</label>
                <input type="number" id="fund-price" placeholder="0" step="any">
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label data-ar="رسوم الاكتتاب %" data-en="Subscription Fee %">رسوم الاكتتاب %</label>
                    <input type="number" id="fund-sub-fee" placeholder="0" step="any" value="0">
                </div>
                <div class="form-group">
                    <label data-ar="رسوم الاسترداد %" data-en="Redemption Fee %">رسوم الاسترداد %</label>
                    <input type="number" id="fund-red-fee" placeholder="0" step="any" value="0">
                </div>
            </div>
            <div class="btn-group">
                <button class="btn" onclick="addFund()">
                    <i class="fas fa-check"></i> <span data-ar="إضافة" data-en="Add">إضافة</span>
                </button>
                <button class="btn danger" onclick="closeFundModal()">
                    <i class="fas fa-times"></i> <span data-ar="إلغاء" data-en="Cancel">إلغاء</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>

    <script>
        // ============ STATE ============
        let funds = [];
        let currentFundId = null;
        let lang = localStorage.getItem('app_lang') || 'ar';
        let theme = localStorage.getItem('app_theme') || 'light';
        let chartInstances = {};

        // Language labels
        const labels = {
            ar: {
                buy: 'شراء',
                sell: 'بيع',
                selectFund: 'اختر صندوق',
                noData: 'لا توجد بيانات'
            },
            en: {
                buy: 'Buy',
                sell: 'Sell',
                selectFund: 'Select a fund',
                noData: 'No data'
            }
        };

        // ============ INIT ============
        function init() {
            loadData();
            applyTheme(theme);
            applyLang(lang);
            setToday();
            renderAll();
            Chart.defaults.font.family = "'Cairo', sans-serif";
            Chart.defaults.color = theme === 'dark' ? '#e0e0e0' : '#666';
        }

        function setToday() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tx-date').value = today;
            document.getElementById('price-date').value = today;
            const dateStr = new Date(today).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US');
            document.getElementById('today-date').textContent = dateStr;
        }

        // ============ TRANSLATIONS ============
        function updateTranslations() {
            document.querySelectorAll('[data-ar][data-en]').forEach(el => {
                const text = lang === 'ar' ? el.getAttribute('data-ar') : el.getAttribute('data-en');
                if (el.tagName === 'INPUT' || el.tagName === 'OPTION') {
                    el.placeholder = text;
                } else if (!el.querySelector('i')) {
                    el.textContent = text;
                }
            });
        }

        // ============ THEME ============
        function applyTheme(newTheme) {
            theme = newTheme;
            document.body.setAttribute('data-theme', theme);
            document.getElementById('theme-icon').className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            localStorage.setItem('app_theme', theme);
            Chart.defaults.color = theme === 'dark' ? '#e0e0e0' : '#666';
            updateAllCharts();
        }

        function toggleTheme() {
            applyTheme(theme === 'light' ? 'dark' : 'light');
        }

        // ============ LANGUAGE ============
        function applyLang(newLang) {
            lang = newLang;
            document.body.setAttribute('data-lang', lang);
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            localStorage.setItem('app_lang', lang);
            updateTranslations();
            setToday();
            renderAll();
        }

        function toggleLanguage() {
            applyLang(lang === 'ar' ? 'en' : 'ar');
        }

        // ============ NAVIGATION ============
        function switchTab(tabName) {
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');
            
            if (tabName === 'analytics') {
                setTimeout(() => updateAllCharts(), 100);
            }
        }

        // ============ FUNDS ============
        function showAddFundModal() {
            document.getElementById('fundModal').classList.add('active');
        }

        function closeFundModal() {
            document.getElementById('fundModal').classList.remove('active');
            document.getElementById('fund-name').value = '';
            document.getElementById('fund-code').value = '';
            document.getElementById('fund-price').value = '';
            document.getElementById('fund-sub-fee').value = '0';
            document.getElementById('fund-red-fee').value = '0';
        }

        function addFund() {
            const name = document.getElementById('fund-name').value.trim();
            const code = document.getElementById('fund-code').value.trim().toUpperCase();
            const price = parseFloat(document.getElementById('fund-price').value);
            const subFee = parseFloat(document.getElementById('fund-sub-fee').value) || 0;
            const redFee = parseFloat(document.getElementById('fund-red-fee').value) || 0;

            if (!name || !code || !price) {
                alert(lang === 'ar' ? 'الرجاء ملء البيانات الصحيحة' : 'Please fill in correct data');
                return;
            }

            const fund = {
                id: Date.now().toString(),
                name, code, price,
                subscriptionFee: subFee,
                redemptionFee: redFee,
                transactions: [],
                priceHistory: [{ date: new Date().toISOString().split('T')[0], price }]
            };

            funds.push(fund);
            currentFundId = fund.id;
            saveData();
            renderAll();
            closeFundModal();
        }

        function deleteFund(id) {
            if (funds.length === 1) {
                alert(lang === 'ar' ? 'لا يمكن حذف الصندوق الوحيد' : 'Cannot delete only fund');
                return;
            }
            if (!confirm(lang === 'ar' ? 'هل تريد حذف الصندوق؟' : 'Delete this fund?')) return;

            funds = funds.filter(f => f.id !== id);
            if (currentFundId === id) currentFundId = funds[0]?.id;
            saveData();
            renderAll();
        }

        function renderFundSelector() {
            const select = document.getElementById('fund-select');
            select.innerHTML = '';
            funds.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.id;
                opt.textContent = `${f.name} (${f.code})`;
                select.appendChild(opt);
            });
            if (currentFundId) select.value = currentFundId;
            select.addEventListener('change', (e) => {
                currentFundId = e.target.value;
                updateFundDisplay();
                updatePortfolio();
                renderTransactionsTable();
                saveData();
            });
            updateFundDisplay();
        }

        function updateFundDisplay() {
            const fund = getCurrentFund();
            document.getElementById('current-fund-display').textContent = fund ? `${fund.name} (${fund.code})` : labels[lang].selectFund;
            document.getElementById('price-fund-name').value = fund ? fund.name : '';
        }

        function renderFundsTable() {
            const tbody = document.getElementById('funds-table');
            tbody.innerHTML = '';
            funds.forEach(f => {
                const tr = document.createElement('tr');
                const fees = `${f.subscriptionFee || 0}% / ${f.redemptionFee || 0}%`;
                tr.innerHTML = `
                    <td>${f.name}</td>
                    <td>${f.code}</td>
                    <td>${formatDisplay(f.price, 'price')}</td>
                    <td>${fees}</td>
                    <td><button class="btn danger" onclick="deleteFund('${f.id}')" style="padding: 4px 8px; font-size: 11px;"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============ TRANSACTIONS ============
        function addTransaction() {
            const fund = getCurrentFund();
            if (!fund) {
                alert(lang === 'ar' ? 'اختر صندوق أولاً' : 'Select a fund first');
                return;
            }

            const date = document.getElementById('tx-date').value;
            const type = document.getElementById('tx-type').value;
            const units = parseFloat(document.getElementById('tx-units').value);
            const price = parseFloat(document.getElementById('tx-price').value);

            if (!date || !units || !price) {
                alert(lang === 'ar' ? 'الرجاء ملء البيانات الصحيحة' : 'Please fill in correct data');
                return;
            }

            fund.transactions.push({ date, type, units, price });
            clearTxForm();
            saveData();
            renderAll();
        }

        function deleteTransaction(fundId, idx) {
            const fund = funds.find(f => f.id === fundId);
            if (confirm(lang === 'ar' ? 'هل تريد حذف المعاملة؟' : 'Delete this transaction?')) {
                fund.transactions.splice(idx, 1);
                saveData();
                renderAll();
            }
        }

        function clearTxForm() {
            document.getElementById('tx-units').value = '';
            document.getElementById('tx-price').value = '';
            setToday();
        }

        function renderTransactionsTable() {
            const fund = getCurrentFund();
            const tbody = document.getElementById('transactions-table');
            tbody.innerHTML = '';
            
            if (!fund) return;

            fund.transactions.forEach((tx, idx) => {
                const amount = tx.units * tx.price;
                const fee = tx.type === 'buy' ? amount * (fund.subscriptionFee / 100) : amount * (fund.redemptionFee / 100);
                const net = amount - fee;
                
                const tr = document.createElement('tr');
                const typeText = tx.type === 'buy' ? labels[lang].buy : labels[lang].sell;
                const dateStr = new Date(tx.date).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US');
                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td><span style="background: ${tx.type === 'buy' ? '#10b981' : '#ef4444'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${typeText}</span></td>
                    <td>${formatDisplay(tx.units, 'default')}</td>
                    <td>${formatDisplay(tx.price, 'price')}</td>
                    <td>${formatDisplay(amount, 'default')}</td>
                    <td>${formatDisplay(fee, 'default')}</td>
                    <td>${formatDisplay(net, 'default')}</td>
                    <td><button class="btn danger" onclick="deleteTransaction('${fund.id}', ${idx})" style="padding: 4px 8px; font-size: 11px;"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============ CALCULATIONS ============
        function calculateMetrics(fund) {
            let units = 0, invested = 0, buyUnits = 0, buyAmount = 0;

            fund.transactions.forEach(tx => {
                const amount = tx.units * tx.price;
                const fee = tx.type === 'buy' ? amount * (fund.subscriptionFee / 100) : amount * (fund.redemptionFee / 100);
                const net = amount - fee;

                if (tx.type === 'buy') {
                    units += tx.units;
                    invested += net;
                    buyUnits += tx.units;
                    buyAmount += net;
                } else {
                    units -= tx.units;
                    invested -= net;
                }
            });

            const avgPrice = buyUnits > 0 ? buyAmount / buyUnits : 0;
            const value = units * (fund.price || 0);
            const profit = value - invested;
            const returnPct = invested > 0 ? (profit / invested) * 100 : 0;

            return { units, avgPrice, value, invested, profit, returnPct };
        }

        function updatePortfolio() {
            const fund = getCurrentFund();
            if (!fund) return;

            const m = calculateMetrics(fund);

            document.getElementById('total-units').textContent = formatDisplay(m.units, 'default');
            document.getElementById('avg-price').textContent = formatDisplay(m.avgPrice, 'price');
            document.getElementById('current-price').textContent = formatDisplay(fund.price || 0, 'price');
            document.getElementById('current-value').textContent = formatDisplay(m.value, 'default');
            document.getElementById('total-invested').textContent = formatDisplay(m.invested, 'default');
            document.getElementById('net-profit').textContent = formatDisplay(m.profit, 'default');
            document.getElementById('return-pct').textContent = formatDisplay(m.returnPct, 'default') + '%';

            const profitEl = document.getElementById('net-profit');
            profitEl.style.color = m.profit >= 0 ? 'var(--success)' : 'var(--danger)';
            
            const returnEl = document.getElementById('return-pct');
            returnEl.style.color = m.returnPct >= 0 ? 'var(--success)' : 'var(--danger)';

            const valueBox = document.getElementById('value-box');
            if (m.profit >= 0) {
                valueBox.style.background = 'linear-gradient(135deg, var(--success) 0%, #059669 100%)';
            } else {
                valueBox.style.background = 'linear-gradient(135deg, var(--danger) 0%, #dc2626 100%)';
            }

            updateRecommendation(m, fund);
            renderPriceHistory();
            updatePricesCount();
            updateLastUpdate();
        }

        function updateLastUpdate() {
            const fund = getCurrentFund();
            if (!fund?.priceHistory?.length) {
                document.getElementById('last-update').textContent = '--';
                return;
            }
            const latest = fund.priceHistory[fund.priceHistory.length - 1];
            const dateStr = new Date(latest.date).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US');
            document.getElementById('last-update').textContent = dateStr;
        }

        function updatePricesCount() {
            const fund = getCurrentFund();
            const count = fund?.priceHistory?.length || 0;
            document.getElementById('prices-count').textContent = count;
        }

        // ============ RECOMMENDATION ENGINE ============
        function evaluateRecommendation(fund) {
            const m = calculateMetrics(fund);
            
            // Simple logic based on buy price vs current price
            if (m.avgPrice === 0 || m.units === 0) {
                return {
                    action: 'Hold',
                    actionAr: 'ابدأ الاستثمار',
                    confidence: 0,
                    explanation: lang === 'ar' ? 'لا توجد معاملات' : 'No transactions'
                };
            }

            const currentPrice = fund.price || m.avgPrice;
            const profitPct = ((currentPrice - m.avgPrice) / m.avgPrice) * 100;
            
            let action = 'Hold';
            let actionAr = 'راقب واحتفظ';
            let confidence = 60;
            let explanation = '';

            // Simple recommendation logic
            if (profitPct > 15) {
                // Strong profit - consider taking some
                action = 'PartialSell';
                actionAr = 'بيع جزئي';
                confidence = 75;
                explanation = lang === 'ar' 
                    ? `أرباح قوية (${formatDisplay(profitPct, 'default')}%) - قد تفكر في بيع جزء`
                    : `Strong profit (${formatDisplay(profitPct, 'default')}%) - consider selling some`;
            } else if (profitPct > 5) {
                // Good profit - hold and watch
                action = 'Hold';
                actionAr = 'احتفظ وراقب';
                confidence = 70;
                explanation = lang === 'ar'
                    ? `ربح جيد (${formatDisplay(profitPct, 'default')}%) - الحفاظ مفيد`
                    : `Good profit (${formatDisplay(profitPct, 'default')}%) - holding is good`;
            } else if (profitPct > -5) {
                // Near breakeven - hold steady
                action = 'Hold';
                actionAr = 'استقرار';
                confidence = 50;
                explanation = lang === 'ar'
                    ? `وضع مستقر (${formatDisplay(profitPct, 'default')}%) - الانتظار أفضل`
                    : `Stable (${formatDisplay(profitPct, 'default')}%) - waiting is best`;
            } else if (profitPct > -15) {
                // Moderate loss - average down if able
                action = 'BuyMore';
                actionAr = 'متوسط التكلفة';
                confidence = 65;
                explanation = lang === 'ar'
                    ? `خسارة طفيفة (${formatDisplay(profitPct, 'default')}%) - يمكن شراء المزيد`
                    : `Slight loss (${formatDisplay(profitPct, 'default')}%) - can buy more`;
            } else {
                // Heavy loss - reconsider or average down with caution
                action = 'BuyMore';
                actionAr = 'إعادة تقييم';
                confidence = 50;
                explanation = lang === 'ar'
                    ? `خسارة كبيرة (${formatDisplay(profitPct, 'default')}%) - أعد التفكير`
                    : `Heavy loss (${formatDisplay(profitPct, 'default')}%) - reconsider`;
            }

            return {
                action,
                actionAr,
                confidence,
                explanation,
                profitPct
            };
        }

        function updateRecommendation(m, fund) {
            const eval_data = evaluateRecommendation(fund);
            const rec = document.getElementById('recommendation-box');
            const recText = document.getElementById('recommendation-text');
            const recExpl = document.getElementById('recommendation-explanation');
            const recConf = document.getElementById('recommendation-confidence');

            recText.textContent = eval_data.actionAr;
            recExpl.textContent = eval_data.explanation;
            recConf.textContent = `${lang === 'ar' ? 'الثقة' : 'Confidence'}: ${Math.round(eval_data.confidence)}%`;
            
            const colors = {
                'متوسط التكلفة': '#10b981',
                'بيع جزئي': '#f59e0b',
                'استقرار': '#689B8A',
                'احتفظ وراقب': '#689B8A',
                'راقب واحتفظ': '#689B8A',
                'ابدأ الاستثمار': '#3b82f6',
                'إعادة تقييم': '#ef4444'
            };
            
            const bgColor = colors[eval_data.actionAr] || '#689B8A';
            rec.style.background = bgColor;
            rec.style.borderLeft = `4px solid ${bgColor}`;
        }

        function renderPriceHistory() {
            const fund = getCurrentFund();
            const tbody = document.getElementById('price-history-table');
            tbody.innerHTML = '';

            if (!fund?.priceHistory) return;

            const sorted = [...fund.priceHistory].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 30);
            
            sorted.forEach((entry, idx) => {
                const prev = idx < sorted.length - 1 ? sorted[idx + 1].price : entry.price;
                const change = ((entry.price - prev) / prev) * 100;
                const statusIcon = change > 0.1 ? 'fa-arrow-up' : change < -0.1 ? 'fa-arrow-down' : 'fa-minus';
                const statusText = change > 0.1 ? lang === 'ar' ? 'ارتفاع' : 'Up' : change < -0.1 ? lang === 'ar' ? 'انخفاض' : 'Down' : lang === 'ar' ? 'مستقر' : 'Stable';

                const tr = document.createElement('tr');
                const dateStr = new Date(entry.date).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US');
                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${formatDisplay(entry.price, 'price')}</td>
                    <td style="color: ${change >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight: 600;">${change >= 0 ? '+' : ''}${formatDisplay(change, 'default')}%</td>
                    <td><i class="fas ${statusIcon}"></i> ${statusText}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============ PRICE MANAGEMENT ============
        function updatePrice() {
            const fund = getCurrentFund();
            if (!fund) {
                alert(lang === 'ar' ? 'اختر صندوق أولاً' : 'Select a fund first');
                return;
            }

            const price = parseFloat(document.getElementById('price-new').value);
            const date = document.getElementById('price-date').value;

            if (!price || !date) {
                alert(lang === 'ar' ? 'الرجاء ملء البيانات الصحيحة' : 'Please fill in correct data');
                return;
            }

            fund.price = price;
            const existing = fund.priceHistory.find(p => p.date === date);
            if (existing) {
                existing.price = price;
            } else {
                fund.priceHistory.push({ date, price });
            }

            saveData();
            renderAll();
            document.getElementById('price-new').value = '';
        }

        // ============ EXPORT PRICES ============
        function exportPricesPDF() {
            const fund = getCurrentFund();
            if (!fund) {
                alert(lang === 'ar' ? 'اختر صندوق أولاً' : 'Select a fund first');
                return;
            }

            const sorted = [...fund.priceHistory].sort((a, b) => new Date(a.date) - new Date(b.date));
            const prices = sorted.map(p => ({ date: p.date, price: p.price }));

            let html = `
<!DOCTYPE html>
<html dir="${lang === 'ar' ? 'rtl' : 'ltr'}">
<head>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; direction: ${lang === 'ar' ? 'rtl' : 'ltr'}; }
        .container { max-width: 800px; margin: 40px auto; }
        .header { text-align: center; border-bottom: 3px solid #689B8A; padding-bottom: 20px; margin-bottom: 30px; }
        .header h1 { color: #280A3E; margin: 0; }
        .chart { width: 100%; height: 400px; margin: 30px 0; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 10px; text-align: ${lang === 'ar' ? 'right' : 'left'}; border: 1px solid #ddd; }
        th { background: #689B8A; color: white; }
        .footer { text-align: center; margin-top: 40px; color: #999; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>${lang === 'ar' ? 'تقرير الأسعار' : 'Price Report'}</h1>
            <p>${fund.name} (${fund.code})</p>
        </div>
        
        <canvas id="priceChartPDF" class="chart"></canvas>
        
        <table>
            <thead>
                <tr>
                    <th>${lang === 'ar' ? 'التاريخ' : 'Date'}</th>
                    <th>${lang === 'ar' ? 'السعر' : 'Price'}</th>
                </tr>
            </thead>
            <tbody>
                ${prices.map(p => `<tr><td>${p.date}</td><td>${formatDisplay(p.price)}</td></tr>`).join('')}
            </tbody>
        </table>
        
        <div class="footer">
            <p>${new Date().toLocaleString(lang === 'ar' ? 'ar-EG' : 'en-US')}</p>
        </div>
    </div>
</body>
</html>
            `;

            const element = document.createElement('div');
            element.innerHTML = html;
            const opt = {
                margin: 10,
                filename: `prices-${fund.code}-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, backgroundColor: '#fff' },
                jsPDF: { orientation: 'p', unit: 'mm', format: 'a4' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function exportPricesExcel() {
            const fund = getCurrentFund();
            if (!fund) {
                alert(lang === 'ar' ? 'اختر صندوق أولاً' : 'Select a fund first');
                return;
            }

            const data = fund.priceHistory.map(p => ({
                [lang === 'ar' ? 'التاريخ' : 'Date']: p.date,
                [lang === 'ar' ? 'السعر' : 'Price']: p.price
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, lang === 'ar' ? 'الأسعار' : 'Prices');
            XLSX.writeFile(wb, `prices-${fund.code}-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // ============ CHARTS ============
        function destroyChart(chartId) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
                delete chartInstances[chartId];
            }
        }

        function createPriceChart() {
            const fund = getCurrentFund();
            if (!fund || !fund.priceHistory) return;

            destroyChart('priceChart');
            const sorted = [...fund.priceHistory].sort((a, b) => new Date(a.date) - new Date(b.date));
            const ctx = document.getElementById('priceChart');
            if (!ctx) return;

            chartInstances['priceChart'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map((p, i) => i % 2 === 0 ? new Date(p.date).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US') : ''),
                    datasets: [{
                        label: fund.name,
                        data: sorted.map(p => parseFloat(p.price)),
                        borderColor: '#689B8A',
                        backgroundColor: 'rgba(104, 155, 138, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#F9CB99',
                        pointBorderColor: '#689B8A',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: theme === 'dark' ? '#e0e0e0' : '#333', font: { size: 13 } } } },
                    scales: { y: { beginAtZero: false }, x: { grid: { display: false } } }
                }
            });
        }

        function createPortfolioChart() {
            destroyChart('portfolioChart');
            const colorPalette = ['#689B8A', '#F9CB99', '#f59e0b', '#3b82f6', '#ef4444'];
            
            const data = funds.map(f => {
                const m = calculateMetrics(f);
                return m.value;
            });

            const ctx = document.getElementById('portfolioChart');
            if (!ctx) return;

            chartInstances['portfolioChart'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: funds.map(f => f.code),
                    datasets: [{
                        data: data,
                        backgroundColor: colorPalette,
                        borderColor: theme === 'dark' ? '#2a1f35' : 'white',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: theme === 'dark' ? '#e0e0e0' : '#333', font: { size: 12 } } } }
                }
            });
        }

        function createMonthlyChart() {
            destroyChart('monthlyChart');
            const monthlyData = {};

            funds.forEach(fund => {
                fund.transactions.forEach(tx => {
                    const date = new Date(tx.date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyData[monthKey]) monthlyData[monthKey] = 0;
                    const amount = tx.units * tx.price;
                    monthlyData[monthKey] += amount;
                });
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const ctx = document.getElementById('monthlyChart');
            if (!ctx) return;

            chartInstances['monthlyChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: lang === 'ar' ? 'المعاملات الشهرية' : 'Monthly Transactions',
                        data: sortedMonths.map(m => monthlyData[m]),
                        backgroundColor: '#689B8A',
                        borderColor: '#280A3E',
                        borderWidth: 2
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function createReturnChart() {
            destroyChart('returnChart');
            const fundReturns = funds.map(fund => {
                const m = calculateMetrics(fund);
                return m.returnPct;
            });

            const ctx = document.getElementById('returnChart');
            if (!ctx) return;

            chartInstances['returnChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: funds.map(f => f.code),
                    datasets: [{
                        label: lang === 'ar' ? 'العائد %' : 'Return %',
                        data: fundReturns,
                        backgroundColor: fundReturns.map(r => r >= 0 ? '#10b981' : '#ef4444'),
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function updateStatistics() {
            const totalTx = funds.reduce((sum, f) => sum + f.transactions.length, 0);
            let best = { code: '--', value: -999 };
            let worst = { code: '--', value: 999 };

            funds.forEach(f => {
                const m = calculateMetrics(f);
                if (m.returnPct > best.value) best = { code: f.code, value: m.returnPct };
                if (m.returnPct < worst.value) worst = { code: f.code, value: m.returnPct };
            });

            document.getElementById('stats-funds').textContent = funds.length;
            document.getElementById('stats-transactions').textContent = totalTx;
            document.getElementById('stats-best').textContent = best.value === -999 ? '--' : `${best.code} (${formatDisplay(best.value, 'default')}%)`;
            document.getElementById('stats-worst').textContent = worst.value === 999 ? '--' : `${worst.code} (${formatDisplay(worst.value, 'default')}%)`;
        }

        function updateAllCharts() {
            createPriceChart();
            createPortfolioChart();
            createMonthlyChart();
            createReturnChart();
            updateStatistics();
        }

        // ============ EXPORT/IMPORT ============
        function formatDisplay(num, type = 'default') {
            if (num === null || num === undefined) return '0';
            
            // For prices and historical data: no rounding
            if (type === 'price') {
                return parseFloat(num).toString();
            }
            
            // For other numbers: round to 2 decimals
            return parseFloat(num).toFixed(2);
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportJSON() {
            const data = { funds, timestamp: new Date().toISOString() };
            downloadFile(JSON.stringify(data, null, 2), `investment-backup-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
        }

        function exportCSV() {
            let csv = lang === 'ar' ? 'الصندوق,الكود,التاريخ,النوع,الوثائق,السعر,المبلغ,الرسوم\n' : 'Fund,Code,Date,Type,Units,Price,Amount,Fees\n';
            funds.forEach(f => {
                f.transactions.forEach(tx => {
                    const amount = tx.units * tx.price;
                    const fee = tx.type === 'buy' ? amount * (f.subscriptionFee / 100) : amount * (f.redemptionFee / 100);
                    csv += `"${f.name}","${f.code}","${tx.date}","${tx.type === 'buy' ? labels[lang].buy : labels[lang].sell}",${tx.units},${tx.price},${amount},${fee}\n`;
                });
            });
            downloadFile(csv, `investment-backup-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        }

        function exportExcel() {
            const data = [];
            funds.forEach(f => {
                f.transactions.forEach(tx => {
                    const amount = tx.units * tx.price;
                    const fee = tx.type === 'buy' ? amount * (f.subscriptionFee / 100) : amount * (f.redemptionFee / 100);
                    data.push({
                        [lang === 'ar' ? 'الصندوق' : 'Fund']: f.name,
                        [lang === 'ar' ? 'الكود' : 'Code']: f.code,
                        [lang === 'ar' ? 'التاريخ' : 'Date']: tx.date,
                        [lang === 'ar' ? 'النوع' : 'Type']: tx.type === 'buy' ? labels[lang].buy : labels[lang].sell,
                        [lang === 'ar' ? 'الوثائق' : 'Units']: tx.units,
                        [lang === 'ar' ? 'السعر' : 'Price']: tx.price,
                        [lang === 'ar' ? 'المبلغ' : 'Amount']: amount,
                        [lang === 'ar' ? 'الرسوم' : 'Fees']: fee
                    });
                });
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, lang === 'ar' ? 'الاستثمارات' : 'Investments');
            XLSX.writeFile(wb, `investment-backup-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportPDF() {
            const fund = getCurrentFund();
            if (!fund) {
                alert(lang === 'ar' ? 'اختر صندوق أولاً' : 'Select a fund first');
                return;
            }

            const m = calculateMetrics(fund);
            const html = `
<!DOCTYPE html>
<html lang="${lang}">
<head>
    <meta charset="UTF-8">
    <title>${lang === 'ar' ? 'تقرير الاستثمار' : 'Investment Report'}</title>
    <style>
        body { font-family: Arial, sans-serif; direction: ${lang === 'ar' ? 'rtl' : 'ltr'}; }
        .container { max-width: 800px; margin: 40px auto; }
        .header { text-align: center; border-bottom: 3px solid #689B8A; padding-bottom: 20px; margin-bottom: 30px; }
        .header h1 { color: #280A3E; margin: 0; }
        .header p { color: #689B8A; margin: 5px 0; }
        .metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .metric { background: #f5f5f5; padding: 15px; border-radius: 8px; text-align: center; }
        .metric-label { font-size: 12px; color: #666; }
        .metric-value { font-size: 24px; font-weight: bold; color: #689B8A; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th { background: #689B8A; color: white; padding: 12px; text-align: ${lang === 'ar' ? 'right' : 'left'}; }
        td { padding: 10px; border-bottom: 1px solid #ddd; text-align: ${lang === 'ar' ? 'right' : 'left'}; }
        .section-title { font-size: 16px; font-weight: bold; color: #280A3E; margin-top: 30px; margin-bottom: 10px; }
        .footer { text-align: center; margin-top: 40px; color: #999; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>${lang === 'ar' ? 'تقرير الاستثمار' : 'Investment Report'}</h1>
            <p>${fund.name} (${fund.code})</p>
        </div>

        <div class="metrics">
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'إجمالي الوثائق' : 'Total Units'}</div>
                <div class="metric-value">${formatDisplay(m.units)}</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'متوسط الشراء' : 'Avg Buy'}</div>
                <div class="metric-value">${formatDisplay(m.avgPrice)}</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'السعر الحالي' : 'Current Price'}</div>
                <div class="metric-value">${formatDisplay(fund.price)}</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'القيمة الحالية' : 'Current Value'}</div>
                <div class="metric-value">${formatDisplay(m.value)}</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'إجمالي الاستثمار' : 'Total Invested'}</div>
                <div class="metric-value">${formatDisplay(m.invested)}</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'الربح/الخسارة' : 'Profit/Loss'}</div>
                <div class="metric-value" style="color: ${m.profit >= 0 ? '#10b981' : '#ef4444'};">${formatDisplay(m.profit)}</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'العائد %' : 'Return %'}</div>
                <div class="metric-value" style="color: ${m.returnPct >= 0 ? '#10b981' : '#ef4444'};">${formatDisplay(m.returnPct)}%</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'تاريخ الإنشاء' : 'Export Date'}</div>
                <div class="metric-value">${new Date().toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US')}</div>
            </div>
        </div>

        <div class="section-title">${lang === 'ar' ? 'المعاملات' : 'Transactions'}</div>
        <table>
            <thead>
                <tr>
                    <th>${lang === 'ar' ? 'التاريخ' : 'Date'}</th>
                    <th>${lang === 'ar' ? 'النوع' : 'Type'}</th>
                    <th>${lang === 'ar' ? 'الوثائق' : 'Units'}</th>
                    <th>${lang === 'ar' ? 'السعر' : 'Price'}</th>
                    <th>${lang === 'ar' ? 'المبلغ' : 'Amount'}</th>
                </tr>
            </thead>
            <tbody>
                ${fund.transactions.map(tx => {
                    const amount = tx.units * tx.price;
                    return `<tr>
                        <td>${tx.date}</td>
                        <td>${tx.type === 'buy' ? labels[lang].buy : labels[lang].sell}</td>
                        <td>${formatDisplay(tx.units)}</td>
                        <td>${formatDisplay(tx.price)}</td>
                        <td>${formatDisplay(amount)}</td>
                    </tr>`;
                }).join('')}
            </tbody>
        </table>

        <div class="footer">
            <p>${lang === 'ar' ? 'تم إنشاء هذا التقرير بواسطة نظام تتبع الاستثمارات' : 'Generated by Investment Tracker'}</p>
            <p>${new Date().toLocaleString(lang === 'ar' ? 'ar-EG' : 'en-US')}</p>
        </div>
    </div>
</body>
</html>
            `;

            const element = document.createElement('div');
            element.innerHTML = html;
            const opt = {
                margin: 10,
                filename: `investment-report-${fund.code}-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, backgroundColor: '#fff' },
                jsPDF: { orientation: 'p', unit: 'mm', format: 'a4' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function importFile() {
            const file = document.getElementById('import-file').files[0];
            if (!file) {
                alert(lang === 'ar' ? 'اختر ملف أولاً' : 'Choose a file first');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    funds = data.funds || [];
                    currentFundId = funds[0]?.id;
                    saveData();
                    renderAll();
                    alert(lang === 'ar' ? 'تم الاستيراد بنجاح' : 'Imported successfully');
                } catch (err) {
                    alert(lang === 'ar' ? 'خطأ في الملف' : 'File error');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (!confirm(lang === 'ar' ? 'هل تريد حذف جميع البيانات؟' : 'Delete all data?')) return;
            funds = [];
            currentFundId = null;
            saveData();
            renderAll();
        }

        // ============ DATA ============
        function saveData() {
            localStorage.setItem('investment_app', JSON.stringify({ funds, currentFundId }));
        }

        function loadData() {
            const data = JSON.parse(localStorage.getItem('investment_app') || '{"funds":[],"currentFundId":null}');
            funds = data.funds || [];
            currentFundId = data.currentFundId || funds[0]?.id;
            
            if (funds.length === 0) {
                funds = [{
                    id: '1',
                    name: lang === 'ar' ? 'صندوق عزيموت' : 'Azimut Fund',
                    code: 'AZM',
                    price: 1.42,
                    subscriptionFee: 1,
                    redemptionFee: 2,
                    transactions: [{ date: '2025-11-01', type: 'buy', units: 100, price: 1.35 }],
                    priceHistory: [
                        { date: '2025-10-31', price: 1.35 },
                        { date: '2025-11-02', price: 1.37 },
                        { date: '2025-11-04', price: 1.38 },
                        { date: '2025-11-06', price: 1.3533 },
                        { date: '2025-11-08', price: 1.454545 },
                        { date: '2025-11-10', price: 1.41 },
                        { date: '2025-11-12', price: 1.40 },
                        { date: '2025-11-14', price: 1.43 },
                        { date: '2025-11-16', price: 1.43 },
                        { date: '2025-11-18', price: 1.45 },
                        { date: '2025-11-20', price: 1.44 },
                        { date: '2025-11-22', price: 1.44 },
                        { date: '2025-11-24', price: 1.44 },
                        { date: '2025-11-26', price: 1.41 },
                        { date: '2025-11-28', price: 1.42 }
                    ]
                }];
                currentFundId = '1';
            }
        }

        // ============ HELPERS ============
        function getCurrentFund() {
            return funds.find(f => f.id === currentFundId);
        }

        function renderAll() {
            renderFundSelector();
            updatePortfolio();
            renderTransactionsTable();
            renderFundsTable();
            updateBackupInfo();
            updateTranslations();
        }

        function updateBackupInfo() {
            let totalTx = 0;
            funds.forEach(f => totalTx += f.transactions.length);
            document.getElementById('info-funds').textContent = funds.length;
            document.getElementById('info-transactions').textContent = totalTx;
            document.getElementById('info-updated').textContent = new Date().toLocaleString(lang === 'ar' ? 'ar-EG' : 'en-US');
        }

        // ============ START ============
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>