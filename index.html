<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InDar Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* الألوان الجديدة المطلوبة */
            --color-primary-900: #022C43; /* الأزرق الداكن جداً */
            --color-primary-700: #064566; /* الأزرق المتوسط */
            --color-primary-500: #053F5E; /* Secondary */
            --color-primary-300: #115173; /* Tertiary */
            --color-accent-400: #FFD700; /* الذهبي */
            --color-accent-600: #D4B200; /* الذهبي الداكن */
            --color-accent-300: #FFE866; /* الذهبي الفاتح */
            --color-accent-200: #FFF4B3; /* الذهبي الفاتح جداً */
            
            /* نظام الألوان المحدث */
            --primary: var(--color-primary-900);
            --primary-light: var(--color-primary-700);
            --primary-dark: #011C2E;
            --accent: var(--color-accent-400);
            --secondary: #053F5E;
            --secondary-light: #0A5A85;
            --secondary-dark: #032B40;
            --tertiary: #115173;
            --tertiary-light: #1A6D99;
            --tertiary-dark: #0C3A54;
            --background: #F8FAFC;
            --surface: #FFFFFF;
            --on-background: #022C43;
            --on-surface: #064566;
            --border: #E1E8F0;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #fd7e14;
            --info: #17a2b8;
            --chart-line: #008cff;
            --chart-area: rgba(2, 44, 67, 0.1);
            --chart-point: #022C43;
            --chart-grid: rgba(2, 44, 67, 0.1);
        }

        /* Dark Mode */
        body[data-theme="dark"] {
            --primary: #1a8ec9;
            --primary-light: #0A5A85;
            --primary-dark: #022C43;
            --accent: #FFE866;
            --secondary: #115173;
            --secondary-light: #1A6D99;
            --secondary-dark: #053F5E;
            --tertiary: #1A6D99;
            --background: #0A1929;
            --surface: #112240;
            --on-background: #E6F1FF;
            --on-surface: #CCD6F6;
            --border: #233554;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #fd7e14;
            --info: #17a2b8;
            --chart-line: #64FFDA;
            --chart-area: rgba(100, 255, 218, 0.1);
            --chart-point: #FFD700;
            --chart-grid: rgba(100, 255, 218, 0.1);
        }

        html {
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            scroll-behavior: smooth;
        }

        body {
            background: var(--background);
            color: var(--on-background);
            transition: all 0.4s ease;
            line-height: 1.6;
            font-family: 'Cairo', sans-serif;
        }

        /* Sidebar Navigation - Icons Only */
        .sidebar {
            width: 70px;
            background: var(--surface);
            box-shadow: 2px 0 8px rgba(2, 44, 67, 0.1);
            position: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 0;
            z-index: 200;
            right: 0;
        }

        body[data-theme="dark"] .sidebar {
            background: var(--surface);
            box-shadow: 2px 0 8px rgba(0,0,0,0.3);
        }

        .nav-logo {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            font-size: 24px;
        }

        .nav-item {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 10px;
            margin: 6px 0;
            transition: all 0.3s ease;
            font-size: 20px;
            color: var(--on-surface);
            position: relative;
        }

        .nav-item:hover {
            background: var(--primary-light);
            color: white;
            transform: scale(1.1);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(2, 44, 67, 0.3);
        }

        .nav-separator {
            width: 30px;
            height: 1px;
            background: var(--border);
            margin: 10px 0;
        }

        .main-content {
            margin-right: 70px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--surface);
            border-bottom: 3px solid var(--primary);
            padding: 13px 13px;
            box-shadow: 0 2px 8px rgba(2, 44, 67, 0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-left h1 {
            font-size: 24px;
            color: var(--primary);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-left p {
            font-size: 13px;
            color: var(--primary);
            margin-top: 4px;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .fund-selector {
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-family: 'Cairo', sans-serif;
            font-size: 13px;
            min-width: 200px;
            background: var(--surface);
            color: var(--on-surface);
            cursor: pointer;
            padding: 1px;
        }

        /* Content Area */
        .content-wrapper {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card */
        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(2, 44, 67, 0.08);
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Grid */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        @media (max-width: 1024px) {
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
            .grid-3 { grid-template-columns: repeat(2, 1fr); }
            .grid-2 { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .sidebar { width: 60px; }
            .nav-item { width: 45px; height: 45px; font-size: 18px; }
            .nav-logo { width: 45px; height: 45px; font-size: 20px; }
            .main-content { margin-right: 60px; }
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .content-wrapper { padding: 12px; }
            .header { padding: 12px 16px; }
            .header-left h1 { font-size: 18px; }
            .header-left p { font-size: 12px; }
            .fund-selector { min-width: 120px; font-size: 11px; }
            .card { padding: 14px; margin-bottom: 12px; }
            .card-title { font-size: 14px; }
        }

        /* Metric Box */
        .metric-box {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(2, 44, 67, 0.1);
        }

        .metric-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            word-break: break-word;
        }

        /* Table */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 16px;
            border-radius: 10px;
            background: var(--surface);
            box-shadow: 0 2px 8px rgba(2, 44, 67, 0.08);
        }

        table {
            width: 100%;
            min-width: 100%;
            border-collapse: collapse;
            table-layout: auto;
            font-size: 13.5px;
            background: transparent;
            direction: rtl !important;
        }

        th, td {
            padding: 9px 10px !important;
            text-align: right !important;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 13.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            background: var(--surface);
            font-size: 13px;
            color: var(--on-surface);
        }

        tr:hover td {
            background-color: rgba(2, 44, 67, 0.05);
        }

        /* الحفاظ على اتجاه RTL بغض النظر عن اللغة */
        [data-lang="ar"] table,
        [data-lang="en"] table {
            direction: rtl !important;
        }

        [data-lang="ar"] th,
        [data-lang="ar"] td,
        [data-lang="en"] th,
        [data-lang="en"] td {
            text-align: right !important;
        }

        .positive {
            color: var(--success);
            font-weight: 600;
        }

        .negative {
            color: var(--danger);
            font-weight: 600;
        }

        /* Form */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--on-surface);
            font-size: 13px;
            display: block;
            font-family: 'Cairo', sans-serif;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Cairo', sans-serif;
            background: var(--surface);
            color: var(--on-surface);
        }

        /* Button */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            font-family: 'Cairo', sans-serif;
            font-weight: 500;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(2, 44, 67, 0.15);
        }

        .btn.secondary {
            background: var(--secondary);
            color: white;
        }

        .btn.danger {
            background: var(--danger);
            color: white;
        }

        .btn.success {
            background: var(--success);
            color: white;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(2, 44, 67, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 320px;
            margin-bottom: 16px;
        }

        /* Auto Update Form */
        .auto-update-form {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .auto-update-info {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-size: 12px;
            color: var(--on-surface);
        }

        .auto-update-status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
            display: inline-block;
        }

        .auto-update-status.success {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .auto-update-status.error {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge.buy {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
        }

        .badge.sell {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
        }

        /* أرقام بدون تقريب */
        .exact-number {
            font-family: 'Courier New', monospace;
            font-weight: 500;
        }

        /* إخفاء الأسهم في selects */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23022C43' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: left 12px center;
            background-size: 16px;
            padding-left: 36px;
            padding-right: 12px;
        }

    </style>
</head>
<body data-theme="light" data-lang="ar">
    
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <div class="nav-logo" title="InDar Tracker">
            <i class="fas fa-chart-line"></i>
        </div>

        <div class="nav-items">
            <div class="nav-item active" onclick="switchTab('dashboard')" title="Dashboard">
                <i class="fas fa-chart-pie"></i>
            </div>
            <div class="nav-item" onclick="switchTab('transactions')" title="Transactions">
                <i class="fas fa-exchange-alt"></i>
            </div>
            <div class="nav-item" onclick="switchTab('funds')" title="Funds">
                <i class="fas fa-list"></i>
            </div>
            <div class="nav-item" onclick="switchTab('prices')" title="Prices">
                <i class="fas fa-database"></i>
            </div>
            <div class="nav-item" onclick="switchTab('analytics')" title="Analytics">
                <i class="fas fa-chart-bar"></i>
            </div>
            <div class="nav-item" onclick="switchTab('general-info')" title="General Info">
                <i class="fas fa-info-circle"></i>
            </div>
            <div class="nav-item" onclick="switchTab('export')" title="Export">
                <i class="fas fa-download"></i>
            </div>
        </div>

        <div class="nav-separator"></div>

        <div class="nav-items bottom-section">
            <div class="nav-item" onclick="toggleTheme()" title="Toggle Theme">
                <i class="fas fa-moon" id="theme-icon"></i>
            </div>
            <div class="nav-item" onclick="toggleLanguage()" title="Toggle Language">
                <i class="fas fa-globe"></i>
            </div>
            <div class="nav-item" onclick="showFundModal()" title="Add Fund">
                <i class="fas fa-plus"></i>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1><i class="fas fa-chart-line"></i> <span data-ar="ان - دار " data-en="InDar">InDar Tracker</span></h1>
                    <p id="current-fund-display">اختر صندوق</p>
                </div>
                <div class="header-controls">
                    <select id="fund-select" class="fund-selector"></select>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-wrapper">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="content active">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-wallet"></i>
                        <span data-ar="ملخص المحفظة" data-en="Portfolio Summary">ملخص المحفظة</span>
                    </div>
                    <div class="grid-4">
                        <div class="metric-box">
                            <div class="metric-label"><i class="fas fa-cubes"></i> <span data-ar="إجمالي الوثائق" data-en="Total Units">إجمالي الوثائق</span></div>
                            <div class="metric-value" id="total-units">0</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);">
                            <div class="metric-label"><i class="fas fa-coins"></i> <span data-ar="متوسط الشراء" data-en="Avg Buy">متوسط الشراء</span></div>
                            <div class="metric-value exact-number" id="avg-price">0</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(135deg, var(--tertiary) 0%, var(--tertiary-dark) 100%);">
                            <div class="metric-label"><i class="fas fa-tag"></i> <span data-ar="السعر الحالي" data-en="Current Price">السعر الحالي</span></div>
                            <div class="metric-value exact-number" id="current-price">0</div>
                        </div>
                        <div class="metric-box" id="value-box">
                            <div class="metric-label"><i class="fas fa-dollar-sign"></i> <span data-ar="القيمة الحالية" data-en="Current Value">القيمة الحالية</span></div>
                            <div class="metric-value" id="current-value">0</div>
                        </div>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-title"><i class="fas fa-chart-area"></i> <span data-ar="أداء المحفظة" data-en="Performance">أداء المحفظة</span></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <div style="font-size: 11px; color: var(--on-surface); opacity: 0.7; margin-bottom: 4px;"><span data-ar="إجمالي الاستثمار" data-en="Total Invested">إجمالي الاستثمار</span></div>
                                <div style="font-size: 18px; font-weight: 700; color: var(--primary);" id="total-invested">0</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--on-surface); opacity: 0.7; margin-bottom: 4px;"><span data-ar="الربح/الخسارة" data-en="Profit/Loss">الربح/الخسارة</span></div>
                                <div style="font-size: 18px; font-weight: 700;" id="net-profit">0</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--on-surface); opacity: 0.7; margin-bottom: 4px;"><span data-ar="العائد %" data-en="Return %">العائد %</span></div>
                                <div style="font-size: 18px; font-weight: 700;" id="return-pct">0%</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--on-surface); opacity: 0.7; margin-bottom: 4px;"><span data-ar="آخر تحديث" data-en="Last Update">آخر تحديث</span></div>
                                <div style="font-size: 13px; font-weight: 600;" id="last-update">--</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title"><i class="fas fa-database"></i> <span data-ar="قاعدة بيانات الأسعار" data-en="Prices Database">قاعدة بيانات الأسعار</span></div>
                        <div style="font-size: 12px; color: var(--on-surface); opacity: 0.7; margin-bottom: 12px;">
                            <span data-ar="عدد الأسعار المسجلة:" data-en="Prices recorded:">عدد الأسعار المسجلة:</span>
                            <strong id="prices-count">0</strong>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn" onclick="exportPricesPDF()">
                                <i class="fas fa-file-pdf"></i> <span data-ar="PDF" data-en="PDF">PDF</span>
                            </button>
                            <button class="btn secondary" onclick="exportPricesJSON()">
                                <i class="fas fa-database"></i> <span data-ar="JSON" data-en="JSON">JSON</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-history"></i> <span data-ar="آخر 30 سعر" data-en="Last 30 Prices">آخر 30 سعر</span></div>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th><i class="fas fa-calendar"></i> <span data-ar="التاريخ" data-en="Date">التاريخ</span></th>
                                    <th><i class="fas fa-tag"></i> <span data-ar="السعر" data-en="Price">السعر</span></th>
                                    <th><i class="fas fa-arrow-up-down"></i> <span data-ar="التغير %" data-en="Change %">التغير %</th>
                                    <th><i class="fas fa-circle"></i> <span data-ar="الحالة" data-en="Status">الحالة</span></th>
                                </tr>
                            </thead>
                            <tbody id="price-history-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div id="transactions" class="content">
                <div class="card">
                    <div class="card-title"><i class="fas fa-plus-circle"></i> <span data-ar="إضافة معاملة" data-en="Add Transaction">إضافة معاملة</span></div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label data-ar="التاريخ" data-en="Date">التاريخ</label>
                            <input type="date" id="tx-date">
                        </div>
                        <div class="form-group">
                            <label data-ar="النوع" data-en="Type">النوع</label>
                            <select id="tx-type">
                                <option value="buy" data-ar="شراء" data-en="Buy">شراء</option>
                                <option value="sell" data-ar="بيع" data-en="Sell">بيع</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-ar="عدد الوثائق" data-en="Units">عدد الوثائق</label>
                            <input type="number" id="tx-units" placeholder="0" step="1">
                        </div>
                        <div class="form-group">
                            <label data-ar="سعر الوثيقة" data-en="Price">سعر الوثيقة</label>
                            <input type="text" id="tx-price" placeholder="0" step="any">
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="addTransaction()">
                            <i class="fas fa-check"></i> <span data-ar="إضافة" data-en="Add">إضافة</span>
                        </button>
                        <button class="btn secondary" onclick="clearTxForm()">
                            <i class="fas fa-redo"></i> <span data-ar="مسح" data-en="Clear">مسح</span>
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-list"></i> <span data-ar="سجل المعاملات" data-en="Transactions Log">سجل المعاملات</span></div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th><i class="fas fa-calendar"></i> <span data-ar="التاريخ" data-en="Date">التاريخ</span></th>
                                    <th><i class="fas fa-clock"></i> <span data-ar="المدة" data-en="Duration">المدة</span></th>
                                    <th><i class="fas fa-exchange-alt"></i> <span data-ar="النوع" data-en="Type">النوع</span></th>
                                    <th><i class="fas fa-cubes"></i> <span data-ar="الوثائق" data-en="Units">الوثائق</span></th>
                                    <th><i class="fas fa-tag"></i> <span data-ar="السعر" data-en="Price">السعر</span></th>
                                    <th><i class="fas fa-money-bill"></i> <span data-ar="المبلغ" data-en="Amount">المبلغ</span></th>
                                    <th><i class="fas fa-cog"></i> <span data-ar="الإجراءات" data-en="Actions">الإجراءات</span></th>
                                </tr>
                            </thead>
                            <tbody id="transactions-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Funds Tab -->
            <div id="funds" class="content">
                <div class="card">
                    <div class="card-title"><i class="fas fa-list"></i> <span data-ar="قائمة الصناديق" data-en="Funds List">قائمة الصناديق</span></div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th><i class="fas fa-info"></i> <span data-ar="الاسم" data-en="Name">الاسم</span></th>
                                    <th><i class="fas fa-code"></i> <span data-ar="الكود" data-en="Code">الكود</span></th>
                                    <th><i class="fas fa-tag"></i> <span data-ar="السعر" data-en="Price">السعر</span></th>
                                    <th><i class="fas fa-percent"></i> <span data-ar="رسوم" data-en="Fees">رسوم</span></th>
                                    <th><i class="fas fa-cog"></i> <span data-ar="الإجراءات" data-en="Actions">الإجراءات</span></th>
                                </tr>
                            </thead>
                            <tbody id="funds-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Prices Tab -->
            <div id="prices" class="content">
                <div class="card">
                    <div class="card-title"><i class="fas fa-calendar-alt"></i> <span data-ar="تاريخ اليوم" data-en="Today">تاريخ اليوم</span>: <span id="today-date" style="color: var(--primary); font-weight: 700;">--</span></div>
                </div>

                <!-- Auto Update Form لكل صندوق -->
                <div class="auto-update-form">
                    <div class="card-title"><i class="fas fa-robot"></i> <span data-ar="التحديث التلقائي للأسعار لكل صندوق" data-en="Auto Price Update Per Fund">التحديث التلقائي للأسعار لكل صندوق</span></div>
                    
                    <div class="auto-update-info">
                        <i class="fas fa-info-circle"></i> <span data-ar="سيتم تحديث سعر كل صندوق من مصدر مختلف حسب الإعدادات الخاصة به" data-en="Each fund will be updated from different source based on its settings">سيتم تحديث سعر كل صندوق من مصدر مختلف حسب الإعدادات الخاصة به</span>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-filter"></i> <span data-ar="اختر الصندوق" data-en="Select Fund">اختر الصندوق</span></label>
                        <select id="auto-update-fund-select">
                            <option value="" data-ar="اختر صندوق" data-en="Select Fund">اختر صندوق</option>
                        </select>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label><i class="fas fa-link"></i> <span data-ar="رابط الموقع" data-en="Website URL">رابط الموقع</span></label>
                            <input type="text" id="auto-update-url" placeholder="https://example.com/fund-price">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-code"></i> <span data-ar="كود العنصر" data-en="Element Code">كود العنصر</span></label>
                            <input type="text" id="element-code" placeholder=".price-element" value=".price-element">
                        </div>
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label><i class="fas fa-clock"></i> <span data-ar="وقت التحديث" data-en="Update Time">وقت التحديث</span></label>
                            <select id="update-time">
                                <option value="09:00">09:00 صباحاً</option>
                                <option value="10:00">10:00 صباحاً</option>
                                <option value="11:00">11:00 صباحاً</option>
                                <option value="12:00">12:00 ظهراً</option>
                                <option value="13:00">01:00 ظهراً</option>
                                <option value="14:00">02:00 ظهراً</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-sync"></i> <span data-ar="التكرار" data-en="Frequency">التكرار</span></label>
                            <select id="update-frequency">
                                <option value="daily" data-ar="يومي" data-en="Daily">يومي</option>
                                <option value="weekly" data-ar="أسبوعي" data-en="Weekly">أسبوعي</option>
                                <option value="monthly" data-ar="شهري" data-en="Monthly">شهري</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="auto-update-status" class="auto-update-status" style="display: none;"></div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="saveAutoUpdateSettings()">
                            <i class="fas fa-save"></i> <span data-ar="حفظ الإعدادات" data-en="Save Settings">حفظ الإعدادات</span>
                        </button>
                        <button class="btn secondary" onclick="testAutoUpdate()">
                            <i class="fas fa-bolt"></i> <span data-ar="اختبار الآن" data-en="Test Now">اختبار الآن</span>
                        </button>
                        <button class="btn danger" onclick="stopAutoUpdate()">
                            <i class="fas fa-stop"></i> <span data-ar="إيقاف التحديث" data-en="Stop Update">إيقاف التحديث</span>
                        </button>
                    </div>
                    
                    <div style="margin-top: 15px; font-size: 12px; color: var(--on-surface);">
                        <i class="fas fa-history"></i> <span id="last-auto-update">آخر تحديث: --</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-edit"></i> <span data-ar="تحديث سعر الوثيقة" data-en="Update Price">تحديث سعر الوثيقة</span></div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label data-ar="اسم الصندوق" data-en="Fund Name">اسم الصندوق</label>
                            <input type="text" id="price-fund-name" readonly style="background: rgba(2, 44, 67, 0.1); cursor: not-allowed;">
                        </div>
                        <div class="form-group">
                            <label data-ar="السعر الجديد" data-en="New Price">السعر الجديد</label>
                            <input type="text" id="price-new" placeholder="0" step="any">
                        </div>
                    </div>
                    <div class="form-group">
                        <label data-ar="التاريخ" data-en="Date">التاريخ</label>
                            <input type="date" id="price-date">
                    </div>
                    <button class="btn" onclick="updatePrice()" style="width: 100%; justify-content: center;">
                        <i class="fas fa-check"></i> <span data-ar="تحديث" data-en="Update">تحديث</span>
                    </button>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="content">
                <!-- صافي الربح بعد الرسوم -->
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-calculator"></i>
                        <span data-ar="صافي الربح بعد الرسوم" data-en="Net Profit After Fees">صافي الربح بعد الرسوم</span>
                    </div>
                    <div class="grid-3">
                        <div class="metric-box">
                            <div class="metric-label"><i class="fas fa-money-bill"></i> <span data-ar="إجمالي المبلغ المدفوع" data-en="Total Amount Paid">إجمالي المبلغ المدفوع</span></div>
                            <div class="metric-value" id="total-amount-paid">0</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);">
                            <div class="metric-label"><i class="fas fa-coins"></i> <span data-ar="إجمالي بيع الوثائق بسعر اليوم" data-en="Total Sale at Current Price">إجمالي بيع الوثائق بسعر اليوم</span></div>
                            <div class="metric-value" id="total-sale-current">0</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(135deg, var(--tertiary) 0%, var(--tertiary-dark) 100%);">
                            <div class="metric-label"><i class="fas fa-percent"></i> <span data-ar="صافي الربح بعد رسوم الاسترداد" data-en="Net Profit After Redemption Fees">صافي الربح بعد رسوم الاسترداد</span></div>
                            <div class="metric-value" id="net-after-redemption-fees">0</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: rgba(255, 215, 0, 0.1); border-radius: 8px; font-size: 12px; color: var(--on-surface);">
                        <i class="fas fa-info-circle"></i> <span data-ar="حساب: (عدد الوثائق × السعر الحالي) - (رسوم الاسترداد %)" data-en="Calculation: (Units × Current Price) - (Redemption Fees %)">حساب: (عدد الوثائق × السعر الحالي) - (رسوم الاسترداد %)</span>
                    </div>
                </div>

                <!-- تجميع الأرباح -->
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-money-bill-wave"></i>
                        <span data-ar="تجميع الأرباح" data-en="Profit Accumulation">تجميع الأرباح</span>
                    </div>
                    <div class="grid-4">
                        <div class="metric-box" style="background: linear-gradient(135deg, var(--success) 0%, #1e7e34 100%);">
                            <div class="metric-label"><i class="fas fa-coins"></i> <span data-ar="المكسب الحقيقي" data-en="Real Profit">المكسب الحقيقي</span></div>
                            <div class="metric-value" id="real-profit">0</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(135deg, var(--danger) 0%, #c82333 100%);">
                            <div class="metric-label"><i class="fas fa-exclamation-triangle"></i> <span data-ar="الخسائر السابقة" data-en="Past Losses">الخسائر السابقة</span></div>
                            <div class="metric-value" id="past-losses">0</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(135deg, var(--tertiary) 0%, var(--tertiary-dark) 100%);">
                            <div class="metric-label"><i class="fas fa-calculator"></i> <span data-ar="صافي الربح بعد جميع الرسوم" data-en="Net Profit After All Fees">صافي الربح بعد جميع الرسوم</span></div>
                            <div class="metric-value" id="net-after-all-fees">0</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);">
                            <div class="metric-label"><i class="fas fa-balance-scale"></i> <span data-ar="متوسط سعر الوثيقة" data-en="Avg Unit Price">متوسط سعر الوثيقة</span></div>
                            <div class="metric-value exact-number" id="avg-unit-price">0</div>
                        </div>
                    </div>
                </div>

                <!-- تأثير العمليات على الربحية -->
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-exchange-alt"></i>
                        <span data-ar="تأثير العمليات على الربحية" data-en="Transaction Impact on Profitability">تأثير العمليات على الربحية</span>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th><i class="fas fa-calendar"></i> <span data-ar="التاريخ" data-en="Date">التاريخ</span></th>
                                    <th><i class="fas fa-exchange-alt"></i> <span data-ar="النوع" data-en="Type">النوع</span></th>
                                    <th><i class="fas fa-cubes"></i> <span data-ar="الوثائق" data-en="Units">الوثائق</span></th>
                                    <th><i class="fas fa-tag"></i> <span data-ar="السعر" data-en="Price">السعر</span></th>
                                    <th><i class="fas fa-money-bill"></i> <span data-ar="تأثير الربحية" data-en="Profit Impact">تأثير الربحية</span></th>
                                    <th><i class="fas fa-percent"></i> <span data-ar="تأثير الرسوم" data-en="Fees Impact">تأثير الرسوم</span></th>
                                </tr>
                            </thead>
                            <tbody id="profit-impact-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- باقي التحليلات -->
                <div class="grid-2">
                    <div class="card">
                        <div class="card-title"><i class="fas fa-pie-chart"></i> <span data-ar="توزيع المحفظة" data-en="Portfolio Distribution">توزيع المحفظة</span></div>
                        <div class="chart-container">
                            <canvas id="portfolioChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title"><i class="fas fa-chart-area"></i> <span data-ar="الأداء الشهري" data-en="Monthly Performance">الأداء الشهري</span></div>
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-percent"></i> <span data-ar="العائد على الاستثمار" data-en="Return on Investment">العائد على الاستثمار</span></div>
                    <div class="chart-container">
                        <canvas id="returnChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-chart-bar"></i> <span data-ar="إحصائيات شاملة" data-en="Complete Statistics">إحصائيات شاملة</span></div>
                    <div class="grid-4">
                        <div>
                            <div style="font-size: 12px; color: var(--on-surface); opacity: 0.7; margin-bottom: 8px;"><i class="fas fa-list"></i> <span data-ar="عدد الصناديق" data-en="Number of Funds">عدد الصناديق</span></div>
                            <div style="font-size: 28px; font-weight: 700; color: var(--primary);" id="stats-funds">0</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--on-surface); opacity: 0.7; margin-bottom: 8px;"><i class="fas fa-exchange-alt"></i> <span data-ar="عدد المعاملات" data-en="Total Transactions">عدد المعاملات</span></div>
                            <div style="font-size: 28px; font-weight: 700; color: var(--primary);" id="stats-transactions">0</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--on-surface); opacity: 0.7; margin-bottom: 8px;"><i class="fas fa-trophy"></i> <span data-ar="أفضل صندوق" data-en="Best Fund">أفضل صندوق</span></div>
                            <div style="font-size: 18px; font-weight: 700; color: var(--success);" id="stats-best">--</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: var(--on-surface); opacity: 0.7; margin-bottom: 8px;"><i class="fas fa-exclamation-triangle"></i> <span data-ar="أسوأ صندوق" data-en="Worst Fund">أسوأ صندوق</span></div>
                            <div style="font-size: 18px; font-weight: 700; color: var(--danger);" id="stats-worst">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- General Info Tab -->
            <div id="general-info" class="content">
                <!-- القسم الأول: إجماليات الصناديق -->
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-chart-bar"></i>
                        <span data-ar="إجماليات جميع الصناديق" data-en="Total for All Funds">إجماليات جميع الصناديق</span>
                        <button class="btn secondary" onclick="exportGeneralInfoPDF()" style="margin-right: auto; font-size: 12px; padding: 6px 12px;">
                            <i class="fas fa-file-pdf"></i> <span data-ar="تصدير PDF" data-en="Export PDF">تصدير PDF</span>
                        </button>
                    </div>
                    <div class="grid-4">
                        <div class="metric-box">
                            <div class="metric-label"><i class="fas fa-money-bill-wave"></i> <span data-ar="إجمالي المبلغ المدفوع" data-en="Total Amount Paid">إجمالي المبلغ المدفوع</span></div>
                            <div class="metric-value" id="total-paid-all">0</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(135deg, var(--success) 0%, #1e7e34 100%);">
                            <div class="metric-label"><i class="fas fa-chart-line"></i> <span data-ar="إجمالي الربح المحتمل" data-en="Total Potential Profit">إجمالي الربح المحتمل</span></div>
                            <div class="metric-value" id="total-profit-all">0</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label"><i class="fas fa-balance-scale"></i> <span data-ar="إجمالي الربح/الخسارة" data-en="Total Profit/Loss">إجمالي الربح/الخسارة</span></div>
                            <div class="metric-value" id="total-pl-all">0</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(135deg, var(--tertiary) 0%, var(--tertiary-dark) 100%);">
                            <div class="metric-label"><i class="fas fa-cubes"></i> <span data-ar="إجمالي الوثائق" data-en="Total Units">إجمالي الوثائق</span></div>
                            <div class="metric-value" id="total-units-all">0</div>
                        </div>
                    </div>
                </div>

                <!-- القسم الثاني: تفاصيل كل صندوق -->
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-list"></i>
                        <span data-ar="تفاصيل الصناديق" data-en="Funds Details">تفاصيل الصناديق</span>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th><i class="fas fa-info"></i> <span data-ar="اسم الصندوق" data-en="Fund Name">اسم الصندوق</span></th>
                                    <th><i class="fas fa-cubes"></i> <span data-ar="الوثائق" data-en="Units">الوثائق</span></th>
                                    <th><i class="fas fa-money-bill"></i> <span data-ar="إجمالي الاستثمار" data-en="Total Investment">إجمالي الاستثمار</span></th>
                                    <th><i class="fas fa-chart-line"></i> <span data-ar="الربح بدون رسوم" data-en="Profit Without Fees">الربح بدون رسوم</span></th>
                                    <th><i class="fas fa-calculator"></i> <span data-ar="الربح بعد رسوم الاسترداد" data-en="Profit After Redemption Fees">الربح بعد رسوم الاسترداد</span></th>
                                    <th><i class="fas fa-tag"></i> <span data-ar="متوسط الشراء" data-en="Avg Buy">متوسط الشراء</span></th>
                                    <th><i class="fas fa-tag"></i> <span data-ar="السعر الحالي" data-en="Current Price">السعر الحالي</span></th>
                                    <th><i class="fas fa-dollar-sign"></i> <span data-ar="القيمة الحالية" data-en="Current Value">القيمة الحالية</span></th>
                                    <th><i class="fas fa-percent"></i> <span data-ar="العائد %" data-en="Return %">العائد %</span></th>
                                </tr>
                            </thead>
                            <tbody id="funds-details-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Export Tab -->
            <div id="export" class="content">
                <div class="card">
                    <div class="card-title"><i class="fas fa-download"></i> <span data-ar="تصدير البيانات" data-en="Export Data">تصدير البيانات</span></div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="exportJSON()">
                            <i class="fas fa-database"></i> JSON
                        </button>
                        <button class="btn secondary" onclick="exportCSV()">
                            <i class="fas fa-file-csv"></i> CSV
                        </button>
                        <button class="btn" onclick="exportPDF()">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-upload"></i> <span data-ar="استيراد البيانات" data-en="Import Data">استيراد البيانات</span></div>
                    <div class="form-group">
                        <label data-ar="اختر ملف" data-en="Choose File">اختر ملف</label>
                        <input type="file" id="import-file" accept=".json">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="importFile()">
                            <i class="fas fa-check"></i> <span data-ar="استيراد" data-en="Import">استيراد</span>
                        </button>
                        <button class="btn danger" onclick="clearAllData()">
                            <i class="fas fa-trash"></i> <span data-ar="مسح الكل" data-en="Clear All">مسح الكل</span>
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-info-circle"></i> <span data-ar="معلومات التطبيق" data-en="App Info">معلومات التطبيق</span></div>
                    <div style="font-size: 13px; color: var(--on-surface);">
                        <p><span data-ar="الصناديق:" data-en="Funds:">الصناديق:</span> <strong id="info-funds">0</strong></p>
                        <p><span data-ar="المعاملات:" data-en="Transactions:">المعاملات:</span> <strong id="info-transactions">0</strong></p>
                        <p><span data-ar="آخر تحديث:" data-en="Last Updated:">آخر تحديث:</span> <strong id="info-updated">--</strong></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fund Modal (إضافة/تعديل) -->
    <div id="fundModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid var(--border);">
                <h2 style="color: var(--primary); font-size: 18px; font-weight: 600;"><i class="fas fa-plus-circle"></i> <span id="modal-title" data-ar="إضافة صندوق جديد" data-en="Add New Fund">إضافة صندوق جديد</span></h2>
                <button onclick="closeFundModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--on-surface); opacity: 0.7;">&times;</button>
            </div>
            <input type="hidden" id="fund-id">
            <div class="form-group">
                <label data-ar="اسم الصندوق" data-en="Fund Name">اسم الصندوق</label>
                <input type="text" id="fund-name" placeholder="">
            </div>
            <div class="form-group">
                <label data-ar="كود الصندوق" data-en="Fund Code">كود الصندوق</label>
                <input type="text" id="fund-code" placeholder="">
            </div>
            <div class="form-group">
                <label data-ar="السعر الحالي" data-en="Current Price">السعر الحالي</label>
                <input type="text" id="fund-price" placeholder="0">
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label data-ar="رسوم الاكتتاب %" data-en="Subscription Fee %">رسوم الاكتتاب %</label>
                    <input type="number" id="fund-sub-fee" placeholder="0" step="any" value="0">
                </div>
                <div class="form-group">
                    <label data-ar="رسوم الاسترداد %" data-en="Redemption Fee %">رسوم الاسترداد %</label>
                    <input type="number" id="fund-red-fee" placeholder="0" step="any" value="0">
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="saveFund()">
                    <i class="fas fa-check"></i> <span id="save-btn-text" data-ar="إضافة" data-en="Add">إضافة</span>
                </button>
                <button class="btn danger" onclick="closeFundModal()">
                    <i class="fas fa-times"></i> <span data-ar="إلغاء" data-en="Cancel">إلغاء</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editTxModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid var(--border);">
                <h2 style="color: var(--primary); font-size: 18px; font-weight: 600;"><i class="fas fa-edit"></i> <span data-ar="تعديل معاملة" data-en="Edit Transaction">تعديل معاملة</span></h2>
                <button onclick="closeEditTxModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--on-surface); opacity: 0.7;">&times;</button>
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label data-ar="التاريخ" data-en="Date">التاريخ</label>
                    <input type="date" id="edit-tx-date">
                </div>
                <div class="form-group">
                    <label data-ar="النوع" data-en="Type">النوع</label>
                    <select id="edit-tx-type">
                        <option value="buy" data-ar="شراء" data-en="Buy">شراء</option>
                        <option value="sell" data-ar="بيع" data-en="Sell">بيع</option>
                    </select>
                </div>
                <div class="form-group">
                    <label data-ar="عدد الوثائق" data-en="Units">عدد الوثائق</label>
                    <input type="number" id="edit-tx-units" placeholder="0" step="1">
                </div>
                <div class="form-group">
                    <label data-ar="سعر الوثيقة" data-en="Price">سعر الوثيقة</label>
                    <input type="text" id="edit-tx-price" placeholder="0">
                </div>
            </div>
            <input type="hidden" id="edit-tx-index">
            <div style="display: flex; gap: 10px;">
                <button class="btn" onclick="saveEditedTransaction()">
                    <i class="fas fa-save"></i> <span data-ar="حفظ" data-en="Save">حفظ</span>
                </button>
                <button class="btn danger" onclick="closeEditTxModal()">
                    <i class="fas fa-times"></i> <span data-ar="إلغاء" data-en="Cancel">إلغاء</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============ STATE ============
        let funds = [];
        let currentFundId = null;
        let lang = localStorage.getItem('app_lang') || 'ar';
        let theme = localStorage.getItem('app_theme') || 'light';
        let chartInstances = {};
        let autoUpdateTimer = null;
        let autoUpdateSettings = JSON.parse(localStorage.getItem('auto_update_settings') || '{}');

        // Language labels
        const labels = {
            ar: {
                buy: 'شراء',
                sell: 'بيع',
                selectFund: 'اختر صندوق',
                noData: 'لا توجد بيانات',
                days: 'يوم',
                months: 'شهر',
                years: 'سنة',
                and: 'و',
                edit: 'تعديل',
                add: 'إضافة'
            },
            en: {
                buy: 'Buy',
                sell: 'Sell',
                selectFund: 'Select a fund',
                noData: 'No data',
                days: 'day',
                months: 'month',
                years: 'year',
                and: 'and',
                edit: 'Edit',
                add: 'Add'
            }
        };

        // ============ INIT ============
        function init() {
            loadData();
            applyTheme(theme);
            applyLang(lang);
            setToday();
            renderAll();
            Chart.defaults.font.family = "'Cairo', sans-serif";
            Chart.defaults.color = theme === 'dark' ? '#e0e0e0' : '#666';
            setupAutoUpdate();
        }

        function setToday() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tx-date').value = today;
            document.getElementById('price-date').value = today;
            document.getElementById('edit-tx-date').value = today;
            const dateStr = new Date(today).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US');
            document.getElementById('today-date').textContent = dateStr;
        }

        // ============ TRANSLATIONS ============
        function updateTranslations() {
            document.querySelectorAll('[data-ar][data-en]').forEach(el => {
                const text = lang === 'ar' ? el.getAttribute('data-ar') : el.getAttribute('data-en');
                if (el.tagName === 'INPUT' || el.tagName === 'OPTION') {
                    if (el.hasAttribute('placeholder')) {
                        el.placeholder = text;
                    }
                } else if (!el.querySelector('i')) {
                    el.textContent = text;
                }
            });
        }

        // ============ THEME ============
        function applyTheme(newTheme) {
            theme = newTheme;
            document.body.setAttribute('data-theme', theme);
            document.getElementById('theme-icon').className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            localStorage.setItem('app_theme', theme);
            Chart.defaults.color = theme === 'dark' ? '#e0e0e0' : '#666';
            updateAllCharts();
        }

        function toggleTheme() {
            applyTheme(theme === 'light' ? 'dark' : 'light');
        }

        // ============ LANGUAGE ============
        function applyLang(newLang) {
            lang = newLang;
            document.body.setAttribute('data-lang', lang);
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            localStorage.setItem('app_lang', lang);
            updateTranslations();
            setToday();
            renderAll();
        }

        function toggleLanguage() {
            applyLang(lang === 'ar' ? 'en' : 'ar');
        }

        // ============ NAVIGATION ============
        function switchTab(tabName) {
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');
            
            if (tabName === 'analytics' || tabName === 'dashboard' || tabName === 'general-info') {
                setTimeout(() => {
                    updateAllCharts();
                    updateAdvancedAnalytics();
                    updateGeneralInfo();
                }, 100);
            }
        }

        // ============ FUNDS ============
        function showFundModal(fundId = null) {
            const modalTitle = document.getElementById('modal-title');
            const saveBtnText = document.getElementById('save-btn-text');
            
            if (fundId) {
                const fund = funds.find(f => f.id === fundId);
                if (fund) {
                    document.getElementById('fund-id').value = fund.id;
                    document.getElementById('fund-name').value = fund.name;
                    document.getElementById('fund-code').value = fund.code;
                    document.getElementById('fund-price').value = fund.price;
                    document.getElementById('fund-sub-fee').value = fund.subscriptionFee || 0;
                    document.getElementById('fund-red-fee').value = fund.redemptionFee || 0;
                    
                    modalTitle.setAttribute('data-ar', 'تعديل الصندوق');
                    modalTitle.setAttribute('data-en', 'Edit Fund');
                    saveBtnText.setAttribute('data-ar', 'حفظ');
                    saveBtnText.setAttribute('data-en', 'Save');
                }
            } else {
                document.getElementById('fund-id').value = '';
                document.getElementById('fund-name').value = '';
                document.getElementById('fund-code').value = '';
                document.getElementById('fund-price').value = '';
                document.getElementById('fund-sub-fee').value = '0';
                document.getElementById('fund-red-fee').value = '0';
                
                modalTitle.setAttribute('data-ar', 'إضافة صندوق جديد');
                modalTitle.setAttribute('data-en', 'Add New Fund');
                saveBtnText.setAttribute('data-ar', 'إضافة');
                saveBtnText.setAttribute('data-en', 'Add');
            }
            
            updateTranslations();
            document.getElementById('fundModal').classList.add('active');
        }

        function closeFundModal() {
            document.getElementById('fundModal').classList.remove('active');
        }

        function saveFund() {
            const id = document.getElementById('fund-id').value;
            const name = document.getElementById('fund-name').value.trim();
            const code = document.getElementById('fund-code').value.trim().toUpperCase();
            const price = document.getElementById('fund-price').value.trim();
            const subFee = parseFloat(document.getElementById('fund-sub-fee').value) || 0;
            const redFee = parseFloat(document.getElementById('fund-red-fee').value) || 0;

            if (!name || !code || !price) {
                alert(lang === 'ar' ? 'الرجاء ملء البيانات الصحيحة' : 'Please fill in correct data');
                return;
            }

            if (id) {
                // تعديل صندوق موجود
                const fundIndex = funds.findIndex(f => f.id === id);
                if (fundIndex !== -1) {
                    funds[fundIndex].name = name;
                    funds[fundIndex].code = code;
                    funds[fundIndex].price = price;
                    funds[fundIndex].subscriptionFee = subFee;
                    funds[fundIndex].redemptionFee = redFee;
                }
            } else {
                // إضافة صندوق جديد
                const fund = {
                    id: Date.now().toString(),
                    name, code, price,
                    subscriptionFee: subFee,
                    redemptionFee: redFee,
                    transactions: [],
                    priceHistory: [{ date: new Date().toISOString().split('T')[0], price }],
                    autoUpdateSettings: {}
                };
                funds.push(fund);
                if (!currentFundId) currentFundId = fund.id;
            }

            saveData();
            renderAll();
            closeFundModal();
        }

        function deleteFund(id) {
            if (funds.length === 1) {
                alert(lang === 'ar' ? 'لا يمكن حذف الصندوق الوحيد' : 'Cannot delete only fund');
                return;
            }
            if (!confirm(lang === 'ar' ? 'هل تريد حذف الصندوق؟' : 'Delete this fund?')) return;

            funds = funds.filter(f => f.id !== id);
            if (currentFundId === id) currentFundId = funds[0]?.id;
            saveData();
            renderAll();
        }

        function renderFundSelector() {
            const select = document.getElementById('fund-select');
            select.innerHTML = '';
            funds.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.id;
                opt.textContent = `${f.name} (${f.code})`;
                select.appendChild(opt);
            });
            if (currentFundId) select.value = currentFundId;
            select.addEventListener('change', (e) => {
                currentFundId = e.target.value;
                updateFundDisplay();
                updatePortfolio();
                renderTransactionsTable();
                saveData();
            });
            updateFundDisplay();
        }

        function updateFundDisplay() {
            const fund = getCurrentFund();
            document.getElementById('current-fund-display').textContent = fund ? `${fund.name} (${fund.code})` : labels[lang].selectFund;
            document.getElementById('price-fund-name').value = fund ? fund.name : '';
        }

        function renderFundsTable() {
            const tbody = document.getElementById('funds-table');
            tbody.innerHTML = '';
            funds.forEach(f => {
                const tr = document.createElement('tr');
                const fees = `${f.subscriptionFee || 0}% / ${f.redemptionFee || 0}%`;
                tr.innerHTML = `
                    <td>${f.name}</td>
                    <td>${f.code}</td>
                    <td class="exact-number">${formatDisplay(f.price, true)}</td>
                    <td>${fees}</td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn" onclick="showFundModal('${f.id}')" style="padding: 4px 8px; font-size: 11px;" title="${lang === 'ar' ? 'تعديل' : 'Edit'}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn danger" onclick="deleteFund('${f.id}')" style="padding: 4px 8px; font-size: 11px;" title="${lang === 'ar' ? 'حذف' : 'Delete'}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============ HELPER FUNCTIONS ============
        function formatDisplay(num, exact = false) {
            if (num === null || num === undefined || num === '' || isNaN(num)) return '0';
            
            if (exact) {
                // عرض السعر كما هو دون تقريب
                return parseFloat(num).toString();
            }
            
            // تقريب إلى رقمين عشريين لجميع الأرقام الأخرى
            return parseFloat(num).toFixed(2);
        }

        function formatCurrency(num) {
            return formatDisplay(num, false);
        }

        // ============ حساب المدة ============
        function calculateDuration(startDate) {
            const start = new Date(startDate);
            const today = new Date();
            const diffTime = Math.abs(today - start);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays < 30) {
                return `${diffDays} ${lang === 'ar' ? 'يوم' : 'days'}`;
            } else if (diffDays < 365) {
                const months = Math.floor(diffDays / 30);
                return `${months} ${lang === 'ar' ? 'شهر' : 'months'}`;
            } else {
                const years = Math.floor(diffDays / 365);
                const remainingMonths = Math.floor((diffDays % 365) / 30);
                if (remainingMonths > 0) {
                    return `${years} ${lang === 'ar' ? 'سنة' : 'years'} ${lang === 'ar' ? 'و' : 'and'} ${remainingMonths} ${lang === 'ar' ? 'شهر' : 'months'}`;
                }
                return `${years} ${lang === 'ar' ? 'سنة' : 'years'}`;
            }
        }

        // ============ TRANSACTIONS ============
        function addTransaction() {
            const fund = getCurrentFund();
            if (!fund) {
                alert(lang === 'ar' ? 'اختر صندوق أولاً' : 'Select a fund first');
                return;
            }

            const date = document.getElementById('tx-date').value;
            const type = document.getElementById('tx-type').value;
            const units = document.getElementById('tx-units').value;
            const price = document.getElementById('tx-price').value;

            if (!date || !units || !price) {
                alert(lang === 'ar' ? 'الرجاء ملء البيانات الصحيحة' : 'Please fill in correct data');
                return;
            }

            fund.transactions.push({ date, type, units, price });
            clearTxForm();
            saveData();
            renderAll();
        }

        function editTransaction(index) {
            const fund = getCurrentFund();
            if (!fund) return;

            const tx = fund.transactions[index];
            if (!tx) return;

            document.getElementById('edit-tx-date').value = tx.date;
            document.getElementById('edit-tx-type').value = tx.type;
            document.getElementById('edit-tx-units').value = tx.units;
            document.getElementById('edit-tx-price').value = tx.price;
            document.getElementById('edit-tx-index').value = index;

            document.getElementById('editTxModal').classList.add('active');
        }

        function saveEditedTransaction() {
            const fund = getCurrentFund();
            if (!fund) return;

            const index = parseInt(document.getElementById('edit-tx-index').value);
            if (isNaN(index)) return;

            const date = document.getElementById('edit-tx-date').value;
            const type = document.getElementById('edit-tx-type').value;
            const units = document.getElementById('edit-tx-units').value;
            const price = document.getElementById('edit-tx-price').value;

            if (!date || !units || !price) {
                alert(lang === 'ar' ? 'الرجاء ملء البيانات الصحيحة' : 'Please fill in correct data');
                return;
            }

            fund.transactions[index] = { date, type, units, price };
            saveData();
            renderAll();
            closeEditTxModal();
        }

        function closeEditTxModal() {
            document.getElementById('editTxModal').classList.remove('active');
        }

        function deleteTransaction(fundId, idx) {
            const fund = funds.find(f => f.id === fundId);
            if (confirm(lang === 'ar' ? 'هل تريد حذف المعاملة؟' : 'Delete this transaction?')) {
                fund.transactions.splice(idx, 1);
                saveData();
                renderAll();
            }
        }

        function clearTxForm() {
            document.getElementById('tx-units').value = '';
            document.getElementById('tx-price').value = '';
            setToday();
        }

        function renderTransactionsTable() {
            const fund = getCurrentFund();
            const tbody = document.getElementById('transactions-table');
            tbody.innerHTML = '';
            
            if (!fund) return;

            fund.transactions.forEach((tx, idx) => {
                const amount = parseFloat(tx.units) * parseFloat(tx.price);
                const duration = calculateDuration(tx.date);
                
                const tr = document.createElement('tr');
                const typeText = tx.type === 'buy' ? labels[lang].buy : labels[lang].sell;
                const dateStr = new Date(tx.date).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US');
                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${duration}</td>
                    <td><span class="badge ${tx.type}">${typeText}</span></td>
                    <td>${tx.units}</td>
                    <td class="exact-number">${formatDisplay(tx.price, true)}</td>
                    <td>${formatCurrency(amount)}</td>
                    <td>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn" onclick="editTransaction(${idx})" style="padding: 4px 8px; font-size: 11px;" title="${lang === 'ar' ? 'تعديل' : 'Edit'}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn danger" onclick="deleteTransaction('${fund.id}', ${idx})" style="padding: 4px 8px; font-size: 11px;" title="${lang === 'ar' ? 'حذف' : 'Delete'}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============ CALCULATIONS ============
        function calculateMetrics(fund) {
            let units = 0, invested = 0, buyUnits = 0, buyAmount = 0;
            let totalSubscriptionFees = 0, totalRedemptionFees = 0;

            fund.transactions.forEach(tx => {
                const amount = parseFloat(tx.units) * parseFloat(tx.price);
                
                if (tx.type === 'buy') {
                    const fee = amount * (fund.subscriptionFee / 100);
                    const net = amount - fee;
                    units += parseFloat(tx.units);
                    invested += net;
                    buyUnits += parseFloat(tx.units);
                    buyAmount += net;
                    totalSubscriptionFees += fee;
                } else {
                    const fee = amount * (fund.redemptionFee / 100);
                    const net = amount - fee;
                    units -= parseFloat(tx.units);
                    invested -= net;
                    totalRedemptionFees += fee;
                }
            });

            const avgPrice = buyUnits > 0 ? buyAmount / buyUnits : 0;
            const value = units * parseFloat(fund.price || 0);
            const profitWithoutFees = value - invested;
            const profitAfterFees = profitWithoutFees - totalSubscriptionFees - totalRedemptionFees;
            const returnPct = invested > 0 ? (profitAfterFees / invested) * 100 : 0;

            return { 
                units, 
                avgPrice, 
                value, 
                invested, 
                profitWithoutFees,
                profitAfterFees,
                returnPct,
                totalSubscriptionFees,
                totalRedemptionFees
            };
        }

        // حساب صافي الربح بعد رسوم الاسترداد فقط (للعرض في صفحة التحليل)
        function calculateNetAfterRedemptionFees(fund) {
            const m = calculateMetrics(fund);
            // إجمالي بيع الوثائق بسعر اليوم
            const totalSaleAtCurrentPrice = m.units * parseFloat(fund.price || 0);
            // خصم رسوم الاسترداد
            const redemptionFeeAmount = totalSaleAtCurrentPrice * (fund.redemptionFee / 100);
            const netAfterRedemption = totalSaleAtCurrentPrice - redemptionFeeAmount;
            
            return {
                totalSaleAtCurrentPrice,
                redemptionFeeAmount,
                netAfterRedemption
            };
        }

        function updatePortfolio() {
            const fund = getCurrentFund();
            if (!fund) return;

            const m = calculateMetrics(fund);

            document.getElementById('total-units').textContent = m.units;
            document.getElementById('avg-price').textContent = formatDisplay(m.avgPrice, true);
            document.getElementById('current-price').textContent = formatDisplay(fund.price, true);
            document.getElementById('current-value').textContent = formatCurrency(m.value);
            document.getElementById('total-invested').textContent = formatCurrency(m.invested);
            document.getElementById('net-profit').textContent = formatCurrency(m.profitAfterFees);
            document.getElementById('return-pct').textContent = formatDisplay(m.returnPct) + '%';

            const profitEl = document.getElementById('net-profit');
            profitEl.style.color = m.profitAfterFees >= 0 ? 'var(--success)' : 'var(--danger)';
            
            const returnEl = document.getElementById('return-pct');
            returnEl.style.color = m.returnPct >= 0 ? 'var(--success)' : 'var(--danger)';

            const valueBox = document.getElementById('value-box');
            if (m.profitAfterFees >= 0) {
                valueBox.style.background = 'linear-gradient(135deg, var(--success) 0%, #1e7e34 100%)';
            } else {
                valueBox.style.background = 'linear-gradient(135deg, var(--danger) 0%, #c82333 100%)';
            }

            renderPriceHistory();
            updatePricesCount();
            updateLastUpdate();
        }

        function updateLastUpdate() {
            const fund = getCurrentFund();
            if (!fund?.priceHistory?.length) {
                document.getElementById('last-update').textContent = '--';
                return;
            }
            const latest = fund.priceHistory[fund.priceHistory.length - 1];
            const dateStr = new Date(latest.date).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US');
            document.getElementById('last-update').textContent = dateStr;
        }

        function updatePricesCount() {
            const fund = getCurrentFund();
            const count = fund?.priceHistory?.length || 0;
            document.getElementById('prices-count').textContent = count;
        }

        function renderPriceHistory() {
            const fund = getCurrentFund();
            const tbody = document.getElementById('price-history-table');
            tbody.innerHTML = '';

            if (!fund?.priceHistory) return;

            const sorted = [...fund.priceHistory].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 30);
            
            sorted.forEach((entry, idx) => {
                const prev = idx < sorted.length - 1 ? parseFloat(sorted[idx + 1].price) : parseFloat(entry.price);
                const current = parseFloat(entry.price);
                const change = ((current - prev) / prev) * 100;
                const statusIcon = change > 0.1 ? 'fa-arrow-up' : change < -0.1 ? 'fa-arrow-down' : 'fa-minus';
                const statusText = change > 0.1 ? lang === 'ar' ? 'ارتفاع' : 'Up' : change < -0.1 ? lang === 'ar' ? 'انخفاض' : 'Down' : lang === 'ar' ? 'مستقر' : 'Stable';

                const tr = document.createElement('tr');
                const dateStr = new Date(entry.date).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US');
                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td class="exact-number">${formatDisplay(entry.price, true)}</td>
                    <td class="${change >= 0 ? 'positive' : 'negative'}">${change >= 0 ? '+' : ''}${formatDisplay(change)}%</td>
                    <td><i class="fas ${statusIcon}"></i> ${statusText}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============ ADVANCED ANALYTICS ============
        function calculateAdvancedAnalytics(fund) {
            const metrics = calculateMetrics(fund);
            const netRedemption = calculateNetAfterRedemptionFees(fund);
            
            // تجميع الأرباح
            const realProfit = Math.max(metrics.profitAfterFees, 0);
            const pastLosses = Math.abs(Math.min(metrics.profitAfterFees, 0));
            const avgUnitPrice = metrics.avgPrice;
            
            // تأثير العمليات مع مراعاة الرسوم
            const transactionImpact = calculateTransactionImpactWithFees(fund);
            
            return {
                realProfit,
                pastLosses,
                netAfterRedemption: netRedemption.netAfterRedemption,
                totalSaleCurrent: netRedemption.totalSaleAtCurrentPrice,
                avgUnitPrice,
                transactionImpact
            };
        }

        function calculateTransactionImpactWithFees(fund) {
            const impacts = [];
            let cumulativeUnits = 0;
            let cumulativeInvestment = 0;
            
            fund.transactions.forEach((tx, index) => {
                const units = parseFloat(tx.units);
                const price = parseFloat(tx.price);
                const amount = units * price;
                const fee = tx.type === 'buy' 
                    ? amount * (fund.subscriptionFee / 100) 
                    : amount * (fund.redemptionFee / 100);
                
                let impact = 0;
                let feeImpact = 0;
                
                if (tx.type === 'buy') {
                    cumulativeUnits += units;
                    cumulativeInvestment += amount - fee;
                    impact = - (amount + fee);
                    feeImpact = -fee;
                } else {
                    cumulativeUnits -= units;
                    const avgPrice = cumulativeInvestment / cumulativeUnits;
                    impact = (units * parseFloat(fund.price)) - (units * avgPrice) - fee;
                    feeImpact = -fee;
                }
                
                impacts.push({
                    date: tx.date,
                    type: tx.type,
                    units: units,
                    price: price,
                    impact: impact,
                    feeImpact: feeImpact
                });
            });
            
            return impacts;
        }

        function updateAdvancedAnalytics() {
            const fund = getCurrentFund();
            if (!fund) return;
            
            const analytics = calculateAdvancedAnalytics(fund);
            
            // تحديث واجهة التحليلات
            document.getElementById('real-profit').textContent = formatCurrency(analytics.realProfit);
            document.getElementById('past-losses').textContent = formatCurrency(analytics.pastLosses);
            document.getElementById('net-after-redemption-fees').textContent = formatCurrency(analytics.netAfterRedemption);
            document.getElementById('total-sale-current').textContent = formatCurrency(analytics.totalSaleCurrent);
            document.getElementById('avg-unit-price').textContent = formatDisplay(analytics.avgUnitPrice, true);
            document.getElementById('net-after-all-fees').textContent = formatCurrency(analytics.netAfterRedemption);
            
            // تحديث إجمالي المبلغ المدفوع
            const m = calculateMetrics(fund);
            document.getElementById('total-amount-paid').textContent = formatCurrency(m.invested);
            
            // تحديث جدول تأثير العمليات
            updateProfitImpactTable(analytics.transactionImpact);
        }

        function updateProfitImpactTable(impacts) {
            const tbody = document.getElementById('profit-impact-table');
            tbody.innerHTML = '';
            
            impacts.forEach(impact => {
                const tr = document.createElement('tr');
                const dateStr = new Date(impact.date).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US');
                const impactClass = impact.impact >= 0 ? 'positive' : 'negative';
                const feeClass = impact.feeImpact >= 0 ? 'positive' : 'negative';
                const impactSign = impact.impact >= 0 ? '+' : '';
                const feeSign = impact.feeImpact >= 0 ? '+' : '';
                const typeText = impact.type === 'buy' ? labels[lang].buy : labels[lang].sell;
                
                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td><span class="badge ${impact.type}">${typeText}</span></td>
                    <td>${impact.units}</td>
                    <td class="exact-number">${formatDisplay(impact.price, true)}</td>
                    <td class="${impactClass}">${impactSign}${formatCurrency(impact.impact)}</td>
                    <td class="${feeClass}">${feeSign}${formatCurrency(impact.feeImpact)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============ GENERAL INFO ============
        function updateGeneralInfo() {
            // إجماليات جميع الصناديق
            let totalPaid = 0;
            let totalPotentialProfit = 0;
            let totalProfitLoss = 0;
            let totalUnits = 0;
            
            const fundsDetails = [];
            
            funds.forEach(fund => {
                const m = calculateMetrics(fund);
                const netRedemption = calculateNetAfterRedemptionFees(fund);
                
                totalPaid += m.invested;
                totalPotentialProfit += Math.max(m.profitAfterFees, 0);
                totalProfitLoss += m.profitAfterFees;
                totalUnits += m.units;
                
                fundsDetails.push({
                    name: fund.name,
                    units: m.units,
                    invested: m.invested,
                    profitWithoutFees: m.profitWithoutFees,
                    profitAfterRedemptionFees: netRedemption.netAfterRedemption,
                    avgPrice: m.avgPrice,
                    currentPrice: fund.price,
                    currentValue: m.value,
                    returnPct: m.returnPct
                });
            });
            
            // تحديث الإجماليات
            document.getElementById('total-paid-all').textContent = formatCurrency(totalPaid);
            document.getElementById('total-profit-all').textContent = formatCurrency(totalPotentialProfit);
            document.getElementById('total-pl-all').textContent = formatCurrency(totalProfitLoss);
            document.getElementById('total-units-all').textContent = totalUnits;
            
            // تحديث جدول التفاصيل
            updateFundsDetailsTable(fundsDetails);
        }

        function updateFundsDetailsTable(details) {
            const tbody = document.getElementById('funds-details-table');
            tbody.innerHTML = '';
            
            details.forEach(fund => {
                const tr = document.createElement('tr');
                const returnClass = fund.returnPct >= 0 ? 'positive' : 'negative';
                const returnSign = fund.returnPct >= 0 ? '+' : '';
                
                tr.innerHTML = `
                    <td><strong>${fund.name}</strong></td>
                    <td>${fund.units}</td>
                    <td>${formatCurrency(fund.invested)}</td>
                    <td>${formatCurrency(fund.profitWithoutFees)}</td>
                    <td>${formatCurrency(fund.profitAfterRedemptionFees)}</td>
                    <td class="exact-number">${formatDisplay(fund.avgPrice, true)}</td>
                    <td class="exact-number">${formatDisplay(fund.currentPrice, true)}</td>
                    <td>${formatCurrency(fund.currentValue)}</td>
                    <td class="${returnClass}">${returnSign}${formatDisplay(fund.returnPct)}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============ PRICE MANAGEMENT ============
        function updatePrice() {
            const fund = getCurrentFund();
            if (!fund) {
                alert(lang === 'ar' ? 'اختر صندوق أولاً' : 'Select a fund first');
                return;
            }

            const price = document.getElementById('price-new').value.trim();
            const date = document.getElementById('price-date').value;

            if (!price || !date) {
                alert(lang === 'ar' ? 'الرجاء ملء البيانات الصحيحة' : 'Please fill in correct data');
                return;
            }

            fund.price = price;
            const existing = fund.priceHistory.find(p => p.date === date);
            if (existing) {
                existing.price = price;
            } else {
                fund.priceHistory.push({ date, price });
            }

            saveData();
            renderAll();
            document.getElementById('price-new').value = '';
        }

        // ============ AUTO UPDATE SYSTEM ============
        function setupAutoUpdate() {
            // تحميل الإعدادات المحفوظة
            loadAutoUpdateSettings();
            
            // إعداد قائمة الصناديق للتحديث التلقائي
            updateAutoUpdateFundSelector();
            
            // التحقق من التحديث اليومي
            checkDailyUpdate();
            
            // إعداد المؤقت للتحديث اليومي
            setupDailyTimer();
        }

        function updateAutoUpdateFundSelector() {
            const select = document.getElementById('auto-update-fund-select');
            select.innerHTML = '<option value="" data-ar="اختر صندوق" data-en="Select Fund">اختر صندوق</option>';
            
            funds.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.id;
                opt.textContent = `${f.name} (${f.code})`;
                select.appendChild(opt);
            });
            
            select.addEventListener('change', (e) => {
                const fundId = e.target.value;
                if (fundId) {
                    loadFundAutoUpdateSettings(fundId);
                }
            });
        }

        function loadFundAutoUpdateSettings(fundId) {
            const fund = funds.find(f => f.id === fundId);
            if (!fund) return;
            
            const settings = fund.autoUpdateSettings || {};
            
            document.getElementById('auto-update-url').value = settings.url || '';
            document.getElementById('element-code').value = settings.elementCode || '.price-element';
            document.getElementById('update-time').value = settings.updateTime || '09:00';
            document.getElementById('update-frequency').value = settings.frequency || 'daily';
            
            if (settings.lastUpdate) {
                document.getElementById('last-auto-update').textContent = 
                    `${lang === 'ar' ? 'آخر تحديث:' : 'Last Update:'} ${new Date(settings.lastUpdate).toLocaleString(lang === 'ar' ? 'ar-EG' : 'en-US')}`;
            } else {
                document.getElementById('last-auto-update').textContent = 
                    lang === 'ar' ? 'آخر تحديث: --' : 'Last Update: --';
            }
        }

        function saveAutoUpdateSettings() {
            const fundId = document.getElementById('auto-update-fund-select').value;
            if (!fundId) {
                showAutoUpdateStatus(lang === 'ar' ? 'الرجاء اختيار صندوق' : 'Please select a fund', 'error');
                return;
            }

            const url = document.getElementById('auto-update-url').value.trim();
            const elementCode = document.getElementById('element-code').value.trim();
            const updateTime = document.getElementById('update-time').value;
            const frequency = document.getElementById('update-frequency').value;
            
            if (!url || !elementCode) {
                showAutoUpdateStatus(lang === 'ar' ? 'الرجاء إدخال رابط الموقع وكود العنصر' : 'Please enter website URL and element code', 'error');
                return;
            }
            
            const fund = funds.find(f => f.id === fundId);
            if (!fund) return;
            
            fund.autoUpdateSettings = {
                url,
                elementCode,
                updateTime,
                frequency,
                lastUpdate: new Date().toISOString(),
                enabled: true
            };
            
            saveData();
            showAutoUpdateStatus(lang === 'ar' ? 'تم حفظ الإعدادات بنجاح' : 'Settings saved successfully', 'success');
            
            // تحديث عرض آخر تحديث
            document.getElementById('last-auto-update').textContent = 
                `${lang === 'ar' ? 'آخر تحديث:' : 'Last Update:'} ${new Date().toLocaleString(lang === 'ar' ? 'ar-EG' : 'en-US')}`;
            
            // إعادة إعداد المؤقت
            setupDailyTimer();
        }

        function stopAutoUpdate() {
            const fundId = document.getElementById('auto-update-fund-select').value;
            if (!fundId) {
                showAutoUpdateStatus(lang === 'ar' ? 'الرجاء اختيار صندوق' : 'Please select a fund', 'error');
                return;
            }

            const fund = funds.find(f => f.id === fundId);
            if (!fund) return;
            
            fund.autoUpdateSettings = {};
            saveData();
            
            document.getElementById('auto-update-url').value = '';
            document.getElementById('element-code').value = '.price-element';
            document.getElementById('update-time').value = '09:00';
            document.getElementById('update-frequency').value = 'daily';
            document.getElementById('last-auto-update').textContent = lang === 'ar' ? 'آخر تحديث: --' : 'Last Update: --';
            
            showAutoUpdateStatus(lang === 'ar' ? 'تم إيقاف التحديث التلقائي' : 'Auto update stopped', 'success');
        }

        function showAutoUpdateStatus(message, type) {
            const statusEl = document.getElementById('auto-update-status');
            statusEl.textContent = message;
            statusEl.className = `auto-update-status ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        async function testAutoUpdate() {
            const fundId = document.getElementById('auto-update-fund-select').value;
            if (!fundId) {
                showAutoUpdateStatus(lang === 'ar' ? 'الرجاء اختيار صندوق' : 'Please select a fund', 'error');
                return;
            }

            const url = document.getElementById('auto-update-url').value;
            const elementCode = document.getElementById('element-code').value;
            
            if (!url || !elementCode) {
                showAutoUpdateStatus(lang === 'ar' ? 'الرجاء إدخال الرابط وكود العنصر' : 'Please enter URL and element code', 'error');
                return;
            }
            
            showAutoUpdateStatus(lang === 'ar' ? 'جاري جلب البيانات...' : 'Fetching data...', 'info');
            
            try {
                // طرق مختلفة لجلب البيانات
                let price = await fetchPriceWithMultipleMethods(url, elementCode);
                
                if (price) {
                    document.getElementById('price-new').value = price;
                    showAutoUpdateStatus(`${lang === 'ar' ? 'تم العثور على السعر:' : 'Found price:'} ${price}`, 'success');
                    
                    // تحديث السعر الحالي للصندوق
                    const fund = funds.find(f => f.id === fundId);
                    if (fund) {
                        const today = new Date().toISOString().split('T')[0];
                        fund.price = price;
                        
                        // إضافة إلى سجل الأسعار
                        const existing = fund.priceHistory.find(p => p.date === today);
                        if (existing) {
                            existing.price = price;
                        } else {
                            fund.priceHistory.push({ date: today, price });
                        }
                        
                        saveData();
                        renderAll();
                    }
                } else {
                    showAutoUpdateStatus(lang === 'ar' ? 'لم يتم العثور على السعر. جرب كود عنصر مختلف.' : 'Price not found. Try different element code.', 'error');
                }
            } catch (error) {
                console.error('Error fetching price:', error);
                showAutoUpdateStatus(`${lang === 'ar' ? 'خطأ في جلب البيانات:' : 'Error fetching data:'} ${error.message}`, 'error');
            }
        }

        async function fetchPriceWithMultipleMethods(url, elementCode) {
            let price = null;
            
            // الطريقة 1: استخدام CORS Anywhere (يحتاج تفعيل)
            try {
                const corsProxy = 'https://api.allorigins.win/raw?url=';
                const response = await fetch(corsProxy + encodeURIComponent(url), {
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });
                
                if (response.ok) {
                    const html = await response.text();
                    price = extractPriceFromHTML(html, elementCode);
                    if (price) return price;
                }
            } catch (error) {
                console.log('Method 1 failed:', error.message);
            }
            
            // الطريقة 2: استخدام ProxyServer
            try {
                const proxyUrl = 'https://corsproxy.io/?';
                const response = await fetch(proxyUrl + encodeURIComponent(url), {
                    headers: {
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });
                
                if (response.ok) {
                    const html = await response.text();
                    price = extractPriceFromHTML(html, elementCode);
                    if (price) return price;
                }
            } catch (error) {
                console.log('Method 2 failed:', error.message);
            }
            
            // الطريقة 3: استخدام jsonp (للمواقع التي تدعمه)
            try {
                // بعض المواقع تقدم بيانات عبر JSON
                const jsonUrl = url.replace('/fundpage', '/api/fund') + '/price';
                const proxy = 'https://api.allorigins.win/get?url=';
                const response = await fetch(proxy + encodeURIComponent(jsonUrl));
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.contents) {
                        const jsonData = JSON.parse(data.contents);
                        if (jsonData.price) return jsonData.price;
                    }
                }
            } catch (error) {
                console.log('Method 3 failed:', error.message);
            }
            
            return price;
        }

        function extractPriceFromHTML(html, elementCode) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // محاولة العثور على السعر بعدة طرق
            let priceElement = null;
            
            // 1. البحث باستخدام الكود المحدد
            if (elementCode) {
                priceElement = doc.querySelector(elementCode);
            }
            
            // 2. البحث عن أي عنصر يحتوي على "EGP" أو "جنية"
            if (!priceElement) {
                const elements = doc.querySelectorAll('*');
                for (let el of elements) {
                    const text = el.textContent.trim();
                    if ((text.includes('EGP') || text.includes('جنية') || text.includes('جنيه')) && 
                        text.match(/\d+\.?\d*/)) {
                        priceElement = el;
                        break;
                    }
                }
            }
            
            // 3. البحث عن عناصر بها أرقام فقط
            if (!priceElement) {
                const potentialElements = doc.querySelectorAll('.price, .value, .amount, .fund-price, [class*="price"], [id*="price"]');
                for (let el of potentialElements) {
                    const text = el.textContent.trim();
                    if (text.match(/^\d+\.?\d*$/)) {
                        priceElement = el;
                        break;
                    }
                }
            }
            
            if (priceElement) {
                const priceText = priceElement.textContent.trim();
                // استخراج الرقم فقط (يمكن أن يكون 1.448 أو 1,448 إلخ)
                const priceMatch = priceText.match(/(\d+[.,]\d+|\d+)/);
                if (priceMatch) {
                    // استبدال الفاصلة بالنقطة إذا كانت موجودة
                    return priceMatch[0].replace(',', '.');
                }
            }
            
            return null;
        }

        function checkDailyUpdate() {
            const today = new Date().toISOString().split('T')[0];
            
            funds.forEach(fund => {
                if (!fund.autoUpdateSettings || !fund.autoUpdateSettings.enabled) {
                    return;
                }
                
                // التحقق مما إذا تم تحديث السعر اليوم
                const todayPrice = fund.priceHistory.find(p => p.date === today);
                if (!todayPrice && fund.autoUpdateSettings.url && fund.autoUpdateSettings.elementCode) {
                    // لم يتم تحديث السعر اليوم، قم بالتحديث التلقائي
                    performAutoUpdate(fund);
                }
            });
        }

        function setupDailyTimer() {
            if (autoUpdateTimer) {
                clearInterval(autoUpdateTimer);
            }
            
            // حساب الوقت المتبقي للتحديث اليومي
            const now = new Date();
            const updateHour = 9; // 09:00 صباحاً
            
            let updateDate = new Date(now);
            updateDate.setHours(updateHour, 0, 0, 0);
            
            if (now > updateDate) {
                updateDate.setDate(updateDate.getDate() + 1);
            }
            
            const timeUntilUpdate = updateDate.getTime() - now.getTime();
            
            // إعداد المؤقت
            autoUpdateTimer = setTimeout(() => {
                performScheduledUpdates();
                setupDailyTimer(); // إعادة ضبط المؤقت للغد
            }, timeUntilUpdate);
            
            console.log(`Auto update scheduled for: ${updateDate.toLocaleString()}`);
        }

        function performScheduledUpdates() {
            funds.forEach(fund => {
                if (fund.autoUpdateSettings && fund.autoUpdateSettings.enabled) {
                    performAutoUpdate(fund);
                }
            });
        }

        async function performAutoUpdate(fund) {
            if (!fund.autoUpdateSettings || !fund.autoUpdateSettings.url || !fund.autoUpdateSettings.elementCode) {
                return;
            }
            
            try {
                console.log(`Performing auto update for ${fund.code}...`);
                
                const url = fund.autoUpdateSettings.url;
                const elementCode = fund.autoUpdateSettings.elementCode;
                const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
                
                const response = await fetch(proxyUrl + url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const priceElement = doc.querySelector(elementCode);
                
                if (priceElement) {
                    const priceText = priceElement.textContent.trim();
                    const priceMatch = priceText.match(/(\d+\.?\d*)/);
                    
                    if (priceMatch) {
                        const price = priceMatch[0];
                        const today = new Date().toISOString().split('T')[0];
                        
                        fund.price = price;
                        
                        const existing = fund.priceHistory.find(p => p.date === today);
                        if (existing) {
                            existing.price = price;
                        } else {
                            fund.priceHistory.push({ date: today, price });
                        }
                        
                        fund.autoUpdateSettings.lastUpdate = new Date().toISOString();
                        saveData();
                        renderAll();
                        
                        console.log(`Auto update completed for ${fund.code}: ${price}`);
                    }
                }
            } catch (error) {
                console.error(`Auto update failed for ${fund.code}:`, error);
            }
        }

        // ============ EXPORT FUNCTIONS ============
        function exportPricesPDF() {
            const fund = getCurrentFund();
            if (!fund) {
                alert(lang === 'ar' ? 'اختر صندوق أولاً' : 'Select a fund first');
                return;
            }

            const sorted = [...fund.priceHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = `
                <div style="padding: 20px; font-family: 'Cairo', Arial, sans-serif; direction: rtl;">
                    <div style="text-align: center; border-bottom: 3px solid #022C43; padding-bottom: 20px; margin-bottom: 30px;">
                        <h1 style="color: #022C43; margin: 0;">
                            ${lang === 'ar' ? 'قاعدة بيانات الأسعار' : 'Prices Database'}
                        </h1>
                        <h2 style="color: #064566; margin: 10px 0;">
                            ${fund.name} (${fund.code})
                        </h2>
                    </div>
                    
                    <div style="margin-bottom: 25px; background: #f8f9fa; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div style="text-align: center;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">${lang === 'ar' ? 'عدد الأسعار' : 'Prices Count'}</div>
                                <div style="font-size: 24px; font-weight: bold; color: #022C43;">${sorted.length}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">${lang === 'ar' ? 'أحدث سعر' : 'Latest Price'}</div>
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${fund.price}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">${lang === 'ar' ? 'تاريخ التصدير' : 'Export Date'}</div>
                                <div style="font-size: 16px; color: #115173; font-weight: 600;">${new Date().toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US')}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">${lang === 'ar' ? 'وقت التصدير' : 'Export Time'}</div>
                                <div style="font-size: 16px; color: #115173; font-weight: 600;">${new Date().toLocaleTimeString(lang === 'ar' ? 'ar-EG' : 'en-US')}</div>
                            </div>
                        </div>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #022C43 0%, #053F5E 100%); color: white;">
                                <th style="padding: 15px; border: 1px solid #0A5A85; text-align: right; font-weight: 600; font-size: 14px;">${lang === 'ar' ? 'التاريخ' : 'Date'}</th>
                                <th style="padding: 15px; border: 1px solid #0A5A85; text-align: right; font-weight: 600; font-size: 14px;">${lang === 'ar' ? 'السعر' : 'Price'}</th>
                                <th style="padding: 15px; border: 1px solid #0A5A85; text-align: right; font-weight: 600; font-size: 14px;">${lang === 'ar' ? 'التغير %' : 'Change %'}</th>
                                <th style="padding: 15px; border: 1px solid #0A5A85; text-align: right; font-weight: 600; font-size: 14px;">${lang === 'ar' ? 'الحالة' : 'Status'}</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sorted.forEach((entry, idx) => {
                const prev = idx < sorted.length - 1 ? parseFloat(sorted[idx + 1].price) : parseFloat(entry.price);
                const current = parseFloat(entry.price);
                const change = ((current - prev) / prev) * 100;
                const statusIcon = change > 0.1 ? '↑' : change < -0.1 ? '↓' : '→';
                const statusText = change > 0.1 ? lang === 'ar' ? 'ارتفاع' : 'Up' : change < -0.1 ? lang === 'ar' ? 'انخفاض' : 'Down' : lang === 'ar' ? 'مستقر' : 'Stable';
                const changeColor = change >= 0 ? '#28a745' : '#dc3545';
                const rowBg = idx % 2 === 0 ? '#FFFFFF' : '#F8FAFC';
                
                html += `
                    <tr style="background: ${rowBg};">
                        <td style="padding: 12px 15px; border: 1px solid #E1E8F0; font-size: 13px; color: #022C43; font-weight: 500;">${entry.date}</td>
                        <td style="padding: 12px 15px; border: 1px solid #E1E8F0; font-size: 13px; color: #064566; font-family: 'Courier New', monospace; font-weight: 600;">${entry.price}</td>
                        <td style="padding: 12px 15px; border: 1px solid #E1E8F0; font-size: 13px; color: ${changeColor}; font-family: 'Courier New', monospace; font-weight: 600;">${change >= 0 ? '+' : ''}${change.toFixed(4)}%</td>
                        <td style="padding: 12px 15px; border: 1px solid #E1E8F0; font-size: 13px; color: ${changeColor}; font-weight: 600;">
                            <span style="display: inline-block; padding: 4px 10px; background: ${changeColor}15; border-radius: 4px;">${statusIcon} ${statusText}</span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #022C43; text-align: center;">
                        <p style="font-size: 12px; color: #666; margin: 5px 0;">
                            ${lang === 'ar' ? 'تم إنشاء هذا التقرير بواسطة ان - دار استثمار' : 'Generated by InDar Tracker'}
                        </p>
                        <p style="font-size: 11px; color: #999; margin: 5px 0;">
                            ${new Date().toLocaleString(lang === 'ar' ? 'ar-EG' : 'en-US')}
                        </p>
                    </div>
                </div>
            `;
            
            const element = document.createElement('div');
            element.innerHTML = html;
            
            const opt = {
                margin: 10,
                filename: `prices-database-${fund.code}-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    backgroundColor: '#fff',
                    width: 1200,
                    useCORS: true 
                },
                jsPDF: { 
                    orientation: 'landscape',
                    unit: 'mm', 
                    format: 'a4',
                    compress: true
                }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        function exportGeneralInfoPDF() {
            let html = `
                <div style="padding: 25px; font-family: 'Cairo', Arial, sans-serif; direction: rtl;">
                    <div style="text-align: center; border-bottom: 3px solid #022C43; padding-bottom: 25px; margin-bottom: 30px;">
                        <h1 style="color: #022C43; margin: 0; font-size: 28px;">
                            ${lang === 'ar' ? 'تقرير معلومات عامة' : 'General Information Report'}
                        </h1>
                        <h2 style="color: #064566; margin: 10px 0; font-size: 20px;">
                            ${lang === 'ar' ? 'جميع الصناديق' : 'All Funds'}
                        </h2>
                        <p style="color: #115173; font-size: 14px;">
                            ${new Date().toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US')}
                        </p>
                    </div>
                    
                    <div style="margin-bottom: 30px; background: linear-gradient(135deg, #F8FAFC 0%, #EFF3F6 100%); padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                        <h3 style="color: #022C43; margin-bottom: 20px; font-size: 18px; padding-bottom: 10px; border-bottom: 2px solid #022C43;">
                            ${lang === 'ar' ? 'إجماليات الصناديق' : 'Funds Totals'}
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; text-align: center;">
                            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                <div style="font-size: 13px; color: #666; margin-bottom: 8px;">${lang === 'ar' ? 'إجمالي المبلغ المدفوع' : 'Total Amount Paid'}</div>
                                <div style="font-size: 24px; font-weight: bold; color: #022C43;">${document.getElementById('total-paid-all').textContent}</div>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                <div style="font-size: 13px; color: #666; margin-bottom: 8px;">${lang === 'ar' ? 'إجمالي الربح المحتمل' : 'Total Potential Profit'}</div>
                                <div style="font-size: 24px; font-weight: bold; color: #28a745;">${document.getElementById('total-profit-all').textContent}</div>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                <div style="font-size: 13px; color: #666; margin-bottom: 8px;">${lang === 'ar' ? 'إجمالي الربح/الخسارة' : 'Total Profit/Loss'}</div>
                                <div style="font-size: 24px; font-weight: bold; color: #17a2b8;">${document.getElementById('total-pl-all').textContent}</div>
                            </div>
                            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                <div style="font-size: 13px; color: #666; margin-bottom: 8px;">${lang === 'ar' ? 'إجمالي الوثائق' : 'Total Units'}</div>
                                <div style="font-size: 24px; font-weight: bold; color: #115173;">${document.getElementById('total-units-all').textContent}</div>
                            </div>
                        </div>
                    </div>
                    
                    <h3 style="color: #022C43; margin-bottom: 15px; font-size: 18px; padding-bottom: 10px; border-bottom: 2px solid #022C43;">
                        ${lang === 'ar' ? 'تفاصيل الصناديق' : 'Funds Details'}
                    </h3>
                    <div style="overflow-x: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-radius: 10px;">
                        <table style="width: 100%; border-collapse: collapse; min-width: 1200px; background: white;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #022C43 0%, #053F5E 100%); color: white;">
                                    <th style="padding: 15px; border: 1px solid #0A5A85; text-align: right; font-weight: 600; font-size: 14px;">${lang === 'ar' ? 'اسم الصندوق' : 'Fund Name'}</th>
                                    <th style="padding: 15px; border: 1px solid #0A5A85; text-align: right; font-weight: 600; font-size: 14px;">${lang === 'ar' ? 'الوثائق' : 'Units'}</th>
                                    <th style="padding: 15px; border: 1px solid #0A5A85; text-align: right; font-weight: 600; font-size: 14px;">${lang === 'ar' ? 'إجمالي الاستثمار' : 'Total Investment'}</th>
                                    <th style="padding: 15px; border: 1px solid #0A5A85; text-align: right; font-weight: 600; font-size: 14px;">${lang === 'ar' ? 'الربح بعد رسوم الاسترداد' : 'Profit After Redemption Fees'}</th>
                                    <th style="padding: 15px; border: 1px solid #0A5A85; text-align: right; font-weight: 600; font-size: 14px;">${lang === 'ar' ? 'متوسط الشراء' : 'Avg Buy'}</th>
                                    <th style="padding: 15px; border: 1px solid #0A5A85; text-align: right; font-weight: 600; font-size: 14px;">${lang === 'ar' ? 'القيمة الحالية' : 'Current Value'}</th>
                                    <th style="padding: 15px; border: 1px solid #0A5A85; text-align: right; font-weight: 600; font-size: 14px;">${lang === 'ar' ? 'العائد %' : 'Return %'}</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            const rows = document.querySelectorAll('#funds-details-table tr');
            rows.forEach((row, index) => {
                const cells = row.querySelectorAll('td');
                if (cells.length > 0) {
                    const rowBg = index % 2 === 0 ? '#FFFFFF' : '#F8FAFC';
                    html += `<tr style="background: ${rowBg};">`;
                    cells.forEach((cell, index) => {
                        let cellColor = '#333';
                        let cellFontSize = '13px';
                        
                        if (index === 0) {
                            cellColor = '#022C43';
                            cellFontSize = '14px';
                            cellFontWeight = '600';
                        } else if (index === cells.length - 1) {
                            const cellValue = parseFloat(cell.textContent);
                            cellColor = cellValue >= 0 ? '#28a745' : '#dc3545';
                            cellFontWeight = '600';
                        } else if (index === 2 || index === 3 || index === 5) {
                            cellColor = '#064566';
                            cellFontWeight = '500';
                        }
                        
                        html += `<td style="padding: 12px 15px; border: 1px solid #E1E8F0; color: ${cellColor}; font-size: ${cellFontSize}; font-weight: ${cellFontWeight || '400'};">${cell.textContent}</td>`;
                    });
                    html += '</tr>';
                }
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 40px; padding: 25px; background: linear-gradient(135deg, #F8FAFC 0%, #EFF3F6 100%); border-radius: 12px; text-align: center;">
                        <p style="font-size: 14px; color: #022C43; margin: 10px 0; font-weight: 600;">
                            ${lang === 'ar' ? 'ملخص الأداء' : 'Performance Summary'}
                        </p>
                        <p style="font-size: 12px; color: #666; margin: 5px 0; line-height: 1.6;">
                            ${lang === 'ar' ? 'يشمل هذا التقرير تحليلاً شاملاً لأداء جميع الصناديق مع مراعاة الرسوم والتكاليف' : 'This report includes comprehensive analysis of all funds performance including fees and costs'}
                        </p>
                    </div>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #022C43; text-align: center;">
                        <p style="font-size: 12px; color: #666; margin: 5px 0;">
                            ${lang === 'ar' ? 'تم إنشاء هذا التقرير بواسطة ان - دار استثمار' : 'Generated by InDar Tracker'}
                        </p>
                        <p style="font-size: 11px; color: #999; margin: 5px 0;">
                            ${new Date().toLocaleString(lang === 'ar' ? 'ar-EG' : 'en-US')}
                        </p>
                    </div>
                </div>
            `;
            
            const element = document.createElement('div');
            element.innerHTML = html;
            
            const opt = {
                margin: 10,
                filename: `general-info-report-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    backgroundColor: '#fff',
                    width: 1200,
                    useCORS: true 
                },
                jsPDF: { 
                    orientation: 'landscape',
                    unit: 'mm', 
                    format: 'a4',
                    compress: true
                }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        function exportPricesJSON() {
            const fund = getCurrentFund();
            if (!fund) {
                alert(lang === 'ar' ? 'اختر صندوق أولاً' : 'Select a fund first');
                return;
            }

            const data = {
                fund: {
                    name: fund.name,
                    code: fund.code,
                    prices: fund.priceHistory
                },
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            downloadFile(JSON.stringify(data, null, 2), `prices-${fund.code}-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ============ CHARTS ============
        function destroyChart(chartId) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
                delete chartInstances[chartId];
            }
        }

        function createPriceChart() {
            const fund = getCurrentFund();
            if (!fund || !fund.priceHistory) return;

            destroyChart('priceChart');
            const sorted = [...fund.priceHistory].sort((a, b) => new Date(a.date) - new Date(b.date));
            const ctx = document.getElementById('priceChart');
            if (!ctx) return;

            // استخدام الألوان الجديدة في الرسم البياني
            const chartColors = {
                line: getComputedStyle(document.documentElement).getPropertyValue('--chart-line').trim() || '#022C43',
                area: getComputedStyle(document.documentElement).getPropertyValue('--chart-area').trim() || 'rgba(2, 44, 67, 0.1)',
                point: getComputedStyle(document.documentElement).getPropertyValue('--chart-point').trim() || '#FFD700',
                grid: getComputedStyle(document.documentElement).getPropertyValue('--chart-grid').trim() || 'rgba(2, 44, 67, 0.1)'
            };

            chartInstances['priceChart'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map((p, i) => i % 2 === 0 ? new Date(p.date).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US') : ''),
                    datasets: [{
                        label: fund.name,
                        data: sorted.map(p => parseFloat(p.price)),
                        borderColor: chartColors.line,
                        backgroundColor: chartColors.area,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: chartColors.point,
                        pointBorderColor: chartColors.line,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            labels: { 
                                color: theme === 'dark' ? '#e0e0e0' : '#333', 
                                font: { size: 13 } 
                            } 
                        } 
                    },
                    scales: { 
                        y: { 
                            beginAtZero: false,
                            ticks: {
                                color: theme === 'dark' ? '#e0e0e0' : '#666'
                            },
                            grid: {
                                color: chartColors.grid
                            }
                        }, 
                        x: { 
                            grid: { 
                                display: false 
                            },
                            ticks: {
                                color: theme === 'dark' ? '#e0e0e0' : '#666'
                            }
                        } 
                    }
                }
            });
        }

        function createPortfolioChart() {
            destroyChart('portfolioChart');
            
            // استخدام الألوان الجديدة
            const colorPalette = [
                '#022C43', // الأزرق الداكن
                '#064566', // الأزرق المتوسط
                '#053F5E', // Secondary
                '#115173', // Tertiary
                '#FFD700', // الذهبي
                '#28a745'  // الأخضر
            ];
            
            const data = funds.map(f => {
                const m = calculateMetrics(f);
                return m.value;
            });

            const ctx = document.getElementById('portfolioChart');
            if (!ctx) return;

            chartInstances['portfolioChart'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: funds.map(f => f.code),
                    datasets: [{
                        data: data,
                        backgroundColor: colorPalette.slice(0, funds.length),
                        borderColor: theme === 'dark' ? '#112240' : 'white',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            position: 'bottom', 
                            labels: { 
                                color: theme === 'dark' ? '#e0e0e0' : '#333', 
                                font: { size: 12 } 
                            } 
                        } 
                    }
                }
            });
        }

        function createMonthlyChart() {
            destroyChart('monthlyChart');
            const monthlyData = {};

            funds.forEach(fund => {
                fund.transactions.forEach(tx => {
                    const date = new Date(tx.date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyData[monthKey]) monthlyData[monthKey] = 0;
                    const amount = parseFloat(tx.units) * parseFloat(tx.price);
                    monthlyData[monthKey] += amount;
                });
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const ctx = document.getElementById('monthlyChart');
            if (!ctx) return;

            chartInstances['monthlyChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: lang === 'ar' ? 'المعاملات الشهرية' : 'Monthly Transactions',
                        data: sortedMonths.map(m => monthlyData[m]),
                        backgroundColor: '#022C43',
                        borderColor: '#064566',
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: {
                                color: theme === 'dark' ? '#e0e0e0' : '#666'
                            }
                        },
                        x: {
                            ticks: {
                                color: theme === 'dark' ? '#e0e0e0' : '#666'
                            }
                        }
                    }
                }
            });
        }

        function createReturnChart() {
            destroyChart('returnChart');
            const fundReturns = funds.map(fund => {
                const m = calculateMetrics(fund);
                return m.returnPct;
            });

            const ctx = document.getElementById('returnChart');
            if (!ctx) return;

            chartInstances['returnChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: funds.map(f => f.code),
                    datasets: [{
                        label: lang === 'ar' ? 'العائد %' : 'Return %',
                        data: fundReturns,
                        backgroundColor: fundReturns.map(r => r >= 0 ? '#28a745' : '#dc3545'),
                        borderWidth: 1,
                        borderRadius: 8
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: {
                                color: theme === 'dark' ? '#e0e0e0' : '#666'
                            }
                        },
                        x: {
                            ticks: {
                                color: theme === 'dark' ? '#e0e0e0' : '#666'
                            }
                        }
                    }
                }
            });
        }

        function updateStatistics() {
            const totalTx = funds.reduce((sum, f) => sum + f.transactions.length, 0);
            let best = { code: '--', value: -999 };
            let worst = { code: '--', value: 999 };

            funds.forEach(f => {
                const m = calculateMetrics(f);
                if (m.returnPct > best.value) best = { code: f.code, value: m.returnPct };
                if (m.returnPct < worst.value) worst = { code: f.code, value: m.returnPct };
            });

            document.getElementById('stats-funds').textContent = funds.length;
            document.getElementById('stats-transactions').textContent = totalTx;
            document.getElementById('stats-best').textContent = best.value === -999 ? '--' : `${best.code} (${formatDisplay(best.value)}%)`;
            document.getElementById('stats-worst').textContent = worst.value === 999 ? '--' : `${worst.code} (${formatDisplay(worst.value)}%)`;
        }

        function updateAllCharts() {
            createPriceChart();
            createPortfolioChart();
            createMonthlyChart();
            createReturnChart();
            updateStatistics();
        }

        // ============ EXPORT/IMPORT ============
        function exportJSON() {
            const data = { funds, timestamp: new Date().toISOString() };
            downloadFile(JSON.stringify(data, null, 2), `investment-backup-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
        }

        function exportCSV() {
            let csv = lang === 'ar' ? 'الصندوق,الكود,التاريخ,النوع,الوثائق,السعر,المبلغ\n' : 'Fund,Code,Date,Type,Units,Price,Amount\n';
            funds.forEach(f => {
                f.transactions.forEach(tx => {
                    const amount = parseFloat(tx.units) * parseFloat(tx.price);
                    csv += `"${f.name}","${f.code}","${tx.date}","${tx.type === 'buy' ? labels[lang].buy : labels[lang].sell}","${tx.units}","${formatDisplay(tx.price, true)}","${formatCurrency(amount)}"\n`;
                });
            });
            downloadFile(csv, `investment-backup-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        }

        function exportPDF() {
            const fund = getCurrentFund();
            if (!fund) {
                alert(lang === 'ar' ? 'اختر صندوق أولاً' : 'Select a fund first');
                return;
            }

            const m = calculateMetrics(fund);
            const html = `
<!DOCTYPE html>
<html lang="${lang}">
<head>
    <meta charset="UTF-8">
    <title>${lang === 'ar' ? 'تقرير الاستثمار' : 'Investment Report'}</title>
    <style>
        body { font-family: 'Cairo', Arial, sans-serif; direction: rtl; background: #f8f9fa; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .header { text-align: center; border-bottom: 3px solid #022C43; padding-bottom: 20px; margin-bottom: 30px; }
        .header h1 { color: #022C43; margin: 0; font-size: 28px; }
        .header h2 { color: #064566; margin: 10px 0; font-size: 20px; }
        .metrics { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
        .metric { background: linear-gradient(135deg, #F8FAFC 0%, #EFF3F6 100%); padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .metric-label { font-size: 13px; color: #666; margin-bottom: 8px; font-weight: 500; }
        .metric-value { font-size: 24px; font-weight: bold; color: #022C43; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        th { background: linear-gradient(135deg, #022C43 0%, #053F5E 100%); color: white; padding: 15px; text-align: right; font-weight: 600; border: 1px solid #0A5A85; }
        td { padding: 12px 15px; border-bottom: 1px solid #E1E8F0; text-align: right; }
        .section-title { font-size: 18px; font-weight: bold; color: #022C43; margin-top: 30px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #022C43; }
        .footer { text-align: center; margin-top: 40px; color: #999; font-size: 12px; padding-top: 20px; border-top: 2px solid #022C43; }
        .positive { color: #28a745 !important; font-weight: 600 !important; }
        .negative { color: #dc3545 !important; font-weight: 600 !important; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>${lang === 'ar' ? 'تقرير الاستثمار' : 'Investment Report'}</h1>
            <h2>${fund.name} (${fund.code})</h2>
        </div>

        <div class="metrics">
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'إجمالي الوثائق' : 'Total Units'}</div>
                <div class="metric-value">${m.units}</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'متوسط الشراء' : 'Avg Buy'}</div>
                <div class="metric-value">${formatDisplay(m.avgPrice, true)}</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'السعر الحالي' : 'Current Price'}</div>
                <div class="metric-value">${formatDisplay(fund.price, true)}</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'القيمة الحالية' : 'Current Value'}</div>
                <div class="metric-value">${formatCurrency(m.value)}</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'إجمالي الاستثمار' : 'Total Invested'}</div>
                <div class="metric-value">${formatCurrency(m.invested)}</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'الربح/الخسارة' : 'Profit/Loss'}</div>
                <div class="metric-value ${m.profitAfterFees >= 0 ? 'positive' : 'negative'}">${formatCurrency(m.profitAfterFees)}</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'العائد %' : 'Return %'}</div>
                <div class="metric-value ${m.returnPct >= 0 ? 'positive' : 'negative'}">${formatDisplay(m.returnPct)}%</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'تاريخ الإنشاء' : 'Export Date'}</div>
                <div class="metric-value">${new Date().toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US')}</div>
            </div>
        </div>

        <div class="section-title">${lang === 'ar' ? 'المعاملات' : 'Transactions'}</div>
        <table>
            <thead>
                <tr>
                    <th>${lang === 'ar' ? 'التاريخ' : 'Date'}</th>
                    <th>${lang === 'ar' ? 'النوع' : 'Type'}</th>
                    <th>${lang === 'ar' ? 'الوثائق' : 'Units'}</th>
                    <th>${lang === 'ar' ? 'السعر' : 'Price'}</th>
                    <th>${lang === 'ar' ? 'المبلغ' : 'Amount'}</th>
                </tr>
            </thead>
            <tbody>
                ${fund.transactions.map(tx => {
                    const amount = parseFloat(tx.units) * parseFloat(tx.price);
                    return `<tr>
                        <td>${tx.date}</td>
                        <td>${tx.type === 'buy' ? labels[lang].buy : labels[lang].sell}</td>
                        <td>${tx.units}</td>
                        <td style="font-family: 'Courier New', monospace; font-weight: 500;">${formatDisplay(tx.price, true)}</td>
                        <td>${formatCurrency(amount)}</td>
                    </tr>`;
                }).join('')}
            </tbody>
        </table>

        <div class="footer">
            <p>${lang === 'ar' ? 'تم إنشاء هذا التقرير بواسطة ان - دار استثمار' : 'Generated by InDar Tracker'}</p>
            <p>${new Date().toLocaleString(lang === 'ar' ? 'ar-EG' : 'en-US')}</p>
        </div>
    </div>
</body>
</html>
            `;

            const element = document.createElement('div');
            element.innerHTML = html;
            const opt = {
                margin: 10,
                filename: `investment-report-${fund.code}-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    backgroundColor: '#fff',
                    width: 800,
                    useCORS: true 
                },
                jsPDF: { 
                    orientation: 'portrait', 
                    unit: 'mm', 
                    format: 'a4',
                    compress: true
                }
            };
            html2pdf().set(opt).from(element).save();
        }

        function importFile() {
            const file = document.getElementById('import-file').files[0];
            if (!file) {
                alert(lang === 'ar' ? 'اختر ملف أولاً' : 'Choose a file first');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    funds = data.funds || [];
                    currentFundId = funds[0]?.id;
                    saveData();
                    renderAll();
                    alert(lang === 'ar' ? 'تم الاستيراد بنجاح' : 'Imported successfully');
                    document.getElementById('import-file').value = '';
                } catch (err) {
                    alert(lang === 'ar' ? 'خطأ في الملف' : 'File error');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (!confirm(lang === 'ar' ? 'هل تريد حذف جميع البيانات؟' : 'Delete all data?')) return;
            funds = [];
            currentFundId = null;
            saveData();
            renderAll();
        }

        // ============ DATA ============
        function saveData() {
            localStorage.setItem('investment_app', JSON.stringify({ funds, currentFundId }));
        }

        function loadData() {
            const data = JSON.parse(localStorage.getItem('investment_app') || '{"funds":[],"currentFundId":null}');
            funds = data.funds || [];
            currentFundId = data.currentFundId || funds[0]?.id;
            
            if (funds.length === 0) {
                funds = [{
                    id: '1',
                    name: lang === 'ar' ? 'صندوق عزيموت' : 'Azimut Fund',
                    code: 'AZM',
                    price: '1.42',
                    subscriptionFee: 1,
                    redemptionFee: 2,
                    transactions: [
                        { date: '2025-11-01', type: 'buy', units: '100', price: '1.35' },
                        { date: '2025-11-15', type: 'buy', units: '50', price: '1.40' },
                        { date: '2025-12-01', type: 'sell', units: '30', price: '1.45' }
                    ],
                    priceHistory: [
                        { date: '2025-10-31', price: '1.35' },
                        { date: '2025-11-02', price: '1.37' },
                        { date: '2025-11-04', price: '1.38' },
                        { date: '2025-11-06', price: '1.3533' },
                        { date: '2025-11-08', price: '1.454545' },
                        { date: '2025-11-10', price: '1.41' },
                        { date: '2025-11-12', price: '1.40' },
                        { date: '2025-11-14', price: '1.43' },
                        { date: '2025-11-16', price: '1.43' },
                        { date: '2025-11-18', price: '1.45' },
                        { date: '2025-11-20', price: '1.44' },
                        { date: '2025-11-22', price: '1.44' },
                        { date: '2025-11-24', price: '1.44' },
                        { date: '2025-11-26', price: '1.41' },
                        { date: '2025-11-28', price: '1.42' }
                    ],
                    autoUpdateSettings: {}
                }];
                currentFundId = '1';
                saveData();
            }
        }

        // ============ HELPERS ============
        function getCurrentFund() {
            return funds.find(f => f.id === currentFundId);
        }

        function renderAll() {
            renderFundSelector();
            updatePortfolio();
            renderTransactionsTable();
            renderFundsTable();
            updateAdvancedAnalytics();
            updateGeneralInfo();
            updateBackupInfo();
            updateTranslations();
            updateAutoUpdateFundSelector();
            if (currentFundId) {
                updateAllCharts();
            }
        }

        function updateBackupInfo() {
            let totalTx = 0;
            funds.forEach(f => totalTx += f.transactions.length);
            document.getElementById('info-funds').textContent = funds.length;
            document.getElementById('info-transactions').textContent = totalTx;
            document.getElementById('info-updated').textContent = new Date().toLocaleString(lang === 'ar' ? 'ar-EG' : 'en-US');
        }

        // ============ START ============
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>