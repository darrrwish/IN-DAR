<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InDar Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
        }

        .nav-item.top-section {
            margin-top: 0;
        }

        .nav-item.theme-btn {
            margin-top: auto;
            order: 1;
        }

        .nav-item.lang-btn {
            order: 2;
        }

        .nav-item.add-btn {
            order: 3;
        }

        :root {
            /* ألوان جديدة - Light Mode */
            --primary: #000B58;
            --primary-light: #003161;
            --primary-dark: #000830;
            --accent: #b9a6ff;
            --secondary: #006A67;
            --secondary-light: #007B7A;
            --secondary-dark: #005956;
            --tertiary: #00509E;
            --background: #FFFFFF;
            --surface: #F5F7FA;
            --on-background: #1A1A1A;
            --on-surface: #333333;
            --border: #E0E0E0;
            --success: #006A67;
            --danger: #D32F2F;
            --warning: #F57C00;
            --info: #00509E;
        }

        /* Dark Mode */
        body[data-theme="dark"] {
            --primary: #3A6BFF;
            --primary-light: #5A85FF;
            --primary-dark: #1A4BD6;
            --accent: #150b3a;
            --secondary: #00B3AD;
            --secondary-light: #00CCC6;
            --secondary-dark: #009A94;
            --tertiary: #4A7FFF;
            --background: #0A0A1A;
            --surface: #14142E;
            --on-background: #E6E6FF;
            --on-surface: #D0D0FF;
            --border: #303050;
            --success: #00B3AD;
            --danger: #FF5252;
            --warning: #FFB74D;
            --info: #4A7FFF;
        }

        html {
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            scroll-behavior: smooth;
        }

        body {
            background: var(--background);
            color: var(--on-background);
            transition: all 0.4s ease;
            line-height: 1.6;
        }

        body[data-theme="dark"] {
            background: var(--background);
            color: var(--on-background);
        }

        /* Sidebar Navigation - Icons Only */
        .sidebar {
            width: 70px;
            background: var(--surface);
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            position: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 0;
            z-index: 200;
            right: 0;
        }

        body[data-theme="dark"] .sidebar {
            background: var(--surface);
            box-shadow: 2px 0 8px rgba(0,0,0,0.3);
        }

        .nav-logo {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--tertiary) 100%);
            color: white;
            font-size: 24px;
        }

        .nav-item {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border-radius: 10px;
            margin: 6px 0;
            transition: all 0.3s ease;
            font-size: 20px;
            color: var(--on-surface);
            position: relative;
        }

        .nav-item:hover {
            background: var(--primary-light);
            color: white;
            transform: scale(1.1);
        }

        .nav-item.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 11, 88, 0.3);
        }

        .nav-separator {
            width: 30px;
            height: 1px;
            background: var(--border);
            margin: 10px 0;
        }

        body[data-theme="dark"] .nav-separator {
            background: var(--border);
        }

        .nav-item.top-section {
            margin-top: auto;
        }

        /* Main Content */
        .main-content {
            margin-right: 70px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        .header {
            background: var(--surface);
            border-bottom: 3px solid var(--primary);
            padding: 16px 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        body[data-theme="dark"] .header {
            background: var(--surface);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header-left h1 {
            font-size: 24px;
            color: var(--primary);
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        body[data-theme="dark"] .header-left h1 {
            color: var(--primary-light);
        }

        .header-left p {
            font-size: 13px;
            color: var(--primary);
            margin-top: 4px;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .fund-selector {
            padding: 10px 12px;
            border: 2px solid var(--primary);
            border-radius: 8px;
            font-family: Cairo;
            font-size: 13px;
            min-width: 200px;
            background: var(--surface);
            color: var(--on-surface);
            cursor: pointer;
        }

        body[data-theme="dark"] .fund-selector {
            background: var(--surface);
            color: var(--on-surface);
            border-color: var(--primary);
        }

        /* Content Area */
        .content-wrapper {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card */
        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        body[data-theme="dark"] .card {
            background: var(--surface);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body[data-theme="dark"] .card-title {
            color: var(--primary-light);
        }

        /* Grid */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        @media (max-width: 1024px) {
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
            .grid-3 { grid-template-columns: repeat(2, 1fr); }
            .grid-2 { grid-template-columns: 1fr; }
        }

        @media (max-width: 1024px) {
            .header-controls { gap: 8px; flex-wrap: wrap; }
            .fund-selector { min-width: 160px; }
        }

        @media (max-width: 768px) {
            .sidebar { width: 60px; }
            .nav-item { width: 45px; height: 45px; font-size: 18px; }
            .nav-logo { width: 45px; height: 45px; font-size: 20px; }
            .main-content { margin-right: 60px; }
            .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
            .content-wrapper { padding: 12px; }
            .header { padding: 12px 16px; }
            .header-left h1 { font-size: 18px; }
            .header-left p { font-size: 12px; }
            .fund-selector { min-width: 120px; font-size: 11px; }
            .card { padding: 14px; margin-bottom: 12px; }
            .card-title { font-size: 14px; }
            .metric-box { padding: 12px; }
            .metric-label { font-size: 11px; }
            .metric-value { font-size: 20px; }
            .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            table { min-width: 800px; font-size: 11px; }
        }

        @media (max-width: 480px) {
            .sidebar { width: 55px; padding: 10px 0; }
            .nav-item { width: 40px; height: 40px; font-size: 16px; margin: 4px 0; }
            .nav-logo { width: 40px; height: 40px; font-size: 18px; margin-bottom: 5px; }
            .main-content { margin-right: 55px; }
            .content-wrapper { padding: 8px; }
            .header { padding: 8px 12px; }
            .header-left h1 { font-size: 16px; gap: 6px; }
            .header-left p { font-size: 11px; }
            .header-controls { gap: 4px; }
            .fund-selector { min-width: 100px; font-size: 10px; padding: 8px 10px; }
            .card { padding: 10px; margin-bottom: 10px; }
            .card-title { font-size: 13px; margin-bottom: 10px; }
            .btn { padding: 8px 12px; font-size: 12px; }
            .btn-group { gap: 6px; }
            .metric-box { padding: 10px; }
            .metric-label { font-size: 10px; margin-bottom: 3px; }
            .metric-value { font-size: 18px; }
            .recommendation-box { padding: 10px 12px; }
            .recommendation-action { font-size: 14px; margin-bottom: 4px; }
            table { font-size: 10px; min-width: 700px; }
            th, td { padding: 8px; }
            .form-group label { font-size: 12px; }
            .form-group input, .form-group select { padding: 8px 10px; font-size: 13px; }
            .modal-content { padding: 16px; }
            .chart-container { height: 250px; }
        }

        /* تثبيت اتجاه الجداول */
        .table-responsive table {
            direction: rtl;
        }
        
        th, td {
            text-align: right !important;
            white-space: nowrap;
        }

        /* Metric Box */
        .metric-box {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .metric-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 6px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            word-break: break-word;
        }

        /* Recommendation Box */
        .recommendation-box {
            background: linear-gradient(135deg, var(--accent) 20%, #006a6740 100%);
            color: var(--on-background);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            /* box-shadow: 0 4px 12px rgba(253, 235, 158, 0.2); */
            border: 2px solid var(--accent);
        }

        body[data-theme="dark"] .recommendation-box {
            background: linear-gradient(135deg, var(--accent) 20%, #2a1919 100%);
            color: var(--on-surface);
        }

        .recommendation-action {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--primary);
        }

        .recommendation-strategy {
            font-size: 14px;
            margin: 15px 0;
            line-height: 1.6;
            color: var(--on-surface);
        }

        .recommendation-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .recommendation-actions .btn {
            font-size: 12px;
            padding: 8px 15px;
            background: var(--primary);
            color: white;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }

        .recommendation-confidence {
            font-size: 12px;
            opacity: 0.75;
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--on-surface);
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 320px;
            margin-bottom: 16px;
        }

        /* Table */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 16px;
            border-radius: 10px;
            background: var(--surface);
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        body[data-theme="dark"] .table-responsive {
            background: var(--surface);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        table {
            width: 100%;
            min-width: 100%;
            border-collapse: collapse;
            table-layout: auto;
            font-size: 13.5px;
            background: transparent;
        }

        th, td {
            padding: 9px 10px !important;
            text-align: right !important;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            border-bottom: 1px solid var(--border);
        }

        th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 13.5px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            background: var(--surface);
            font-size: 13px;
            color: var(--on-surface);
        }

        tr:hover td {
            background-color: rgba(0, 11, 88, 0.05);
        }

        body[data-theme="dark"] tr:hover td {
            background-color: rgba(58, 107, 255, 0.1);
        }

        /* Table colors */
        .positive {
            color: var(--success);
            font-weight: 600;
        }

        .negative {
            color: var(--danger);
            font-weight: 600;
        }

        /* Form */
        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--on-surface);
            font-size: 13px;
            display: block;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Cairo', sans-serif;
            background: var(--surface);
            color: var(--on-surface);
        }

        /* Button */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            font-family: 'Cairo', sans-serif;
            font-weight: 500;
        }

        .btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn.secondary {
            background: var(--secondary);
            color: white;
        }

        .btn.accent {
            background: var(--accent);
            color: var(--primary-dark);
        }

        .btn.danger {
            background: var(--danger);
            color: white;
        }

        .btn.success {
            background: var(--success);
            color: white;
        }

        .btn.warning {
            background: var(--warning);
            color: white;
        }

        .btn.info {
            background: var(--info);
            color: white;
        }

        .btn.small {
            padding: 6px 10px;
            font-size: 11px;
        }

        .btn-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* Holding period badge */
        .holding-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(0, 11, 88, 0.1);
            color: var(--primary);
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 500;
        }

        /* Auto update section */
        .auto-update-section {
            background: rgba(0, 80, 158, 0.1);
            border: 1px solid var(--info);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        /* Auto Update Form */
        .auto-update-form {
            background: linear-gradient(135deg, var(--accent) 10%, #ff3a3a47 100%);
            border: 2px solid var(--accent);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .auto-update-form .card-title {
            color: var(--primary-dark);
            font-size: 18px;
        }

        .auto-update-info {
            background: rgba(253, 235, 158, 0.1);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-size: 12px;
            color: var(--on-surface);
        }

        .auto-update-status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
            display: inline-block;
        }

        .auto-update-status.success {
            background: rgba(0, 106, 103, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .auto-update-status.error {
            background: rgba(211, 47, 47, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        @media print {
            .sidebar, .header { display: none !important; }
            .main-content { margin-right: 0; }
        }

        /* Action buttons in table */
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            padding: 4px 8px;
            font-size: 11px;
            border-radius: 4px;
        }

        /* Badge */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge.buy {
            background: rgba(0, 106, 103, 0.1);
            color: var(--success);
        }

        .badge.sell {
            background: rgba(211, 47, 47, 0.1);
            color: var(--danger);
        }

        /* تحسين عرض الأرقام بدون تقريب */
        .exact-number {
            font-family: 'Courier New', monospace;
            font-weight: 500;
        }

        /* إخفاء العناصر المحذوفة */
        .hidden-element {
            display: none !important;
        }
    </style>
</head>
<body data-theme="light" data-lang="ar">
    
  <!-- Sidebar Navigation - Icons Only -->
<div class="sidebar">
    <!-- Logo -->
    <div class="nav-logo" title="InDar Tracker">
        <i class="fas fa-chart-line"></i>
    </div>

    <!-- Main Navigation -->
    <div class="nav-items">
        <div class="nav-item active" onclick="switchTab('dashboard')" title="Dashboard">
            <i class="fas fa-chart-pie"></i>
        </div>
        <div class="nav-item" onclick="switchTab('transactions')" title="Transactions">
            <i class="fas fa-exchange-alt"></i>
        </div>
        <div class="nav-item" onclick="switchTab('funds')" title="Funds">
            <i class="fas fa-list"></i>
        </div>
        <div class="nav-item" onclick="switchTab('prices')" title="Prices">
            <i class="fas fa-database"></i>
        </div>
        <div class="nav-item" onclick="switchTab('analytics')" title="Analytics">
            <i class="fas fa-chart-bar"></i>
        </div>
        <div class="nav-item" onclick="switchTab('general-info')" title="General Info">
            <i class="fas fa-info-circle"></i>
        </div>
        <div class="nav-item" onclick="switchTab('export')" title="Export">
            <i class="fas fa-download"></i>
        </div>
    </div>

    <div class="nav-separator"></div>

    <!-- Top Section -->
    <div class="nav-items bottom-section">
        <div class="nav-item" onclick="toggleTheme()" title="Toggle Theme">
            <i class="fas fa-moon" id="theme-icon"></i>
        </div>
        <div class="nav-item" onclick="toggleLanguage()" title="Toggle Language">
            <i class="fas fa-globe"></i>
        </div>
        <div class="nav-item" onclick="showFundModal()" title="Add Fund">
            <i class="fas fa-plus"></i>
        </div>
    </div>
</div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1><i class="fas fa-chart-line"></i> <span data-ar="ان - دار استثمار" data-en="InDar Tracker">InDar Tracker</span></h1>
                    <p id="current-fund-display" data-ar="اختر صندوق" data-en="Select a fund">اختر صندوق</p>
                </div>
                <div class="header-controls">
                    <select id="fund-select" class="fund-selector"></select>
                </div>
            </div>
        </div>

        <!-- Content Area -->
        <div class="content-wrapper">
            <!-- Dashboard Tab -->
            <div id="dashboard" class="content active">
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-wallet"></i>
                        <span data-ar="ملخص المحفظة" data-en="Portfolio Summary">ملخص المحفظة</span>
                    </div>
                    <div class="grid-4">
                        <div class="metric-box">
                            <div class="metric-label"><i class="fas fa-cubes"></i> <span data-ar="إجمالي الوثائق" data-en="Total Units">إجمالي الوثائق</span></div>
                            <div class="metric-value exact-number" id="total-units">0</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(135deg, var(--secondary) 0%, var(--secondary-dark) 100%);">
                            <div class="metric-label"><i class="fas fa-coins"></i> <span data-ar="متوسط الشراء" data-en="Avg Buy">متوسط الشراء</span></div>
                            <div class="metric-value exact-number" id="avg-price">0</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(135deg, var(--info) 0%, #0066CC 100%);">
                            <div class="metric-label"><i class="fas fa-tag"></i> <span data-ar="السعر الحالي" data-en="Current Price">السعر الحالي</span></div>
                            <div class="metric-value exact-number" id="current-price">0</div>
                        </div>
                        <div class="metric-box" id="value-box">
                            <div class="metric-label"><i class="fas fa-dollar-sign"></i> <span data-ar="القيمة الحالية" data-en="Current Value">القيمة الحالية</span></div>
                            <div class="metric-value exact-number" id="current-value">0</div>
                        </div>
                    </div>
                </div>

                <!-- Recommendation Box -->
                <div id="recommendation-box" class="recommendation-box">
                    <div class="recommendation-action">
                        <i class="fas fa-lightbulb"></i>
                        <span id="recommendation-text">توصيات</span>
                    </div>
                    <div id="recommendation-strategy" class="recommendation-strategy"></div>
                    <div id="recommendation-actions" class="recommendation-actions"></div>
                    <div class="recommendation-confidence">
                        <i class="fas fa-chart-line"></i>
                        <span id="recommendation-confidence-text"></span>
                    </div>
                </div>

                <div class="grid-2">
                    <div class="card">
                        <div class="card-title"><i class="fas fa-chart-area"></i> <span data-ar="أداء المحفظة" data-en="Performance">أداء المحفظة</span></div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div>
                                <div style="font-size: 11px; color: #999; margin-bottom: 4px;"><span data-ar="إجمالي الاستثمار" data-en="Total Invested">إجمالي الاستثمار</span></div>
                                <div style="font-size: 18px; font-weight: 700; color: var(--primary);" class="exact-number" id="total-invested">0</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #999; margin-bottom: 4px;"><span data-ar="الربح/الخسارة" data-en="Profit/Loss">الربح/الخسارة</span></div>
                                <div style="font-size: 18px; font-weight: 700;" class="exact-number" id="net-profit">0</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #999; margin-bottom: 4px;"><span data-ar="العائد %" data-en="Return %">العائد %</span></div>
                                <div style="font-size: 18px; font-weight: 700;" id="return-pct">0%</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #999; margin-bottom: 4px;"><span data-ar="آخر تحديث" data-en="Last Update">آخر تحديث</span></div>
                                <div style="font-size: 13px; font-weight: 600;" id="last-update">--</div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title"><i class="fas fa-database"></i> <span data-ar="قاعدة بيانات الأسعار" data-en="Prices Database">قاعدة بيانات الأسعار</span></div>
                        <div style="font-size: 12px; color: #666; margin-bottom: 12px;">
                            <span data-ar="عدد الأسعار المسجلة:" data-en="Prices recorded:">عدد الأسعار المسجلة:</span>
                            <strong id="prices-count">0</strong>
                        </div>
                        <div class="btn-group">
                            <button class="btn" onclick="exportPricesPDF()">
                                <i class="fas fa-file-pdf"></i> <span data-ar="PDF" data-en="PDF">PDF</span>
                            </button>
                            <button class="btn secondary" onclick="exportPricesJSON()">
                                <i class="fas fa-database"></i> <span data-ar="JSON" data-en="JSON">JSON</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-history"></i> <span data-ar="آخر 30 سعر" data-en="Last 30 Prices">آخر 30 سعر</span></div>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th><i class="fas fa-calendar"></i> <span data-ar="التاريخ" data-en="Date">التاريخ</span></th>
                                    <th><i class="fas fa-tag"></i> <span data-ar="السعر" data-en="Price">السعر</span></th>
                                    <th><i class="fas fa-arrow-up-down"></i> <span data-ar="التغير %" data-en="Change %">التغير %</span></th>
                                    <th><i class="fas fa-circle"></i> <span data-ar="الحالة" data-en="Status">الحالة</span></th>
                                </tr>
                            </thead>
                            <tbody id="price-history-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Transactions Tab -->
            <div id="transactions" class="content">
                <div class="card">
                    <div class="card-title"><i class="fas fa-plus-circle"></i> <span data-ar="إضافة معاملة" data-en="Add Transaction">إضافة معاملة</span></div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label data-ar="التاريخ" data-en="Date">التاريخ</label>
                            <input type="date" id="tx-date">
                        </div>
                        <div class="form-group">
                            <label data-ar="النوع" data-en="Type">النوع</label>
                            <select id="tx-type">
                                <option value="buy" data-ar="شراء" data-en="Buy">شراء</option>
                                <option value="sell" data-ar="بيع" data-en="Sell">بيع</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label data-ar="عدد الوثائق" data-en="Units">عدد الوثائق</label>
                            <input type="number" id="tx-units" placeholder="0" step="any">
                        </div>
                        <div class="form-group">
                            <label data-ar="سعر الوثيقة" data-en="Price">سعر الوثيقة</label>
                            <input type="number" id="tx-price" placeholder="0" step="any">
                        </div>
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="addTransaction()">
                            <i class="fas fa-check"></i> <span data-ar="إضافة" data-en="Add">إضافة</span>
                        </button>
                        <button class="btn secondary" onclick="clearTxForm()">
                            <i class="fas fa-redo"></i> <span data-ar="مسح" data-en="Clear">مسح</span>
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-list"></i> <span data-ar="سجل المعاملات" data-en="Transactions Log">سجل المعاملات</span></div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th><i class="fas fa-calendar"></i> <span data-ar="التاريخ" data-en="Date">التاريخ</span></th>
                                    <th><i class="fas fa-clock"></i> <span data-ar="المدة" data-en="Duration">المدة</span></th>
                                    <th><i class="fas fa-exchange-alt"></i> <span data-ar="النوع" data-en="Type">النوع</span></th>
                                    <th><i class="fas fa-cubes"></i> <span data-ar="الوثائق" data-en="Units">الوثائق</span></th>
                                    <th><i class="fas fa-tag"></i> <span data-ar="السعر" data-en="Price">السعر</span></th>
                                    <th><i class="fas fa-money-bill"></i> <span data-ar="المبلغ" data-en="Amount">المبلغ</span></th>
                                    <th><i class="fas fa-percent"></i> <span data-ar="الرسوم" data-en="Fees">الرسوم</span></th>
                                    <th><i class="fas fa-check"></i> <span data-ar="صافي" data-en="Net">صافي</span></th>
                                    <th><i class="fas fa-cog"></i> <span data-ar="الإجراءات" data-en="Actions">الإجراءات</span></th>
                                </tr>
                            </thead>
                            <tbody id="transactions-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Funds Tab -->
            <div id="funds" class="content">
                <div class="card">
                    <div class="card-title"><i class="fas fa-list"></i> <span data-ar="قائمة الصناديق" data-en="Funds List">قائمة الصناديق</span></div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th><i class="fas fa-info"></i> <span data-ar="الاسم" data-en="Name">الاسم</span></th>
                                    <th><i class="fas fa-code"></i> <span data-ar="الكود" data-en="Code">الكود</span></th>
                                    <th><i class="fas fa-tag"></i> <span data-ar="السعر" data-en="Price">السعر</span></th>
                                    <th><i class="fas fa-exchange-alt"></i> <span data-ar="رسوم" data-en="Fees">رسوم</span></th>
                                    <th><i class="fas fa-cog"></i> <span data-ar="الإجراءات" data-en="Actions">الإجراءات</span></th>
                                </tr>
                            </thead>
                            <tbody id="funds-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Prices Tab (قاعدة بيانات الأسعار) -->
            <div id="prices" class="content">
                <div class="card">
                    <div class="card-title"><i class="fas fa-calendar-alt"></i> <span data-ar="تاريخ اليوم" data-en="Today">تاريخ اليوم</span>: <span id="today-date" style="color: var(--primary); font-weight: 700;">--</span></div>
                </div>

                <!-- Auto Update Form -->
                <div class="auto-update-form">
                    <div class="card-title"><i class="fas fa-robot"></i> <span data-ar="التحديث التلقائي للأسعار" data-en="Auto Price Update">التحديث التلقائي للأسعار</span></div>
                    
                    <div class="auto-update-info">
                        <i class="fas fa-info-circle"></i> سيتم إضافة سعر جديد كل يوم تلقائياً باستخدام الإعدادات التالية:
                    </div>
                    
                    <div class="grid-2">
                        <div class="form-group">
                            <label><i class="fas fa-link"></i> <span data-ar="رابط الموقع" data-en="Website URL">رابط الموقع</span></label>
                            <input type="text" id="auto-update-url" placeholder="https://example.com/fund-price">
                        </div>
                        <div class="form-group">
                            <label><i class="fas fa-code"></i> <span data-ar="كود العنصر" data-en="Element Code">كود العنصر</span></label>
                            <input type="text" id="element-code" placeholder=".price-element" value=".price-element">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-clock"></i> <span data-ar="وقت التحديث" data-en="Update Time">وقت التحديث</span></label>
                        <select id="update-time">
                            <option value="09:00">09:00 صباحاً</option>
                            <option value="10:00">10:00 صباحاً</option>
                            <option value="11:00">11:00 صباحاً</option>
                            <option value="12:00">12:00 ظهراً</option>
                            <option value="13:00">01:00 ظهراً</option>
                            <option value="14:00">02:00 ظهراً</option>
                        </select>
                    </div>
                    
                    <div id="auto-update-status" class="auto-update-status" style="display: none;"></div>
                    
                    <div class="btn-group">
                        <button class="btn" onclick="saveAutoUpdateSettings()">
                            <i class="fas fa-save"></i> <span data-ar="حفظ الإعدادات" data-en="Save Settings">حفظ الإعدادات</span>
                        </button>
                        <button class="btn secondary" onclick="testAutoUpdate()">
                            <i class="fas fa-bolt"></i> <span data-ar="اختبار الآن" data-en="Test Now">اختبار الآن</span>
                        </button>
                        <button class="btn danger" onclick="stopAutoUpdate()">
                            <i class="fas fa-stop"></i> <span data-ar="إيقاف" data-en="Stop">إيقاف</span>
                        </button>
                    </div>
                    
                    <div style="margin-top: 15px; font-size: 12px; color: var(--on-surface);">
                        <i class="fas fa-history"></i> <span id="last-auto-update">آخر تحديث: --</span>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-edit"></i> <span data-ar="تحديث سعر الوثيقة" data-en="Update Price">تحديث سعر الوثيقة</span></div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label data-ar="اسم الصندوق" data-en="Fund Name">اسم الصندوق</label>
                            <input type="text" id="price-fund-name" readonly style="background: rgba(0, 11, 88, 0.1); cursor: not-allowed;">
                        </div>
                        <div class="form-group">
                            <label data-ar="السعر الجديد" data-en="New Price">السعر الجديد</label>
                            <input type="text" id="price-new" placeholder="0" step="any">
                        </div>
                    </div>
                    <div class="form-group">
                        <label data-ar="التاريخ" data-en="Date">التاريخ</label>
                        <input type="date" id="price-date">
                    </div>
                    <button class="btn" onclick="updatePrice()" style="width: 100%; justify-content: center;">
                        <i class="fas fa-check"></i> <span data-ar="تحديث" data-en="Update">تحديث</span>
                    </button>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analytics" class="content">
                <!-- الرصيد المالي -->
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-wallet"></i>
                        <span data-ar="الرصيد المالي" data-en="Financial Balance">الرصيد المالي</span>
                    </div>
                    <div class="grid-2">
                        <div class="metric-box">
                            <div class="metric-label"><i class="fas fa-piggy-bank"></i> <span data-ar="الرصيد الأصلي" data-en="Original Balance">الرصيد الأصلي</span></div>
                            <div class="metric-value exact-number" id="original-balance">0</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label"><i class="fas fa-coins"></i> <span data-ar="الرصيد الفعلي" data-en="Actual Balance">الرصيد الفعلي</span></div>
                            <div class="metric-value exact-number" id="actual-balance">0</div>
                        </div>
                    </div>
                </div>

                <!-- تجميع الأرباح -->
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-money-bill-wave"></i>
                        <span data-ar="تجميع الأرباح" data-en="Profit Accumulation">تجميع الأرباح</span>
                    </div>
                    <div class="grid-4">
                        <div class="metric-box" style="background: linear-gradient(135deg, var(--success) 0%, var(--secondary-dark) 100%);">
                            <div class="metric-label"><i class="fas fa-coins"></i> <span data-ar="المكسب الحقيقي" data-en="Real Profit">المكسب الحقيقي</span></div>
                            <div class="metric-value exact-number" id="real-profit">0</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(135deg, var(--danger) 0%, #B71C1C 100%);">
                            <div class="metric-label"><i class="fas fa-exclamation-triangle"></i> <span data-ar="الخسائر السابقة" data-en="Past Losses">الخسائر السابقة</span></div>
                            <div class="metric-value exact-number" id="past-losses">0</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(135deg, var(--info) 0%, #0066CC 100%);">
                            <div class="metric-label"><i class="fas fa-calculator"></i> <span data-ar="صافي الربح بعد الرسوم" data-en="Net Profit After Fees">صافي الربح بعد الرسوم</span></div>
                            <div class="metric-value exact-number" id="net-after-fees">0</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(135deg, var(--tertiary) 0%, #003F8A 100%);">
                            <div class="metric-label"><i class="fas fa-balance-scale"></i> <span data-ar="متوسط سعر الوثيقة" data-en="Avg Unit Price">متوسط سعر الوثيقة</span></div>
                            <div class="metric-value exact-number" id="avg-unit-price">0</div>
                        </div>
                    </div>
                </div>

                <!-- تأثير العمليات على الربحية -->
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-exchange-alt"></i>
                        <span data-ar="تأثير العمليات على الربحية" data-en="Transaction Impact on Profitability">تأثير العمليات على الربحية</span>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th><i class="fas fa-calendar"></i> <span data-ar="التاريخ" data-en="Date">التاريخ</span></th>
                                    <th><i class="fas fa-exchange-alt"></i> <span data-ar="النوع" data-en="Type">النوع</span></th>
                                    <th><i class="fas fa-cubes"></i> <span data-ar="الوثائق" data-en="Units">الوثائق</span></th>
                                    <th><i class="fas fa-tag"></i> <span data-ar="السعر" data-en="Price">السعر</span></th>
                                    <th><i class="fas fa-money-bill"></i> <span data-ar="تأثير الربحية" data-en="Profit Impact">تأثير الربحية</span></th>
                                    <th><i class="fas fa-percent"></i> <span data-ar="تأثير الرسوم" data-en="Fees Impact">تأثير الرسوم</span></th>
                                </tr>
                            </thead>
                            <tbody id="profit-impact-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- باقي التحليلات -->
                <div class="grid-2">
                    <div class="card">
                        <div class="card-title"><i class="fas fa-pie-chart"></i> <span data-ar="توزيع المحفظة" data-en="Portfolio Distribution">توزيع المحفظة</span></div>
                        <div class="chart-container">
                            <canvas id="portfolioChart"></canvas>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-title"><i class="fas fa-chart-area"></i> <span data-ar="الأداء الشهري" data-en="Monthly Performance">الأداء الشهري</span></div>
                        <div class="chart-container">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-percent"></i> <span data-ar="العائد على الاستثمار" data-en="Return on Investment">العائد على الاستثمار</span></div>
                    <div class="chart-container">
                        <canvas id="returnChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-chart-bar"></i> <span data-ar="إحصائيات شاملة" data-en="Complete Statistics">إحصائيات شاملة</span></div>
                    <div class="grid-4">
                        <div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 8px;"><i class="fas fa-list"></i> <span data-ar="عدد الصناديق" data-en="Number of Funds">عدد الصناديق</span></div>
                            <div style="font-size: 28px; font-weight: 700; color: var(--primary);" id="stats-funds">0</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 8px;"><i class="fas fa-exchange-alt"></i> <span data-ar="عدد المعاملات" data-en="Total Transactions">عدد المعاملات</span></div>
                            <div style="font-size: 28px; font-weight: 700; color: var(--primary);" id="stats-transactions">0</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 8px;"><i class="fas fa-trophy"></i> <span data-ar="أفضل صندوق" data-en="Best Fund">أفضل صندوق</span></div>
                            <div style="font-size: 18px; font-weight: 700; color: var(--success);" id="stats-best">--</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 8px;"><i class="fas fa-exclamation-triangle"></i> <span data-ar="أسوأ صندوق" data-en="Worst Fund">أسوأ صندوق</span></div>
                            <div style="font-size: 18px; font-weight: 700; color: var(--danger);" id="stats-worst">--</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- General Info Tab -->
            <div id="general-info" class="content">
                <!-- القسم الأول: إجماليات الصناديق -->
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-chart-bar"></i>
                        <span data-ar="إجماليات جميع الصناديق" data-en="Total for All Funds">إجماليات جميع الصناديق</span>
                    </div>
                    <div class="grid-4">
                        <div class="metric-box">
                            <div class="metric-label"><i class="fas fa-money-bill-wave"></i> <span data-ar="إجمالي المبلغ المدفوع" data-en="Total Amount Paid">إجمالي المبلغ المدفوع</span></div>
                            <div class="metric-value exact-number" id="total-paid-all">0</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(135deg, var(--success) 0%, var(--secondary-dark) 100%);">
                            <div class="metric-label"><i class="fas fa-chart-line"></i> <span data-ar="إجمالي الربح المحتمل" data-en="Total Potential Profit">إجمالي الربح المحتمل</span></div>
                            <div class="metric-value exact-number" id="total-profit-all">0</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-label"><i class="fas fa-balance-scale"></i> <span data-ar="إجمالي الربح/الخسارة" data-en="Total Profit/Loss">إجمالي الربح/الخسارة</span></div>
                            <div class="metric-value exact-number" id="total-pl-all">0</div>
                        </div>
                        <div class="metric-box" style="background: linear-gradient(135deg, var(--tertiary) 0%, #003F8A 100%);">
                            <div class="metric-label"><i class="fas fa-cubes"></i> <span data-ar="إجمالي الوثائق" data-en="Total Units">إجمالي الوثائق</span></div>
                            <div class="metric-value exact-number" id="total-units-all">0</div>
                        </div>
                    </div>
                </div>

                <!-- القسم الثاني: تفاصيل كل صندوق -->
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-list"></i>
                        <span data-ar="تفاصيل الصناديق" data-en="Funds Details">تفاصيل الصناديق</span>
                    </div>
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th><i class="fas fa-info"></i> <span data-ar="اسم الصندوق" data-en="Fund Name">اسم الصندوق</span></th>
                                    <th><i class="fas fa-cubes"></i> <span data-ar="الوثائق" data-en="Units">الوثائق</span></th>
                                    <th><i class="fas fa-money-bill"></i> <span data-ar="إجمالي الاستثمار" data-en="Total Investment">إجمالي الاستثمار</span></th>
                                    <th><i class="fas fa-chart-line"></i> <span data-ar="الربح بدون رسوم" data-en="Profit Without Fees">الربح بدون رسوم</span></th>
                                    <th><i class="fas fa-calculator"></i> <span data-ar="الربح بعد الرسوم" data-en="Profit After Fees">الربح بعد الرسوم</span></th>
                                    <th><i class="fas fa-tag"></i> <span data-ar="متوسط الشراء" data-en="Avg Buy">متوسط الشراء</span></th>
                                    <th><i class="fas fa-tag"></i> <span data-ar="السعر الحالي" data-en="Current Price">السعر الحالي</span></th>
                                    <th><i class="fas fa-dollar-sign"></i> <span data-ar="القيمة الحالية" data-en="Current Value">القيمة الحالية</span></th>
                                    <th><i class="fas fa-percent"></i> <span data-ar="العائد %" data-en="Return %">العائد %</span></th>
                                </tr>
                            </thead>
                            <tbody id="funds-details-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Export Tab -->
            <div id="export" class="content">
                <div class="card">
                    <div class="card-title"><i class="fas fa-download"></i> <span data-ar="تصدير البيانات" data-en="Export Data">تصدير البيانات</span></div>
                    <div class="btn-group">
                        <button class="btn" onclick="exportJSON()">
                            <i class="fas fa-database"></i> JSON
                        </button>
                        <button class="btn secondary" onclick="exportCSV()">
                            <i class="fas fa-file-csv"></i> CSV
                        </button>
                        <button class="btn" onclick="exportPDF()">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-upload"></i> <span data-ar="استيراد البيانات" data-en="Import Data">استيراد البيانات</span></div>
                    <div class="form-group">
                        <label data-ar="اختر ملف" data-en="Choose File">اختر ملف</label>
                        <input type="file" id="import-file" accept=".json">
                    </div>
                    <div class="btn-group">
                        <button class="btn" onclick="importFile()">
                            <i class="fas fa-check"></i> <span data-ar="استيراد" data-en="Import">استيراد</span>
                        </button>
                        <button class="btn danger" onclick="clearAllData()">
                            <i class="fas fa-trash"></i> <span data-ar="مسح الكل" data-en="Clear All">مسح الكل</span>
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-info-circle"></i> <span data-ar="معلومات التطبيق" data-en="App Info">معلومات التطبيق</span></div>
                    <div style="font-size: 13px; color: #666;">
                        <p><span data-ar="الصناديق:" data-en="Funds:">الصناديق:</span> <strong id="info-funds">0</strong></p>
                        <p><span data-ar="المعاملات:" data-en="Transactions:">المعاملات:</span> <strong id="info-transactions">0</strong></p>
                        <p><span data-ar="آخر تحديث:" data-en="Last Updated:">آخر تحديث:</span> <strong id="info-updated">--</strong></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fund Modal (إضافة/تعديل) -->
    <div id="fundModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid var(--border);">
                <h2 style="color: var(--primary); font-size: 18px; font-weight: 600;"><i class="fas fa-plus-circle"></i> <span id="modal-title" data-ar="إضافة صندوق جديد" data-en="Add New Fund">إضافة صندوق جديد</span></h2>
                <button onclick="closeFundModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            <input type="hidden" id="fund-id">
            <div class="form-group">
                <label data-ar="اسم الصندوق" data-en="Fund Name">اسم الصندوق</label>
                <input type="text" id="fund-name" placeholder="">
            </div>
            <div class="form-group">
                <label data-ar="كود الصندوق" data-en="Fund Code">كود الصندوق</label>
                <input type="text" id="fund-code" placeholder="">
            </div>
            <div class="form-group">
                <label data-ar="السعر الحالي" data-en="Current Price">السعر الحالي</label>
                <input type="text" id="fund-price" placeholder="0">
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label data-ar="رسوم الاكتتاب %" data-en="Subscription Fee %">رسوم الاكتتاب %</label>
                    <input type="number" id="fund-sub-fee" placeholder="0" step="any" value="0">
                </div>
                <div class="form-group">
                    <label data-ar="رسوم الاسترداد %" data-en="Redemption Fee %">رسوم الاسترداد %</label>
                    <input type="number" id="fund-red-fee" placeholder="0" step="any" value="0">
                </div>
            </div>
            <div class="btn-group">
                <button class="btn" onclick="saveFund()">
                    <i class="fas fa-check"></i> <span id="save-btn-text" data-ar="إضافة" data-en="Add">إضافة</span>
                </button>
                <button class="btn danger" onclick="closeFundModal()">
                    <i class="fas fa-times"></i> <span data-ar="إلغاء" data-en="Cancel">إلغاء</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editTxModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid var(--border);">
                <h2 style="color: var(--primary); font-size: 18px; font-weight: 600;"><i class="fas fa-edit"></i> <span data-ar="تعديل معاملة" data-en="Edit Transaction">تعديل معاملة</span></h2>
                <button onclick="closeEditTxModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #666;">&times;</button>
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label data-ar="التاريخ" data-en="Date">التاريخ</label>
                    <input type="date" id="edit-tx-date">
                </div>
                <div class="form-group">
                    <label data-ar="النوع" data-en="Type">النوع</label>
                    <select id="edit-tx-type">
                        <option value="buy" data-ar="شراء" data-en="Buy">شراء</option>
                        <option value="sell" data-ar="بيع" data-en="Sell">بيع</option>
                    </select>
                </div>
                <div class="form-group">
                    <label data-ar="عدد الوثائق" data-en="Units">عدد الوثائق</label>
                    <input type="text" id="edit-tx-units" placeholder="0">
                </div>
                <div class="form-group">
                    <label data-ar="سعر الوثيقة" data-en="Price">سعر الوثيقة</label>
                    <input type="text" id="edit-tx-price" placeholder="0">
                </div>
            </div>
            <input type="hidden" id="edit-tx-index">
            <div class="btn-group">
                <button class="btn" onclick="saveEditedTransaction()">
                    <i class="fas fa-save"></i> <span data-ar="حفظ" data-en="Save">حفظ</span>
                </button>
                <button class="btn danger" onclick="closeEditTxModal()">
                    <i class="fas fa-times"></i> <span data-ar="إلغاء" data-en="Cancel">إلغاء</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>

    <script>
        // ============ STATE ============
        let funds = [];
        let currentFundId = null;
        let lang = localStorage.getItem('app_lang') || 'ar';
        let theme = localStorage.getItem('app_theme') || 'light';
        let chartInstances = {};
        let autoUpdateTimer = null;
        let autoUpdateSettings = JSON.parse(localStorage.getItem('auto_update_settings') || '{}');
        let editingFundId = null;

        // Language labels
        const labels = {
            ar: {
                buy: 'شراء',
                sell: 'بيع',
                selectFund: 'اختر صندوق',
                noData: 'لا توجد بيانات',
                days: 'يوم',
                months: 'شهر',
                years: 'سنة',
                and: 'و',
                edit: 'تعديل',
                add: 'إضافة'
            },
            en: {
                buy: 'Buy',
                sell: 'Sell',
                selectFund: 'Select a fund',
                noData: 'No data',
                days: 'day',
                months: 'month',
                years: 'year',
                and: 'and',
                edit: 'Edit',
                add: 'Add'
            }
        };

        // ============ INIT ============
        function init() {
            loadData();
            applyTheme(theme);
            applyLang(lang);
            setToday();
            renderAll();
            Chart.defaults.font.family = "'Cairo', sans-serif";
            Chart.defaults.color = theme === 'dark' ? '#e0e0e0' : '#666';
            setupAutoUpdate();
        }

        function setToday() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tx-date').value = today;
            document.getElementById('price-date').value = today;
            document.getElementById('edit-tx-date').value = today;
            const dateStr = new Date(today).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US');
            document.getElementById('today-date').textContent = dateStr;
        }

        // ============ TRANSLATIONS ============
        function updateTranslations() {
            document.querySelectorAll('[data-ar][data-en]').forEach(el => {
                const text = lang === 'ar' ? el.getAttribute('data-ar') : el.getAttribute('data-en');
                if (el.tagName === 'INPUT' || el.tagName === 'OPTION') {
                    if (el.hasAttribute('placeholder')) {
                        el.placeholder = text;
                    }
                } else if (!el.querySelector('i')) {
                    el.textContent = text;
                }
            });
        }

        // ============ THEME ============
        function applyTheme(newTheme) {
            theme = newTheme;
            document.body.setAttribute('data-theme', theme);
            document.getElementById('theme-icon').className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            localStorage.setItem('app_theme', theme);
            Chart.defaults.color = theme === 'dark' ? '#e0e0e0' : '#666';
            updateAllCharts();
        }

        function toggleTheme() {
            applyTheme(theme === 'light' ? 'dark' : 'light');
        }

        // ============ LANGUAGE ============
        function applyLang(newLang) {
            lang = newLang;
            document.body.setAttribute('data-lang', lang);
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            localStorage.setItem('app_lang', lang);
            updateTranslations();
            setToday();
            renderAll();
        }

        function toggleLanguage() {
            applyLang(lang === 'ar' ? 'en' : 'ar');
        }

        // ============ NAVIGATION ============
        function switchTab(tabName) {
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.closest('.nav-item').classList.add('active');
            
            if (tabName === 'analytics' || tabName === 'dashboard' || tabName === 'general-info') {
                setTimeout(() => {
                    updateAllCharts();
                    updateAdvancedAnalytics();
                    updateGeneralInfo();
                }, 100);
            }
        }

        // ============ FUNDS ============
        function showFundModal(fundId = null) {
            editingFundId = fundId;
            const modalTitle = document.getElementById('modal-title');
            const saveBtnText = document.getElementById('save-btn-text');
            
            if (fundId) {
                const fund = funds.find(f => f.id === fundId);
                if (fund) {
                    document.getElementById('fund-id').value = fund.id;
                    document.getElementById('fund-name').value = fund.name;
                    document.getElementById('fund-code').value = fund.code;
                    document.getElementById('fund-price').value = fund.price;
                    document.getElementById('fund-sub-fee').value = fund.subscriptionFee || 0;
                    document.getElementById('fund-red-fee').value = fund.redemptionFee || 0;
                    
                    modalTitle.setAttribute('data-ar', 'تعديل الصندوق');
                    modalTitle.setAttribute('data-en', 'Edit Fund');
                    saveBtnText.setAttribute('data-ar', 'حفظ');
                    saveBtnText.setAttribute('data-en', 'Save');
                }
            } else {
                document.getElementById('fund-id').value = '';
                document.getElementById('fund-name').value = '';
                document.getElementById('fund-code').value = '';
                document.getElementById('fund-price').value = '';
                document.getElementById('fund-sub-fee').value = '0';
                document.getElementById('fund-red-fee').value = '0';
                
                modalTitle.setAttribute('data-ar', 'إضافة صندوق جديد');
                modalTitle.setAttribute('data-en', 'Add New Fund');
                saveBtnText.setAttribute('data-ar', 'إضافة');
                saveBtnText.setAttribute('data-en', 'Add');
            }
            
            updateTranslations();
            document.getElementById('fundModal').classList.add('active');
        }

        function closeFundModal() {
            document.getElementById('fundModal').classList.remove('active');
            editingFundId = null;
        }

        function saveFund() {
            const id = document.getElementById('fund-id').value;
            const name = document.getElementById('fund-name').value.trim();
            const code = document.getElementById('fund-code').value.trim().toUpperCase();
            const price = document.getElementById('fund-price').value.trim();
            const subFee = parseFloat(document.getElementById('fund-sub-fee').value) || 0;
            const redFee = parseFloat(document.getElementById('fund-red-fee').value) || 0;

            if (!name || !code || !price) {
                alert(lang === 'ar' ? 'الرجاء ملء البيانات الصحيحة' : 'Please fill in correct data');
                return;
            }

            if (id) {
                // تعديل صندوق موجود
                const fundIndex = funds.findIndex(f => f.id === id);
                if (fundIndex !== -1) {
                    funds[fundIndex].name = name;
                    funds[fundIndex].code = code;
                    funds[fundIndex].price = price;
                    funds[fundIndex].subscriptionFee = subFee;
                    funds[fundIndex].redemptionFee = redFee;
                }
            } else {
                // إضافة صندوق جديد
                const fund = {
                    id: Date.now().toString(),
                    name, code, price,
                    subscriptionFee: subFee,
                    redemptionFee: redFee,
                    transactions: [],
                    priceHistory: [{ date: new Date().toISOString().split('T')[0], price }]
                };
                funds.push(fund);
                if (!currentFundId) currentFundId = fund.id;
            }

            saveData();
            renderAll();
            closeFundModal();
        }

        function deleteFund(id) {
            if (funds.length === 1) {
                alert(lang === 'ar' ? 'لا يمكن حذف الصندوق الوحيد' : 'Cannot delete only fund');
                return;
            }
            if (!confirm(lang === 'ar' ? 'هل تريد حذف الصندوق؟' : 'Delete this fund?')) return;

            funds = funds.filter(f => f.id !== id);
            if (currentFundId === id) currentFundId = funds[0]?.id;
            saveData();
            renderAll();
        }

        function renderFundSelector() {
            const select = document.getElementById('fund-select');
            select.innerHTML = '';
            funds.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.id;
                opt.textContent = `${f.name} (${f.code})`;
                select.appendChild(opt);
            });
            if (currentFundId) select.value = currentFundId;
            select.addEventListener('change', (e) => {
                currentFundId = e.target.value;
                updateFundDisplay();
                updatePortfolio();
                renderTransactionsTable();
                saveData();
            });
            updateFundDisplay();
        }

        function updateFundDisplay() {
            const fund = getCurrentFund();
            document.getElementById('current-fund-display').textContent = fund ? `${fund.name} (${fund.code})` : labels[lang].selectFund;
            document.getElementById('price-fund-name').value = fund ? fund.name : '';
        }

        function renderFundsTable() {
            const tbody = document.getElementById('funds-table');
            tbody.innerHTML = '';
            funds.forEach(f => {
                const tr = document.createElement('tr');
                const fees = `${f.subscriptionFee || 0}% / ${f.redemptionFee || 0}%`;
                tr.innerHTML = `
                    <td>${f.name}</td>
                    <td>${f.code}</td>
                    <td class="exact-number">${f.price}</td>
                    <td>${fees}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn info small" onclick="showFundModal('${f.id}')" title="${lang === 'ar' ? 'تعديل' : 'Edit'}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn danger small" onclick="deleteFund('${f.id}')" title="${lang === 'ar' ? 'حذف' : 'Delete'}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============ TRANSACTIONS ============
        function addTransaction() {
            const fund = getCurrentFund();
            if (!fund) {
                alert(lang === 'ar' ? 'اختر صندوق أولاً' : 'Select a fund first');
                return;
            }

            const date = document.getElementById('tx-date').value;
            const type = document.getElementById('tx-type').value;
            const units = document.getElementById('tx-units').value;
            const price = document.getElementById('tx-price').value;

            if (!date || !units || !price) {
                alert(lang === 'ar' ? 'الرجاء ملء البيانات الصحيحة' : 'Please fill in correct data');
                return;
            }

            fund.transactions.push({ date, type, units, price });
            clearTxForm();
            saveData();
            renderAll();
        }

        function editTransaction(index) {
            const fund = getCurrentFund();
            if (!fund) return;

            const tx = fund.transactions[index];
            if (!tx) return;

            document.getElementById('edit-tx-date').value = tx.date;
            document.getElementById('edit-tx-type').value = tx.type;
            document.getElementById('edit-tx-units').value = tx.units;
            document.getElementById('edit-tx-price').value = tx.price;
            document.getElementById('edit-tx-index').value = index;

            document.getElementById('editTxModal').classList.add('active');
        }

        function saveEditedTransaction() {
            const fund = getCurrentFund();
            if (!fund) return;

            const index = parseInt(document.getElementById('edit-tx-index').value);
            if (isNaN(index)) return;

            const date = document.getElementById('edit-tx-date').value;
            const type = document.getElementById('edit-tx-type').value;
            const units = document.getElementById('edit-tx-units').value;
            const price = document.getElementById('edit-tx-price').value;

            if (!date || !units || !price) {
                alert(lang === 'ar' ? 'الرجاء ملء البيانات الصحيحة' : 'Please fill in correct data');
                return;
            }

            fund.transactions[index] = { date, type, units, price };
            saveData();
            renderAll();
            closeEditTxModal();
        }

        function closeEditTxModal() {
            document.getElementById('editTxModal').classList.remove('active');
        }

        function deleteTransaction(fundId, idx) {
            const fund = funds.find(f => f.id === fundId);
            if (confirm(lang === 'ar' ? 'هل تريد حذف المعاملة؟' : 'Delete this transaction?')) {
                fund.transactions.splice(idx, 1);
                saveData();
                renderAll();
            }
        }

        function clearTxForm() {
            document.getElementById('tx-units').value = '';
            document.getElementById('tx-price').value = '';
            setToday();
        }

        function calculateHoldingPeriod(startDate, endDate = new Date()) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diffTime = Math.abs(end - start);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            const years = Math.floor(diffDays / 365);
            const months = Math.floor((diffDays % 365) / 30);
            const days = diffDays % 30;
            
            let result = [];
            if (years > 0) result.push(`${years} ${years === 1 ? labels[lang].years : labels[lang].years}`);
            if (months > 0) result.push(`${months} ${months === 1 ? labels[lang].months : labels[lang].months}`);
            if (days > 0 || result.length === 0) result.push(`${days} ${days === 1 ? labels[lang].days : labels[lang].days}`);
            
            return result.join(` ${labels[lang].and} `);
        }

        function renderTransactionsTable() {
            const fund = getCurrentFund();
            const tbody = document.getElementById('transactions-table');
            tbody.innerHTML = '';
            
            if (!fund) return;

            fund.transactions.forEach((tx, idx) => {
                const amount = parseFloat(tx.units) * parseFloat(tx.price);
                const fee = tx.type === 'buy' ? amount * (fund.subscriptionFee / 100) : amount * (fund.redemptionFee / 100);
                const net = amount - fee;
                const holdingPeriod = calculateHoldingPeriod(tx.date);
                
                const tr = document.createElement('tr');
                const typeText = tx.type === 'buy' ? labels[lang].buy : labels[lang].sell;
                const dateStr = new Date(tx.date).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US');
                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td><span class="holding-badge"><i class="fas fa-clock"></i> ${holdingPeriod}</span></td>
                    <td><span class="badge ${tx.type}">${typeText}</span></td>
                    <td class="exact-number">${tx.units}</td>
                    <td class="exact-number">${tx.price}</td>
                    <td class="exact-number">${amount}</td>
                    <td class="exact-number">${fee}</td>
                    <td class="exact-number">${net}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn info action-btn" onclick="editTransaction(${idx})" title="${lang === 'ar' ? 'تعديل' : 'Edit'}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn danger action-btn" onclick="deleteTransaction('${fund.id}', ${idx})" title="${lang === 'ar' ? 'حذف' : 'Delete'}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============ CALCULATIONS ============
        function calculateMetrics(fund) {
            let units = 0, invested = 0, buyUnits = 0, buyAmount = 0;

            fund.transactions.forEach(tx => {
                const amount = parseFloat(tx.units) * parseFloat(tx.price);
                const fee = tx.type === 'buy' ? amount * (fund.subscriptionFee / 100) : amount * (fund.redemptionFee / 100);
                const net = amount - fee;

                if (tx.type === 'buy') {
                    units += parseFloat(tx.units);
                    invested += net;
                    buyUnits += parseFloat(tx.units);
                    buyAmount += net;
                } else {
                    units -= parseFloat(tx.units);
                    invested -= net;
                }
            });

            const avgPrice = buyUnits > 0 ? buyAmount / buyUnits : 0;
            const value = units * parseFloat(fund.price || 0);
            const profit = value - invested;
            const returnPct = invested > 0 ? (profit / invested) * 100 : 0;

            return { units, avgPrice, value, invested, profit, returnPct };
        }

        function calculateTotalFees(fund) {
            let totalFees = 0;
            
            fund.transactions.forEach(tx => {
                const amount = parseFloat(tx.units) * parseFloat(tx.price);
                const fee = tx.type === 'buy' 
                    ? amount * (fund.subscriptionFee / 100) 
                    : amount * (fund.redemptionFee / 100);
                totalFees += fee;
            });
            
            return totalFees;
        }

        function updatePortfolio() {
            const fund = getCurrentFund();
            if (!fund) return;

            const m = calculateMetrics(fund);

            document.getElementById('total-units').textContent = m.units;
            document.getElementById('avg-price').textContent = m.avgPrice;
            document.getElementById('current-price').textContent = fund.price || 0;
            document.getElementById('current-value').textContent = m.value;
            document.getElementById('total-invested').textContent = m.invested;
            document.getElementById('net-profit').textContent = m.profit;
            document.getElementById('return-pct').textContent = m.returnPct + '%';

            const profitEl = document.getElementById('net-profit');
            profitEl.style.color = m.profit >= 0 ? 'var(--success)' : 'var(--danger)';
            
            const returnEl = document.getElementById('return-pct');
            returnEl.style.color = m.returnPct >= 0 ? 'var(--success)' : 'var(--danger)';

            const valueBox = document.getElementById('value-box');
            if (m.profit >= 0) {
                valueBox.style.background = 'linear-gradient(135deg, var(--success) 0%, var(--secondary-dark) 100%)';
            } else {
                valueBox.style.background = 'linear-gradient(135deg, var(--danger) 0%, #B71C1C 100%)';
            }

            updateRecommendationStrategy(m, fund);
            renderPriceHistory();
            updatePricesCount();
            updateLastUpdate();
        }

        function updateLastUpdate() {
            const fund = getCurrentFund();
            if (!fund?.priceHistory?.length) {
                document.getElementById('last-update').textContent = '--';
                return;
            }
            const latest = fund.priceHistory[fund.priceHistory.length - 1];
            const dateStr = new Date(latest.date).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US');
            document.getElementById('last-update').textContent = dateStr;
        }

        function updatePricesCount() {
            const fund = getCurrentFund();
            const count = fund?.priceHistory?.length || 0;
            document.getElementById('prices-count').textContent = count;
        }

        // ============ RECOMMENDATION ENGINE ============
        function generateRecommendationStrategy(fund, metrics) {
            const strategy = {
                title: 'توصيات',
                actions: [],
                confidence: 0,
                explanation: ''
            };
            
            const currentPrice = parseFloat(fund.price || 0);
            const profitPercentage = metrics.returnPct;
            
            if (metrics.units === 0) {
                strategy.actions = ['ابدأ الاستثمار', 'راقب السوق', 'خطط للاستثمار طويل المدى'];
                strategy.confidence = 75;
                strategy.explanation = 'لا توجد استثمارات حالية. يوصى ببدء الاستثمار بشراء أولي صغير لاختبار السوق.';
            } else if (profitPercentage > 20) {
                strategy.actions = ['بيع جزئي للأرباح', 'إعادة استثمار', 'احتفظ بجزء نقداً'];
                strategy.confidence = 85;
                strategy.explanation = `أرباح قوية بنسبة ${profitPercentage.toFixed(2)}%. يوصى بأخذ بعض الأرباح وتأمين المكاسب.`;
            } else if (profitPercentage > 10) {
                strategy.actions = ['تعزيز المركز', 'مراقبة السوق', 'وضع أوامر وقف خسارة'];
                strategy.confidence = 70;
                strategy.explanation = `أداء جيد بنسبة ${profitPercentage.toFixed(2)}%. يمكن زيادة المركز عند الفرص المناسبة.`;
            } else if (profitPercentage > -5) {
                strategy.actions = ['الاستقرار والمراقبة', 'حافظ على الوضع', 'تابع الأخبار'];
                strategy.confidence = 60;
                strategy.explanation = `وضع مستقر بنسبة ${profitPercentage.toFixed(2)}%. يوصى بالمتابعة وعدم التحرك بعجلة.`;
            } else if (profitPercentage > -15) {
                strategy.actions = ['متوسط التكلفة للأسفل', 'شراء عند الانخفاضات', 'تجنب البيع بالذعر'];
                strategy.confidence = 65;
                strategy.explanation = `خسائر متوسطة بنسبة ${profitPercentage.toFixed(2)}%. يمكن تقليل متوسط الشراء بالشراء عند الانخفاضات.`;
            } else {
                strategy.actions = ['إعادة التقييم', 'تقييم الأسباب', 'استشارة خبير'];
                strategy.confidence = 50;
                strategy.explanation = `خسائر كبيرة بنسبة ${profitPercentage.toFixed(2)}%. يوصى بإعادة تقييم الاستراتيجية الاستثمارية.`;
            }
            
            return strategy;
        }

        function updateRecommendationStrategy(metrics, fund) {
            const strategy = generateRecommendationStrategy(fund, metrics);
            const recText = document.getElementById('recommendation-text');
            const recStrategy = document.getElementById('recommendation-strategy');
            const recActions = document.getElementById('recommendation-actions');
            const recConf = document.getElementById('recommendation-confidence-text');
            
            recText.textContent = strategy.title;
            recStrategy.textContent = strategy.explanation;
            recConf.textContent = `ثقة: ${Math.round(strategy.confidence)}%`;
            
            recActions.innerHTML = '';
            strategy.actions.forEach(action => {
                const btn = document.createElement('button');
                btn.className = 'btn small accent';
                btn.textContent = action;
                recActions.appendChild(btn);
            });
        }

        function renderPriceHistory() {
            const fund = getCurrentFund();
            const tbody = document.getElementById('price-history-table');
            tbody.innerHTML = '';

            if (!fund?.priceHistory) return;

            const sorted = [...fund.priceHistory].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 30);
            
            sorted.forEach((entry, idx) => {
                const prev = idx < sorted.length - 1 ? parseFloat(sorted[idx + 1].price) : parseFloat(entry.price);
                const current = parseFloat(entry.price);
                const change = ((current - prev) / prev) * 100;
                const statusIcon = change > 0.1 ? 'fa-arrow-up' : change < -0.1 ? 'fa-arrow-down' : 'fa-minus';
                const statusText = change > 0.1 ? lang === 'ar' ? 'ارتفاع' : 'Up' : change < -0.1 ? lang === 'ar' ? 'انخفاض' : 'Down' : lang === 'ar' ? 'مستقر' : 'Stable';

                const tr = document.createElement('tr');
                const dateStr = new Date(entry.date).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US');
                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td class="exact-number">${entry.price}</td>
                    <td class="${change >= 0 ? 'positive' : 'negative'}">${change >= 0 ? '+' : ''}${change.toFixed(4)}%</td>
                    <td><i class="fas ${statusIcon}"></i> ${statusText}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============ ADVANCED ANALYTICS ============
        function calculateAdvancedAnalytics(fund) {
            const metrics = calculateMetrics(fund);
            const totalFees = calculateTotalFees(fund);
            
            // تجميع الأرباح
            const realProfit = Math.max(metrics.profit, 0);
            const pastLosses = Math.abs(Math.min(metrics.profit, 0));
            const netAfterFees = metrics.profit - totalFees;
            const avgUnitPrice = metrics.avgPrice;
            
            // تأثير العمليات مع مراعاة الرسوم
            const transactionImpact = calculateTransactionImpactWithFees(fund);
            
            // الرصيد
            const originalBalance = metrics.invested;
            const actualBalance = metrics.value;
            
            return {
                realProfit,
                pastLosses,
                netAfterFees,
                avgUnitPrice,
                transactionImpact,
                originalBalance,
                actualBalance
            };
        }

        function calculateTransactionImpactWithFees(fund) {
            const impacts = [];
            let cumulativeUnits = 0;
            let cumulativeInvestment = 0;
            
            fund.transactions.forEach((tx, index) => {
                const units = parseFloat(tx.units);
                const price = parseFloat(tx.price);
                const amount = units * price;
                const fee = tx.type === 'buy' 
                    ? amount * (fund.subscriptionFee / 100) 
                    : amount * (fund.redemptionFee / 100);
                
                let impact = 0;
                let feeImpact = 0;
                
                if (tx.type === 'buy') {
                    cumulativeUnits += units;
                    cumulativeInvestment += amount - fee;
                    impact = - (amount + fee); // تكلفة الشراء + الرسوم
                    feeImpact = -fee; // تأثير الرسوم
                } else {
                    cumulativeUnits -= units;
                    const avgPrice = cumulativeInvestment / cumulativeUnits;
                    impact = (units * parseFloat(fund.price)) - (units * avgPrice) - fee;
                    feeImpact = -fee; // تأثير الرسوم
                }
                
                impacts.push({
                    date: tx.date,
                    type: tx.type,
                    units: units,
                    price: price,
                    impact: impact,
                    feeImpact: feeImpact
                });
            });
            
            return impacts;
        }

        function updateAdvancedAnalytics() {
            const fund = getCurrentFund();
            if (!fund) return;
            
            const analytics = calculateAdvancedAnalytics(fund);
            
            // تحديث واجهة التحليلات
            document.getElementById('real-profit').textContent = analytics.realProfit;
            document.getElementById('past-losses').textContent = analytics.pastLosses;
            document.getElementById('net-after-fees').textContent = analytics.netAfterFees;
            document.getElementById('avg-unit-price').textContent = analytics.avgUnitPrice;
            document.getElementById('original-balance').textContent = analytics.originalBalance;
            document.getElementById('actual-balance').textContent = analytics.actualBalance;
            
            // تحديث جدول تأثير العمليات
            updateProfitImpactTable(analytics.transactionImpact);
        }

        function updateProfitImpactTable(impacts) {
            const tbody = document.getElementById('profit-impact-table');
            tbody.innerHTML = '';
            
            impacts.forEach(impact => {
                const tr = document.createElement('tr');
                const dateStr = new Date(impact.date).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US');
                const impactClass = impact.impact >= 0 ? 'positive' : 'negative';
                const feeClass = impact.feeImpact >= 0 ? 'positive' : 'negative';
                const impactSign = impact.impact >= 0 ? '+' : '';
                const feeSign = impact.feeImpact >= 0 ? '+' : '';
                const typeText = impact.type === 'buy' ? labels[lang].buy : labels[lang].sell;
                
                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td><span class="badge ${impact.type}">${typeText}</span></td>
                    <td class="exact-number">${impact.units}</td>
                    <td class="exact-number">${impact.price}</td>
                    <td class="${impactClass} exact-number">${impactSign}${impact.impact}</td>
                    <td class="${feeClass} exact-number">${feeSign}${impact.feeImpact}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============ GENERAL INFO ============
        function updateGeneralInfo() {
            // إجماليات جميع الصناديق
            let totalPaid = 0;
            let totalPotentialProfit = 0;
            let totalProfitLoss = 0;
            let totalUnits = 0;
            
            const fundsDetails = [];
            
            funds.forEach(fund => {
                const m = calculateMetrics(fund);
                const totalFees = calculateTotalFees(fund);
                const profitWithoutFees = m.profit + totalFees;
                
                totalPaid += m.invested;
                totalPotentialProfit += Math.max(m.profit, 0);
                totalProfitLoss += m.profit;
                totalUnits += m.units;
                
                fundsDetails.push({
                    name: fund.name,
                    units: m.units,
                    invested: m.invested,
                    profitWithoutFees: profitWithoutFees,
                    profitAfterFees: m.profit,
                    avgPrice: m.avgPrice,
                    currentPrice: fund.price,
                    currentValue: m.value,
                    returnPct: m.returnPct
                });
            });
            
            // تحديث الإجماليات
            document.getElementById('total-paid-all').textContent = totalPaid;
            document.getElementById('total-profit-all').textContent = totalPotentialProfit;
            document.getElementById('total-pl-all').textContent = totalProfitLoss;
            document.getElementById('total-units-all').textContent = totalUnits;
            
            // تحديث جدول التفاصيل
            updateFundsDetailsTable(fundsDetails);
        }

        function updateFundsDetailsTable(details) {
            const tbody = document.getElementById('funds-details-table');
            tbody.innerHTML = '';
            
            details.forEach(fund => {
                const tr = document.createElement('tr');
                const returnClass = fund.returnPct >= 0 ? 'positive' : 'negative';
                const returnSign = fund.returnPct >= 0 ? '+' : '';
                
                tr.innerHTML = `
                    <td><strong>${fund.name}</strong></td>
                    <td class="exact-number">${fund.units}</td>
                    <td class="exact-number">${fund.invested}</td>
                    <td class="exact-number">${fund.profitWithoutFees}</td>
                    <td class="exact-number">${fund.profitAfterFees}</td>
                    <td class="exact-number">${fund.avgPrice}</td>
                    <td class="exact-number">${fund.currentPrice}</td>
                    <td class="exact-number">${fund.currentValue}</td>
                    <td class="${returnClass}">${returnSign}${fund.returnPct.toFixed(2)}%</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============ PRICE MANAGEMENT ============
        function updatePrice() {
            const fund = getCurrentFund();
            if (!fund) {
                alert(lang === 'ar' ? 'اختر صندوق أولاً' : 'Select a fund first');
                return;
            }

            const price = document.getElementById('price-new').value.trim();
            const date = document.getElementById('price-date').value;

            if (!price || !date) {
                alert(lang === 'ar' ? 'الرجاء ملء البيانات الصحيحة' : 'Please fill in correct data');
                return;
            }

            fund.price = price;
            const existing = fund.priceHistory.find(p => p.date === date);
            if (existing) {
                existing.price = price;
            } else {
                fund.priceHistory.push({ date, price });
            }

            saveData();
            renderAll();
            document.getElementById('price-new').value = '';
        }

        // ============ AUTO UPDATE SYSTEM ============
        function setupAutoUpdate() {
            // تحميل الإعدادات المحفوظة
            loadAutoUpdateSettings();
            
            // التحقق من التحديث اليومي
            checkDailyUpdate();
            
            // إعداد المؤقت للتحديث اليومي
            setupDailyTimer();
        }

        function loadAutoUpdateSettings() {
            const settings = autoUpdateSettings;
            
            if (settings.url) {
                document.getElementById('auto-update-url').value = settings.url;
            }
            if (settings.elementCode) {
                document.getElementById('element-code').value = settings.elementCode;
            }
            if (settings.updateTime) {
                document.getElementById('update-time').value = settings.updateTime;
            }
            if (settings.lastUpdate) {
                document.getElementById('last-auto-update').textContent = 
                    `آخر تحديث: ${new Date(settings.lastUpdate).toLocaleString('ar-EG')}`;
            }
        }

        function saveAutoUpdateSettings() {
            const url = document.getElementById('auto-update-url').value.trim();
            const elementCode = document.getElementById('element-code').value.trim();
            const updateTime = document.getElementById('update-time').value;
            
            if (!url || !elementCode) {
                showAutoUpdateStatus('الرجاء إدخال رابط الموقع وكود العنصر', 'error');
                return;
            }
            
            autoUpdateSettings = {
                url,
                elementCode,
                updateTime,
                lastUpdate: new Date().toISOString()
            };
            
            localStorage.setItem('auto_update_settings', JSON.stringify(autoUpdateSettings));
            showAutoUpdateStatus('تم حفظ الإعدادات بنجاح', 'success');
            
            // تحديث عرض آخر تحديث
            document.getElementById('last-auto-update').textContent = 
                `آخر تحديث: ${new Date().toLocaleString('ar-EG')}`;
            
            // إعادة إعداد المؤقت
            setupDailyTimer();
        }

        function stopAutoUpdate() {
            if (autoUpdateTimer) {
                clearInterval(autoUpdateTimer);
                autoUpdateTimer = null;
            }
            
            autoUpdateSettings = {};
            localStorage.removeItem('auto_update_settings');
            
            document.getElementById('auto-update-url').value = '';
            document.getElementById('element-code').value = '.price-element';
            document.getElementById('update-time').value = '09:00';
            document.getElementById('last-auto-update').textContent = 'آخر تحديث: --';
            
            showAutoUpdateStatus('تم إيقاف التحديث التلقائي', 'success');
        }

        function showAutoUpdateStatus(message, type) {
            const statusEl = document.getElementById('auto-update-status');
            statusEl.textContent = message;
            statusEl.className = `auto-update-status ${type}`;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        async function testAutoUpdate() {
            const url = document.getElementById('auto-update-url').value;
            const elementCode = document.getElementById('element-code').value;
            
            if (!url || !elementCode) {
                showAutoUpdateStatus('الرجاء إدخال الرابط وكود العنصر', 'error');
                return;
            }
            
            try {
                // محاكاة جلب البيانات (في الإنتاج ستحتاج لاستخدام CORS proxy)
                const mockHTML = `<span class="price-element"> 1.448 EGP </span>`;
                const priceMatch = mockHTML.match(/\d+\.?\d*/);
                
                if (priceMatch) {
                    const price = priceMatch[0];
                    document.getElementById('price-new').value = price;
                    showAutoUpdateStatus(`تم العثور على السعر: ${price}`, 'success');
                    
                    // تحديث السعر الحالي للصندوق
                    const fund = getCurrentFund();
                    if (fund) {
                        const today = new Date().toISOString().split('T')[0];
                        fund.price = price;
                        
                        // إضافة إلى سجل الأسعار
                        const existing = fund.priceHistory.find(p => p.date === today);
                        if (existing) {
                            existing.price = price;
                        } else {
                            fund.priceHistory.push({ date: today, price });
                        }
                        
                        saveData();
                        renderAll();
                    }
                } else {
                    showAutoUpdateStatus('لم يتم العثور على السعر في الصفحة', 'error');
                }
            } catch (error) {
                showAutoUpdateStatus('خطأ في جلب البيانات: ' + error.message, 'error');
            }
        }

        function checkDailyUpdate() {
            const today = new Date().toISOString().split('T')[0];
            const fund = getCurrentFund();
            
            if (!fund || !autoUpdateSettings.url || !autoUpdateSettings.elementCode) {
                return;
            }
            
            // التحقق مما إذا تم تحديث السعر اليوم
            const todayPrice = fund.priceHistory.find(p => p.date === today);
            if (!todayPrice) {
                // لم يتم تحديث السعر اليوم، قم بالتحديث التلقائي
                performAutoUpdate();
            }
        }

        function setupDailyTimer() {
            if (autoUpdateTimer) {
                clearInterval(autoUpdateTimer);
            }
            
            if (!autoUpdateSettings.updateTime) {
                return;
            }
            
            // حساب الوقت المتبقي للتحديث اليومي
            const updateTime = autoUpdateSettings.updateTime;
            const now = new Date();
            const [hours, minutes] = updateTime.split(':').map(Number);
            const updateDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hours, minutes);
            
            if (now > updateDate) {
                updateDate.setDate(updateDate.getDate() + 1);
            }
            
            const timeUntilUpdate = updateDate.getTime() - now.getTime();
            
            // إعداد المؤقت
            autoUpdateTimer = setTimeout(() => {
                performAutoUpdate();
                setupDailyTimer(); // إعادة ضبط المؤقت للغد
            }, timeUntilUpdate);
        }

        async function performAutoUpdate() {
            if (!autoUpdateSettings.url || !autoUpdateSettings.elementCode) {
                return;
            }
            
            try {
                // محاكاة جلب السعر (في الإنتاج سيتم استخدام fetch مع CORS proxy)
                const mockPrice = (Math.random() * 2 + 1).toFixed(4);
                const today = new Date().toISOString().split('T')[0];
                
                const fund = getCurrentFund();
                if (fund) {
                    fund.price = mockPrice;
                    
                    // إضافة إلى سجل الأسعار
                    const existing = fund.priceHistory.find(p => p.date === today);
                    if (existing) {
                        existing.price = mockPrice;
                    } else {
                        fund.priceHistory.push({ date: today, price: mockPrice });
                    }
                    
                    saveData();
                    renderAll();
                    
                    // تحديث وقت آخر تحديث
                    autoUpdateSettings.lastUpdate = new Date().toISOString();
                    localStorage.setItem('auto_update_settings', JSON.stringify(autoUpdateSettings));
                    
                    document.getElementById('last-auto-update').textContent = 
                        `آخر تحديث: ${new Date().toLocaleString('ar-EG')}`;
                    
                    console.log('Auto update completed:', mockPrice);
                }
            } catch (error) {
                console.error('Auto update failed:', error);
            }
        }

        // ============ EXPORT PRICES ============
        function exportPricesPDF() {
            const fund = getCurrentFund();
            if (!fund) {
                alert(lang === 'ar' ? 'اختر صندوق أولاً' : 'Select a fund first');
                return;
            }

            const sorted = [...fund.priceHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = `
                <div style="padding: 20px; font-family: 'Cairo', Arial; direction: rtl">
                    <h2 style="text-align: center; color: #000B58; margin-bottom: 30px;">
                        ${lang === 'ar' ? 'قاعدة بيانات الأسعار' : 'Prices Database'} - ${fund.name} (${fund.code})
                    </h2>
                    
                    <div style="margin-bottom: 20px; background: #f5f7fa; padding: 15px; border-radius: 8px;">
                        <p><strong>${lang === 'ar' ? 'عدد الأسعار:' : 'Prices Count:'}</strong> ${sorted.length}</p>
                        <p><strong>${lang === 'ar' ? 'تاريخ التصدير:' : 'Export Date:'}</strong> ${new Date().toLocaleString(lang === 'ar' ? 'ar-EG' : 'en-US')}</p>
                        <p><strong>${lang === 'ar' ? 'أحدث سعر:' : 'Latest Price:'}</strong> ${fund.price}</p>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
                        <thead>
                            <tr style="background: #000B58; color: white;">
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">${lang === 'ar' ? 'التاريخ' : 'Date'}</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">${lang === 'ar' ? 'السعر' : 'Price'}</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">${lang === 'ar' ? 'التغير %' : 'Change %'}</th>
                                <th style="padding: 12px; border: 1px solid #ddd; text-align: right;">${lang === 'ar' ? 'الحالة' : 'Status'}</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            sorted.forEach((entry, idx) => {
                const prev = idx < sorted.length - 1 ? parseFloat(sorted[idx + 1].price) : parseFloat(entry.price);
                const current = parseFloat(entry.price);
                const change = ((current - prev) / prev) * 100;
                const statusIcon = change > 0.1 ? '↑' : change < -0.1 ? '↓' : '→';
                const statusText = change > 0.1 ? lang === 'ar' ? 'ارتفاع' : 'Up' : change < -0.1 ? lang === 'ar' ? 'انخفاض' : 'Down' : lang === 'ar' ? 'مستقر' : 'Stable';
                const changeColor = change >= 0 ? '#006A67' : '#D32F2F';
                
                html += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px; border: 1px solid #ddd;">${entry.date}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; font-family: 'Courier New', monospace;">${entry.price}</td>
                        <td style="padding: 10px; border: 1px solid #ddd; color: ${changeColor}; font-family: 'Courier New', monospace;">${change >= 0 ? '+' : ''}${change.toFixed(4)}%</td>
                        <td style="padding: 10px; border: 1px solid #ddd;">${statusIcon} ${statusText}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #000B58; font-size: 12px; color: #666; text-align: center;">
                        <p>${lang === 'ar' ? 'تم إنشاء هذا التقرير بواسطة ان - دار استثمار' : 'Generated by InDar Tracker'}</p>
                        <p>${new Date().toLocaleString(lang === 'ar' ? 'ar-EG' : 'en-US')}</p>
                    </div>
                </div>
            `;
            
            const element = document.createElement('div');
            element.innerHTML = html;
            
            const opt = {
                margin: 10,
                filename: `prices-database-${fund.code}-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, backgroundColor: '#fff' },
                jsPDF: { orientation: 'p', unit: 'mm', format: 'a4' }
            };
            
            html2pdf().set(opt).from(element).save();
        }

        function exportPricesJSON() {
            const fund = getCurrentFund();
            if (!fund) {
                alert(lang === 'ar' ? 'اختر صندوق أولاً' : 'Select a fund first');
                return;
            }

            const data = {
                fund: {
                    name: fund.name,
                    code: fund.code,
                    prices: fund.priceHistory
                },
                exportDate: new Date().toISOString(),
                version: '1.0'
            };
            
            downloadFile(JSON.stringify(data, null, 2), `prices-${fund.code}-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
        }

        // ============ CHARTS ============
        function destroyChart(chartId) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
                delete chartInstances[chartId];
            }
        }

        function createPriceChart() {
            const fund = getCurrentFund();
            if (!fund || !fund.priceHistory) return;

            destroyChart('priceChart');
            const sorted = [...fund.priceHistory].sort((a, b) => new Date(a.date) - new Date(b.date));
            const ctx = document.getElementById('priceChart');
            if (!ctx) return;

            chartInstances['priceChart'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map((p, i) => i % 2 === 0 ? new Date(p.date).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US') : ''),
                    datasets: [{
                        label: fund.name,
                        data: sorted.map(p => parseFloat(p.price)),
                        borderColor: 'var(--primary)',
                        backgroundColor: 'rgba(0, 11, 88, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: 'var(--accent)',
                        pointBorderColor: 'var(--primary)',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            labels: { 
                                color: theme === 'dark' ? '#e0e0e0' : '#333', 
                                font: { size: 13 } 
                            } 
                        } 
                    },
                    scales: { 
                        y: { 
                            beginAtZero: false,
                            ticks: {
                                color: theme === 'dark' ? '#e0e0e0' : '#666'
                            }
                        }, 
                        x: { 
                            grid: { display: false },
                            ticks: {
                                color: theme === 'dark' ? '#e0e0e0' : '#666'
                            }
                        } 
                    }
                }
            });
        }

        function createPortfolioChart() {
            destroyChart('portfolioChart');
            const colorPalette = ['#000B58', '#003161', '#006A67', '#00509E', '#FDEB9E'];
            
            const data = funds.map(f => {
                const m = calculateMetrics(f);
                return m.value;
            });

            const ctx = document.getElementById('portfolioChart');
            if (!ctx) return;

            chartInstances['portfolioChart'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: funds.map(f => f.code),
                    datasets: [{
                        data: data,
                        backgroundColor: colorPalette,
                        borderColor: theme === 'dark' ? '#14142E' : 'white',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { 
                            position: 'bottom', 
                            labels: { 
                                color: theme === 'dark' ? '#e0e0e0' : '#333', 
                                font: { size: 12 } 
                            } 
                        } 
                    }
                }
            });
        }

        function createMonthlyChart() {
            destroyChart('monthlyChart');
            const monthlyData = {};

            funds.forEach(fund => {
                fund.transactions.forEach(tx => {
                    const date = new Date(tx.date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyData[monthKey]) monthlyData[monthKey] = 0;
                    const amount = parseFloat(tx.units) * parseFloat(tx.price);
                    monthlyData[monthKey] += amount;
                });
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const ctx = document.getElementById('monthlyChart');
            if (!ctx) return;

            chartInstances['monthlyChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: lang === 'ar' ? 'المعاملات الشهرية' : 'Monthly Transactions',
                        data: sortedMonths.map(m => monthlyData[m]),
                        backgroundColor: '#000B58',
                        borderColor: '#003161',
                        borderWidth: 2
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: {
                                color: theme === 'dark' ? '#e0e0e0' : '#666'
                            }
                        },
                        x: {
                            ticks: {
                                color: theme === 'dark' ? '#e0e0e0' : '#666'
                            }
                        }
                    }
                }
            });
        }

        function createReturnChart() {
            destroyChart('returnChart');
            const fundReturns = funds.map(fund => {
                const m = calculateMetrics(fund);
                return m.returnPct;
            });

            const ctx = document.getElementById('returnChart');
            if (!ctx) return;

            chartInstances['returnChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: funds.map(f => f.code),
                    datasets: [{
                        label: lang === 'ar' ? 'العائد %' : 'Return %',
                        data: fundReturns,
                        backgroundColor: fundReturns.map(r => r >= 0 ? '#006A67' : '#D32F2F'),
                        borderWidth: 1
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            ticks: {
                                color: theme === 'dark' ? '#e0e0e0' : '#666'
                            }
                        },
                        x: {
                            ticks: {
                                color: theme === 'dark' ? '#e0e0e0' : '#666'
                            }
                        }
                    }
                }
            });
        }

        function updateStatistics() {
            const totalTx = funds.reduce((sum, f) => sum + f.transactions.length, 0);
            let best = { code: '--', value: -999 };
            let worst = { code: '--', value: 999 };

            funds.forEach(f => {
                const m = calculateMetrics(f);
                if (m.returnPct > best.value) best = { code: f.code, value: m.returnPct };
                if (m.returnPct < worst.value) worst = { code: f.code, value: m.returnPct };
            });

            document.getElementById('stats-funds').textContent = funds.length;
            document.getElementById('stats-transactions').textContent = totalTx;
            document.getElementById('stats-best').textContent = best.value === -999 ? '--' : `${best.code} (${best.value.toFixed(2)}%)`;
            document.getElementById('stats-worst').textContent = worst.value === 999 ? '--' : `${worst.code} (${worst.value.toFixed(2)}%)`;
        }

        function updateAllCharts() {
            createPriceChart();
            createPortfolioChart();
            createMonthlyChart();
            createReturnChart();
            updateStatistics();
        }

        // ============ EXPORT/IMPORT ============
        function formatDisplay(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return num.toString();
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportJSON() {
            const data = { funds, timestamp: new Date().toISOString() };
            downloadFile(JSON.stringify(data, null, 2), `investment-backup-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
        }

        function exportCSV() {
            let csv = lang === 'ar' ? 'الصندوق,الكود,التاريخ,النوع,الوثائق,السعر,المبلغ,الرسوم\n' : 'Fund,Code,Date,Type,Units,Price,Amount,Fees\n';
            funds.forEach(f => {
                f.transactions.forEach(tx => {
                    const amount = parseFloat(tx.units) * parseFloat(tx.price);
                    const fee = tx.type === 'buy' ? amount * (f.subscriptionFee / 100) : amount * (f.redemptionFee / 100);
                    csv += `"${f.name}","${f.code}","${tx.date}","${tx.type === 'buy' ? labels[lang].buy : labels[lang].sell}","${tx.units}","${tx.price}","${amount}","${fee}"\n`;
                });
            });
            downloadFile(csv, `investment-backup-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        }

        function exportPDF() {
            const fund = getCurrentFund();
            if (!fund) {
                alert(lang === 'ar' ? 'اختر صندوق أولاً' : 'Select a fund first');
                return;
            }

            const m = calculateMetrics(fund);
            const html = `
<!DOCTYPE html>
<html lang="${lang}">
<head>
    <meta charset="UTF-8">
    <title>${lang === 'ar' ? 'تقرير الاستثمار' : 'Investment Report'}</title>
    <style>
        body { font-family: Arial, sans-serif; direction: rtl; }
        .container { max-width: 800px; margin: 40px auto; }
        .header { text-align: center; border-bottom: 3px solid #000B58; padding-bottom: 20px; margin-bottom: 30px; }
        .header h1 { color: #000B58; margin: 0; }
        .header p { color: #003161; margin: 5px 0; }
        .metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .metric { background: #f5f7fa; padding: 15px; border-radius: 8px; text-align: center; }
        .metric-label { font-size: 12px; color: #666; }
        .metric-value { font-size: 24px; font-weight: bold; color: #000B58; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th { background: #000B58; color: white; padding: 12px; text-align: right; }
        td { padding: 10px; border-bottom: 1px solid #ddd; text-align: right; }
        .section-title { font-size: 16px; font-weight: bold; color: #000B58; margin-top: 30px; margin-bottom: 10px; }
        .footer { text-align: center; margin-top: 40px; color: #999; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>${lang === 'ar' ? 'تقرير الاستثمار' : 'Investment Report'}</h1>
            <p>${fund.name} (${fund.code})</p>
        </div>

        <div class="metrics">
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'إجمالي الوثائق' : 'Total Units'}</div>
                <div class="metric-value">${formatDisplay(m.units)}</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'متوسط الشراء' : 'Avg Buy'}</div>
                <div class="metric-value">${formatDisplay(m.avgPrice)}</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'السعر الحالي' : 'Current Price'}</div>
                <div class="metric-value">${formatDisplay(fund.price)}</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'القيمة الحالية' : 'Current Value'}</div>
                <div class="metric-value">${formatDisplay(m.value)}</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'إجمالي الاستثمار' : 'Total Invested'}</div>
                <div class="metric-value">${formatDisplay(m.invested)}</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'الربح/الخسارة' : 'Profit/Loss'}</div>
                <div class="metric-value" style="color: ${m.profit >= 0 ? '#006A67' : '#D32F2F'};">${formatDisplay(m.profit)}</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'العائد %' : 'Return %'}</div>
                <div class="metric-value" style="color: ${m.returnPct >= 0 ? '#006A67' : '#D32F2F'};">${formatDisplay(m.returnPct)}%</div>
            </div>
            <div class="metric">
                <div class="metric-label">${lang === 'ar' ? 'تاريخ الإنشاء' : 'Export Date'}</div>
                <div class="metric-value">${new Date().toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US')}</div>
            </div>
        </div>

        <div class="section-title">${lang === 'ar' ? 'المعاملات' : 'Transactions'}</div>
        <table>
            <thead>
                <tr>
                    <th>${lang === 'ar' ? 'التاريخ' : 'Date'}</th>
                    <th>${lang === 'ar' ? 'النوع' : 'Type'}</th>
                    <th>${lang === 'ar' ? 'الوثائق' : 'Units'}</th>
                    <th>${lang === 'ar' ? 'السعر' : 'Price'}</th>
                    <th>${lang === 'ar' ? 'المبلغ' : 'Amount'}</th>
                </tr>
            </thead>
            <tbody>
                ${fund.transactions.map(tx => {
                    const amount = parseFloat(tx.units) * parseFloat(tx.price);
                    return `<tr>
                        <td>${tx.date}</td>
                        <td>${tx.type === 'buy' ? labels[lang].buy : labels[lang].sell}</td>
                        <td>${formatDisplay(tx.units)}</td>
                        <td>${formatDisplay(tx.price)}</td>
                        <td>${formatDisplay(amount)}</td>
                    </tr>`;
                }).join('')}
            </tbody>
        </table>

        <div class="footer">
            <p>${lang === 'ar' ? 'تم إنشاء هذا التقرير بواسطة ان - دار استثمار' : 'Generated by InDar Tracker'}</p>
            <p>${new Date().toLocaleString(lang === 'ar' ? 'ar-EG' : 'en-US')}</p>
        </div>
    </div>
</body>
</html>
            `;

            const element = document.createElement('div');
            element.innerHTML = html;
            const opt = {
                margin: 10,
                filename: `investment-report-${fund.code}-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, backgroundColor: '#fff' },
                jsPDF: { orientation: 'p', unit: 'mm', format: 'a4' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function importFile() {
            const file = document.getElementById('import-file').files[0];
            if (!file) {
                alert(lang === 'ar' ? 'اختر ملف أولاً' : 'Choose a file first');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    funds = data.funds || [];
                    currentFundId = funds[0]?.id;
                    saveData();
                    renderAll();
                    alert(lang === 'ar' ? 'تم الاستيراد بنجاح' : 'Imported successfully');
                    document.getElementById('import-file').value = '';
                } catch (err) {
                    alert(lang === 'ar' ? 'خطأ في الملف' : 'File error');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (!confirm(lang === 'ar' ? 'هل تريد حذف جميع البيانات؟' : 'Delete all data?')) return;
            funds = [];
            currentFundId = null;
            saveData();
            renderAll();
        }

        // ============ DATA ============
        function saveData() {
            localStorage.setItem('investment_app', JSON.stringify({ funds, currentFundId }));
        }

        function loadData() {
            const data = JSON.parse(localStorage.getItem('investment_app') || '{"funds":[],"currentFundId":null}');
            funds = data.funds || [];
            currentFundId = data.currentFundId || funds[0]?.id;
            
            if (funds.length === 0) {
                funds = [{
                    id: '1',
                    name: lang === 'ar' ? 'صندوق عزيموت' : 'Azimut Fund',
                    code: 'AZM',
                    price: '1.42',
                    subscriptionFee: 1,
                    redemptionFee: 2,
                    transactions: [
                        { date: '2025-11-01', type: 'buy', units: '100', price: '1.35' },
                        { date: '2025-11-15', type: 'buy', units: '50', price: '1.40' },
                        { date: '2025-12-01', type: 'sell', units: '30', price: '1.45' }
                    ],
                    priceHistory: [
                        { date: '2025-10-31', price: '1.35' },
                        { date: '2025-11-02', price: '1.37' },
                        { date: '2025-11-04', price: '1.38' },
                        { date: '2025-11-06', price: '1.3533' },
                        { date: '2025-11-08', price: '1.454545' },
                        { date: '2025-11-10', price: '1.41' },
                        { date: '2025-11-12', price: '1.40' },
                        { date: '2025-11-14', price: '1.43' },
                        { date: '2025-11-16', price: '1.43' },
                        { date: '2025-11-18', price: '1.45' },
                        { date: '2025-11-20', price: '1.44' },
                        { date: '2025-11-22', price: '1.44' },
                        { date: '2025-11-24', price: '1.44' },
                        { date: '2025-11-26', price: '1.41' },
                        { date: '2025-11-28', price: '1.42' }
                    ]
                }];
                currentFundId = '1';
                saveData();
            }
        }

        // ============ HELPERS ============
        function getCurrentFund() {
            return funds.find(f => f.id === currentFundId);
        }

        function renderAll() {
            renderFundSelector();
            updatePortfolio();
            renderTransactionsTable();
            renderFundsTable();
            updateAdvancedAnalytics();
            updateGeneralInfo();
            updateBackupInfo();
            updateTranslations();
            if (currentFundId) {
                updateAllCharts();
            }
        }

        function updateBackupInfo() {
            let totalTx = 0;
            funds.forEach(f => totalTx += f.transactions.length);
            document.getElementById('info-funds').textContent = funds.length;
            document.getElementById('info-transactions').textContent = totalTx;
            document.getElementById('info-updated').textContent = new Date().toLocaleString(lang === 'ar' ? 'ar-EG' : 'en-US');
        }

        // ============ START ============
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>