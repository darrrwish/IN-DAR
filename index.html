<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام تتبع الاستثمارات</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #F2EDD1;
            --secondary: #F9CB99;
            --accent: #280A3E;
            --green: #689B8A;
            --light-bg: #F2EDD1;
            --dark-bg: #1a0f1e;
            --text-light: #2c2c2c;
            --text-dark: #e0e0e0;
            --border-light: #e0d5c7;
            --border-dark: #3a2950;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
        }

        html {
            font-family: 'Cairo', sans-serif;
            font-size: 14px;
            scroll-behavior: smooth;
        }

        body {
            background: var(--light-bg);
            color: var(--text-light);
            transition: all 0.4s ease;
            line-height: 1.6;
        }

        body[data-theme="dark"] {
            background: var(--dark-bg);
            color: var(--text-dark);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            border-bottom: 3px solid var(--green);
            padding: 16px 0;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        body[data-theme="dark"] .header {
            background: #2a1f35;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header-left h1 {
            font-size: 24px;
            color: var(--accent);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }

        body[data-theme="dark"] .header-left h1 {
            color: var(--secondary);
        }

        .header-left p {
            font-size: 13px;
            color: var(--green);
            margin: 0;
            font-weight: 600;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .btn-icon {
            background: var(--green);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 10px 16px;
            cursor: pointer;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
            font-family: 'Cairo', sans-serif;
            font-weight: 500;
        }

        .btn-icon:hover {
            background: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-icon.secondary {
            background: var(--secondary);
            color: var(--accent);
        }

        .btn-icon.secondary:hover {
            background: #f0c67e;
        }

        .btn-icon.danger {
            background: var(--danger);
        }

        .btn-icon.danger:hover {
            background: #dc2626;
        }

        .btn-icon.success {
            background: var(--success);
        }

        .btn-icon.success:hover {
            background: #059669;
        }

        /* Tabs */
        .tabs-container {
            display: flex;
            gap: 0;
            margin-bottom: 24px;
            border-bottom: 2px solid var(--border-light);
            padding-bottom: 0;
            flex-wrap: wrap;
            overflow-x: auto;
        }

        body[data-theme="dark"] .tabs-container {
            border-bottom-color: var(--border-dark);
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 14px 18px;
            font-size: 13px;
            cursor: pointer;
            color: #999;
            font-family: 'Cairo', sans-serif;
            font-weight: 500;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            margin-bottom: -2px;
        }

        .tab-btn.active {
            color: var(--green);
            border-bottom-color: var(--green);
        }

        .tab-btn:hover {
            color: var(--accent);
        }

        /* Content */
        .content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Card */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }

        body[data-theme="dark"] .card {
            background: #2a1f35;
        }

        .card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        body[data-theme="dark"] .card-title {
            color: var(--secondary);
        }

        /* Grid */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        @media (max-width: 1024px) {
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
            .grid-2 { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .grid-2, .grid-4 { grid-template-columns: 1fr; }
            .header-controls { gap: 6px; }
            .btn-icon { padding: 8px 10px; font-size: 12px; }
            .btn-icon span { display: none; }
        }

        /* Metric Box */
        .metric-box {
            background: linear-gradient(135deg, var(--green) 0%, var(--accent) 100%);
            color: white;
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .metric-box.secondary {
            background: linear-gradient(135deg, var(--secondary) 0%, #f0c67e 100%);
            color: var(--accent);
        }

        .metric-box.success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
        }

        .metric-box.danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
        }

        .metric-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            font-weight: 500;
        }

        .metric-value {
            font-size: 26px;
            font-weight: 700;
            word-break: break-word;
        }

        /* Form */
        .form-group {
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-light);
            font-size: 13px;
        }

        body[data-theme="dark"] .form-group label {
            color: var(--text-dark);
        }

        .form-group input,
        .form-group select {
            padding: 10px 12px;
            border: 2px solid var(--border-light);
            border-radius: 8px;
            font-size: 14px;
            font-family: 'Cairo', sans-serif;
            background: white;
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        body[data-theme="dark"] .form-group input,
        body[data-theme="dark"] .form-group select {
            background: #3a2950;
            color: var(--text-dark);
            border-color: var(--border-dark);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--green);
            box-shadow: 0 0 0 3px rgba(104, 155, 138, 0.1);
        }

        /* Table */
        .table-responsive {
            overflow-x: auto;
            margin-bottom: 16px;
            border-radius: 8px;
            -webkit-overflow-scrolling: touch;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        body[data-theme="dark"] table {
            background: #2a1f35;
        }

        th {
            background: var(--green);
            color: white;
            padding: 12px;
            text-align: right;
            font-weight: 600;
            font-size: 13px;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid var(--border-light);
            font-size: 13px;
            color: var(--text-light);
        }

        body[data-theme="dark"] td {
            border-bottom-color: var(--border-dark);
            color: var(--text-dark);
        }

        tr:hover {
            background: #f5f5f5;
        }

        body[data-theme="dark"] tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .positive {
            color: var(--success);
            font-weight: 600;
        }

        .negative {
            color: var(--danger);
            font-weight: 600;
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 320px;
            margin-bottom: 16px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        body[data-theme="dark"] .modal-content {
            background: #2a1f35;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-light);
        }

        body[data-theme="dark"] .modal-header {
            border-bottom-color: var(--border-dark);
        }

        .modal-header h2 {
            color: var(--accent);
            font-size: 18px;
            font-weight: 600;
        }

        body[data-theme="dark"] .modal-header h2 {
            color: var(--secondary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        body[data-theme="dark"] .modal-close {
            color: #999;
        }

        /* Button Row */
        .button-row {
            display: flex;
            gap: 10px;
            margin-top: 16px;
            flex-wrap: wrap;
        }

        .button-row .btn-icon {
            flex: 1;
            justify-content: center;
            min-width: 100px;
        }

        /* Print Styles */
        @media print {
            .header, .tabs-container, .button-row, .modal {
                display: none !important;
            }
            .card {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body data-theme="light" data-lang="ar">
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-left">
                    <h1><i class="fas fa-chart-line"></i> نظام تتبع الاستثمارات</h1>
                    <p id="current-fund-display">--</p>
                </div>
                <div class="header-controls">
                    <select id="fund-select" style="padding: 10px 12px; border: 2px solid var(--green); border-radius: 8px; font-family: Cairo; font-size: 13px;"></select>
                    <button class="btn-icon secondary" onclick="toggleTheme()" title="تبديل المظهر">
                        <i class="fas fa-moon" id="theme-icon"></i>
                    </button>
                    <button class="btn-icon secondary" onclick="toggleLanguage()" title="تبديل اللغة">
                        <i class="fas fa-language"></i>
                    </button>
                    <button class="btn-icon" onclick="showAddFundModal()" title="إضافة صندوق جديد">
                        <i class="fas fa-plus"></i> <span>إضافة</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs-container">
            <button class="tab-btn active" onclick="switchTab('dashboard')">
                <i class="fas fa-chart-pie"></i> <span>لوحة التحكم</span>
            </button>
            <button class="tab-btn" onclick="switchTab('transactions')">
                <i class="fas fa-exchange-alt"></i> <span>المعاملات</span>
            </button>
            <button class="tab-btn" onclick="switchTab('funds')">
                <i class="fas fa-list"></i> <span>الصناديق</span>
            </button>
            <button class="tab-btn" onclick="switchTab('prices')">
                <i class="fas fa-tag"></i> <span>الأسعار</span>
            </button>
            <button class="tab-btn" onclick="switchTab('analytics')">
                <i class="fas fa-chart-bar"></i> <span>التحليلات</span>
            </button>
            <button class="tab-btn" onclick="switchTab('export')">
                <i class="fas fa-download"></i> <span>التصدير</span>
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="content active">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-wallet"></i> ملخص المحفظة
                </div>
                <div class="grid-4">
                    <div class="metric-box">
                        <div class="metric-label"><i class="fas fa-cubes"></i> إجمالي الوثائق</div>
                        <div class="metric-value" id="total-units">0</div>
                    </div>
                    <div class="metric-box secondary">
                        <div class="metric-label"><i class="fas fa-coins"></i> متوسط الشراء</div>
                        <div class="metric-value" id="avg-price">0.00</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label"><i class="fas fa-tag"></i> السعر الحالي</div>
                        <div class="metric-value" id="current-price">0.00</div>
                    </div>
                    <div class="metric-box" id="value-box">
                        <div class="metric-label"><i class="fas fa-dollar-sign"></i> القيمة الحالية</div>
                        <div class="metric-value" id="current-value">0.00</div>
                    </div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-title"><i class="fas fa-chart-area"></i> أداء المحفظة</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <div>
                            <div style="font-size: 11px; color: #999; margin-bottom: 4px;"><i class="fas fa-arrow-up"></i> إجمالي الاستثمار</div>
                            <div style="font-size: 18px; font-weight: 700; color: var(--green);" id="total-invested">0.00</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #999; margin-bottom: 4px;"><i class="fas fa-trophy"></i> الربح/الخسارة</div>
                            <div style="font-size: 18px; font-weight: 700;" id="net-profit">0.00</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #999; margin-bottom: 4px;"><i class="fas fa-percent"></i> العائد %</div>
                            <div style="font-size: 18px; font-weight: 700;" id="return-pct">0.00%</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: #999; margin-bottom: 4px;"><i class="fas fa-clock"></i> آخر تحديث</div>
                            <div style="font-size: 13px; font-weight: 600;" id="last-update">--</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-lightbulb"></i> التوصية</div>
                    <div id="recommendation" style="padding: 20px; text-align: center; background: #f0f0f0; border-radius: 8px; color: #666; font-weight: 500;">
                        <i class="fas fa-info-circle"></i> احسب البيانات
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title"><i class="fas fa-history"></i> تاريخ الأسعار</div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th><i class="fas fa-calendar"></i> التاريخ</th>
                                <th><i class="fas fa-tag"></i> السعر</th>
                                <th><i class="fas fa-arrow-up-down"></i> التغير %</th>
                                <th><i class="fas fa-circle"></i> الحالة</th>
                            </tr>
                        </thead>
                        <tbody id="price-history-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Transactions Tab -->
        <div id="transactions" class="content">
            <div class="card">
                <div class="card-title"><i class="fas fa-plus-circle"></i> إضافة معاملة</div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>التاريخ</label>
                        <input type="date" id="tx-date">
                    </div>
                    <div class="form-group">
                        <label>النوع</label>
                        <select id="tx-type">
                            <option value="buy">شراء</option>
                            <option value="sell">بيع</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>عدد الوثائق</label>
                        <input type="number" id="tx-units" placeholder="0" step="1">
                    </div>
                    <div class="form-group">
                        <label>سعر الوثيقة</label>
                        <input type="number" id="tx-price" placeholder="0.00" step="0.01">
                    </div>
                </div>
                <div class="button-row">
                    <button class="btn-icon success" onclick="addTransaction()"><i class="fas fa-check"></i> <span>إضافة</span></button>
                    <button class="btn-icon" onclick="clearTxForm()"><i class="fas fa-redo"></i> <span>مسح</span></button>
                </div>
            </div>

            <div class="card">
                <div class="card-title"><i class="fas fa-list"></i> سجل المعاملات</div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th><i class="fas fa-calendar"></i> التاريخ</th>
                                <th><i class="fas fa-exchange-alt"></i> النوع</th>
                                <th><i class="fas fa-cubes"></i> الوثائق</th>
                                <th><i class="fas fa-tag"></i> السعر</th>
                                <th><i class="fas fa-money-bill"></i> المبلغ</th>
                                <th><i class="fas fa-percent"></i> الرسوم</th>
                                <th><i class="fas fa-trash"></i> حذف</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Funds Tab -->
        <div id="funds" class="content">
            <div class="card">
                <div class="card-title"><i class="fas fa-list"></i> قائمة الصناديق</div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th><i class="fas fa-info"></i> الاسم</th>
                                <th><i class="fas fa-code"></i> الكود</th>
                                <th><i class="fas fa-tag"></i> السعر</th>
                                <th><i class="fas fa-exchange-alt"></i> رسوم</th>
                                <th><i class="fas fa-trash"></i> حذف</th>
                            </tr>
                        </thead>
                        <tbody id="funds-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Prices Tab -->
        <div id="prices" class="content">
            <div class="card">
                <div class="card-title"><i class="fas fa-calendar-alt"></i> تاريخ اليوم: <span id="today-date" style="color: var(--green); font-weight: 700;">--</span></div>
            </div>

            <div class="card">
                <div class="card-title"><i class="fas fa-edit"></i> تحديث سعر الوثيقة</div>
                <div class="grid-2">
                    <div class="form-group">
                        <label>اسم الصندوق</label>
                        <input type="text" id="price-fund-name" readonly style="background: #f0f0f0; cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label>السعر الجديد</label>
                        <input type="number" id="price-new" placeholder="0.00" step="0.01">
                    </div>
                </div>
                <div class="form-group">
                    <label>التاريخ</label>
                    <input type="date" id="price-date">
                </div>
                <div class="button-row">
                    <button class="btn-icon success" onclick="updatePrice()"><i class="fas fa-check"></i> <span>تحديث</span></button>
                </div>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div id="analytics" class="content">
            <div class="grid-2">
                <div class="card">
                    <div class="card-title"><i class="fas fa-chart-line"></i> تطور الأسعار</div>
                    <div class="chart-container">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-pie-chart"></i> توزيع المحفظة</div>
                    <div class="chart-container">
                        <canvas id="portfolioChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <div class="card-title"><i class="fas fa-chart-area"></i> الأداء الشهري</div>
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title"><i class="fas fa-percent"></i> العائد على الاستثمار</div>
                    <div class="chart-container">
                        <canvas id="returnChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title"><i class="fas fa-chart-bar"></i> إحصائيات شاملة</div>
                <div class="grid-2">
                    <div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 8px;"><i class="fas fa-list"></i> عدد الصناديق</div>
                        <div style="font-size: 28px; font-weight: 700; color: var(--green);" id="stats-funds-count">0</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 8px;"><i class="fas fa-exchange-alt"></i> عدد المعاملات</div>
                        <div style="font-size: 28px; font-weight: 700; color: var(--green);" id="stats-tx-count">0</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 8px;"><i class="fas fa-trophy"></i> أفضل أداء</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--success);" id="stats-best-fund">--</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 8px;"><i class="fas fa-exclamation-triangle"></i> أسوأ أداء</div>
                        <div style="font-size: 18px; font-weight: 700; color: var(--danger);" id="stats-worst-fund">--</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export Tab -->
        <div id="export" class="content">
            <div class="card">
                <div class="card-title"><i class="fas fa-download"></i> تصدير البيانات</div>
                <div class="button-row">
                    <button class="btn-icon" onclick="exportJSON()"><i class="fas fa-database"></i> <span>JSON</span></button>
                    <button class="btn-icon" onclick="exportCSV()"><i class="fas fa-file-csv"></i> <span>CSV</span></button>
                    <button class="btn-icon" onclick="exportExcel()"><i class="fas fa-file-excel"></i> <span>Excel</span></button>
                    <button class="btn-icon" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> <span>PDF</span></button>
                </div>
            </div>

            <div class="card">
                <div class="card-title"><i class="fas fa-upload"></i> استيراد البيانات</div>
                <div class="form-group">
                    <label>اختر ملف</label>
                    <input type="file" id="import-file" accept=".json,.csv,.xlsx">
                </div>
                <div class="button-row">
                    <button class="btn-icon success" onclick="importFile()"><i class="fas fa-check"></i> <span>استيراد</span></button>
                    <button class="btn-icon danger" onclick="clearAllData()"><i class="fas fa-trash"></i> <span>مسح الكل</span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Fund Modal -->
    <div id="fundModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-plus-circle"></i> إضافة صندوق جديد</h2>
                <button class="modal-close" onclick="closeFundModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>اسم الصندوق</label>
                <input type="text" id="fund-name" placeholder="">
            </div>
            <div class="form-group">
                <label>كود الصندوق</label>
                <input type="text" id="fund-code" placeholder="">
            </div>
            <div class="form-group">
                <label>السعر الحالي</label>
                <input type="number" id="fund-price" placeholder="0.00" step="0.01">
            </div>
            <div class="grid-2">
                <div class="form-group">
                    <label>رسوم الاكتتاب % (شراء)</label>
                    <input type="number" id="fund-sub-fee" placeholder="0.00" step="0.01" value="0">
                </div>
                <div class="form-group">
                    <label>رسوم الاسترداد % (بيع)</label>
                    <input type="number" id="fund-red-fee" placeholder="0.00" step="0.01" value="0">
                </div>
            </div>
            <div class="button-row">
                <button class="btn-icon success" onclick="addFund()"><i class="fas fa-check"></i> <span>إضافة</span></button>
                <button class="btn-icon danger" onclick="closeFundModal()"><i class="fas fa-times"></i> <span>إلغاء</span></button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        // ============ STATE ============
        let funds = [];
        let currentFundId = null;
        let lang = localStorage.getItem('app_lang') || 'ar';
        let theme = localStorage.getItem('app_theme') || 'light';
        let chartInstances = {};

        // ============ INIT ============
        function init() {
            loadData();
            applyTheme(theme);
            applyLang(lang);
            setToday();
            renderAll();
            Chart.defaults.font.family = "'Cairo', sans-serif";
            Chart.defaults.color = theme === 'dark' ? '#e0e0e0' : '#666';
        }

        function setToday() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tx-date').value = today;
            document.getElementById('price-date').value = today;
            const dateStr = new Date(today).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US');
            document.getElementById('today-date').textContent = dateStr;
        }

        // ============ THEME ============
        function applyTheme(newTheme) {
            theme = newTheme;
            document.body.setAttribute('data-theme', theme);
            document.getElementById('theme-icon').className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            localStorage.setItem('app_theme', theme);
            Chart.defaults.color = theme === 'dark' ? '#e0e0e0' : '#666';
            updateAllCharts();
        }

        function toggleTheme() {
            applyTheme(theme === 'light' ? 'dark' : 'light');
        }

        // ============ LANGUAGE ============
        function applyLang(newLang) {
            lang = newLang;
            document.body.setAttribute('data-lang', lang);
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            localStorage.setItem('app_lang', lang);
        }

        function toggleLanguage() {
            applyLang(lang === 'ar' ? 'en' : 'ar');
        }

        // ============ TABS ============
        function switchTab(tabName) {
            document.querySelectorAll('.content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.closest('.tab-btn').classList.add('active');
            
            if (tabName === 'analytics') {
                setTimeout(() => updateAllCharts(), 100);
            }
        }

        // ============ FUNDS ============
        function showAddFundModal() {
            document.getElementById('fundModal').classList.add('active');
        }

        function closeFundModal() {
            document.getElementById('fundModal').classList.remove('active');
            document.getElementById('fund-name').value = '';
            document.getElementById('fund-code').value = '';
            document.getElementById('fund-price').value = '';
            document.getElementById('fund-sub-fee').value = '0';
            document.getElementById('fund-red-fee').value = '0';
        }

        function addFund() {
            const name = document.getElementById('fund-name').value.trim();
            const code = document.getElementById('fund-code').value.trim().toUpperCase();
            const price = parseFloat(document.getElementById('fund-price').value) || 0;
            const subFee = parseFloat(document.getElementById('fund-sub-fee').value) || 0;
            const redFee = parseFloat(document.getElementById('fund-red-fee').value) || 0;

            if (!name || !code || price <= 0) {
                alert('الرجاء ملء البيانات الصحيحة');
                return;
            }

            const fund = {
                id: Date.now().toString(),
                name, code, price,
                subscriptionFee: subFee,
                redemptionFee: redFee,
                transactions: [],
                priceHistory: [{ date: new Date().toISOString().split('T')[0], price }]
            };

            funds.push(fund);
            currentFundId = fund.id;
            saveData();
            renderAll();
            closeFundModal();
        }

        function deleteFund(id) {
            if (funds.length === 1) {
                alert('لا يمكن حذف الصندوق الوحيد');
                return;
            }
            if (!confirm('هل تريد حذف الصندوق؟')) return;

            funds = funds.filter(f => f.id !== id);
            if (currentFundId === id) currentFundId = funds[0]?.id;
            saveData();
            renderAll();
        }

        function renderFundSelector() {
            const select = document.getElementById('fund-select');
            select.innerHTML = '';
            funds.forEach(f => {
                const opt = document.createElement('option');
                opt.value = f.id;
                opt.textContent = `${f.name} (${f.code})`;
                select.appendChild(opt);
            });
            if (currentFundId) select.value = currentFundId;
            updateFundDisplay();
        }

        function updateFundDisplay() {
            const fund = getCurrentFund();
            document.getElementById('current-fund-display').textContent = fund ? `${fund.name} (${fund.code})` : '--';
        }

        function renderFundsTable() {
            const tbody = document.getElementById('funds-table');
            tbody.innerHTML = '';
            funds.forEach(f => {
                const tr = document.createElement('tr');
                const fees = `${f.subscriptionFee || 0}% / ${f.redemptionFee || 0}%`;
                tr.innerHTML = `
                    <td>${f.name}</td>
                    <td>${f.code}</td>
                    <td>${f.price.toFixed(2)}</td>
                    <td>${fees}</td>
                    <td><button class="btn-icon danger" style="padding:4px 8px;font-size:11px;" onclick="deleteFund('${f.id}')"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============ TRANSACTIONS ============
        function addTransaction() {
            const fund = getCurrentFund();
            if (!fund) {
                alert('اختر صندوق أولاً');
                return;
            }

            const date = document.getElementById('tx-date').value;
            const type = document.getElementById('tx-type').value;
            const units = parseInt(document.getElementById('tx-units').value) || 0;
            const price = parseFloat(document.getElementById('tx-price').value) || 0;

            if (!date || units <= 0 || price <= 0) {
                alert('الرجاء ملء البيانات الصحيحة');
                return;
            }

            fund.transactions.push({ date, type, units, price });
            clearTxForm();
            saveData();
            renderAll();
        }

        function deleteTransaction(fundId, idx) {
            const fund = funds.find(f => f.id === fundId);
            if (confirm('هل تريد حذف المعاملة؟')) {
                fund.transactions.splice(idx, 1);
                saveData();
                renderAll();
            }
        }

        function clearTxForm() {
            document.getElementById('tx-units').value = '';
            document.getElementById('tx-price').value = '';
            setToday();
        }

        function renderTransactionsTable() {
            const fund = getCurrentFund();
            const tbody = document.getElementById('transactions-table');
            tbody.innerHTML = '';
            
            if (!fund) return;

            fund.transactions.forEach((tx, idx) => {
                const amount = tx.units * tx.price;
                const fee = tx.type === 'buy' ? amount * (fund.subscriptionFee / 100) : amount * (fund.redemptionFee / 100);
                
                const tr = document.createElement('tr');
                const typeText = tx.type === 'buy' ? 'شراء' : 'بيع';
                const dateStr = new Date(tx.date).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US');
                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td><span style="background: ${tx.type === 'buy' ? '#10b981' : '#ef4444'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${typeText}</span></td>
                    <td>${tx.units}</td>
                    <td>${tx.price.toFixed(2)}</td>
                    <td>${amount.toFixed(2)}</td>
                    <td>${fee.toFixed(2)}</td>
                    <td><button class="btn-icon danger" style="padding:4px 8px;font-size:11px;" onclick="deleteTransaction('${fund.id}', ${idx})"><i class="fas fa-trash"></i></button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============ CALCULATIONS ============
        function calculateMetrics(fund) {
            let units = 0, invested = 0, buyUnits = 0, buyAmount = 0;

            fund.transactions.forEach(tx => {
                const amount = tx.units * tx.price;
                const fee = tx.type === 'buy' ? amount * (fund.subscriptionFee / 100) : amount * (fund.redemptionFee / 100);
                const net = amount - fee;

                if (tx.type === 'buy') {
                    units += tx.units;
                    invested += net;
                    buyUnits += tx.units;
                    buyAmount += net;
                } else {
                    units -= tx.units;
                    invested -= net;
                }
            });

            const avgPrice = buyUnits > 0 ? buyAmount / buyUnits : 0;
            const value = units * (fund.price || 0);
            const profit = value - invested;
            const returnPct = invested > 0 ? (profit / invested) * 100 : 0;

            return { units, avgPrice, value, invested, profit, returnPct };
        }

        function updatePortfolio() {
            const fund = getCurrentFund();
            if (!fund) return;

            const m = calculateMetrics(fund);

            document.getElementById('total-units').textContent = m.units;
            document.getElementById('avg-price').textContent = m.avgPrice.toFixed(2);
            document.getElementById('current-price').textContent = (fund.price || 0).toFixed(2);
            document.getElementById('current-value').textContent = m.value.toFixed(2);
            document.getElementById('total-invested').textContent = m.invested.toFixed(2);
            document.getElementById('net-profit').textContent = m.profit.toFixed(2);
            document.getElementById('return-pct').textContent = m.returnPct.toFixed(2) + '%';

            const profitEl = document.getElementById('net-profit');
            profitEl.className = m.profit >= 0 ? 'positive' : 'negative';
            
            const returnEl = document.getElementById('return-pct');
            returnEl.className = m.returnPct >= 0 ? 'positive' : 'negative';

            const valueBox = document.getElementById('value-box');
            if (m.profit >= 0) {
                valueBox.style.background = 'linear-gradient(135deg, var(--success) 0%, #059669 100%)';
            } else {
                valueBox.style.background = 'linear-gradient(135deg, var(--danger) 0%, #dc2626 100%)';
            }

            updateRecommendation(m);
            renderPriceHistory();
            updateLastUpdate();
        }

        function updateLastUpdate() {
            const fund = getCurrentFund();
            if (!fund?.priceHistory?.length) {
                document.getElementById('last-update').textContent = '--';
                return;
            }
            const latest = fund.priceHistory[fund.priceHistory.length - 1];
            const dateStr = new Date(latest.date).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US');
            document.getElementById('last-update').textContent = dateStr;
        }

        function updateRecommendation(m) {
            const rec = document.getElementById('recommendation');
            let type = 'neutral', text = '', icon = 'fa-minus';

            if (m.invested === 0) {
                text = 'ابدأ الاستثمار';
                type = 'neutral';
            } else if (m.returnPct > 15) {
                text = 'بع جزء من الأرباح';
                type = 'danger';
                icon = 'fa-arrow-up';
            } else if (m.returnPct > 8) {
                text = 'احتفظ واستمر';
                type = 'warning';
            } else if (m.returnPct < -5) {
                text = 'اشترِ أكثر';
                type = 'success';
                icon = 'fa-arrow-down';
            } else {
                text = 'مستقر';
                type = 'neutral';
            }

            rec.style.background = type === 'danger' ? '#fecaca' : type === 'success' ? '#d1fae5' : type === 'warning' ? '#fef3c7' : '#f0f0f0';
            rec.style.color = type === 'danger' ? '#991b1b' : type === 'success' ? '#065f46' : type === 'warning' ? '#b45309' : '#666';
            rec.innerHTML = `<i class="fas ${icon}"></i> ${text}`;
        }

        function renderPriceHistory() {
            const fund = getCurrentFund();
            const tbody = document.getElementById('price-history-table');
            tbody.innerHTML = '';

            if (!fund?.priceHistory) return;

            const sorted = [...fund.priceHistory].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sorted.forEach((entry, idx) => {
                const prev = idx < sorted.length - 1 ? sorted[idx + 1].price : entry.price;
                const change = ((entry.price - prev) / prev) * 100;
                const status = change > 2 ? 'ارتفاع' : change < -2 ? 'انخفاض' : 'مستقر';
                const statusIcon = change > 2 ? 'fa-arrow-up' : change < -2 ? 'fa-arrow-down' : 'fa-minus';

                const tr = document.createElement('tr');
                const dateStr = new Date(entry.date).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US');
                tr.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${entry.price.toFixed(2)}</td>
                    <td class="${change >= 0 ? 'positive' : 'negative'}">${change >= 0 ? '+' : ''}${change.toFixed(2)}%</td>
                    <td><i class="fas ${statusIcon}"></i> ${status}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ============ PRICE MANAGEMENT ============
        function updatePrice() {
            const fund = getCurrentFund();
            if (!fund) {
                alert('اختر صندوق أولاً');
                return;
            }

            const price = parseFloat(document.getElementById('price-new').value);
            const date = document.getElementById('price-date').value;

            if (!price || price <= 0 || !date) {
                alert('الرجاء ملء البيانات الصحيحة');
                return;
            }

            fund.price = price;
            const existing = fund.priceHistory.find(p => p.date === date);
            if (existing) {
                existing.price = price;
            } else {
                fund.priceHistory.push({ date, price });
            }

            saveData();
            renderAll();
            document.getElementById('price-new').value = '';
        }

        // ============ CHARTS ============
        function destroyChart(chartId) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
                delete chartInstances[chartId];
            }
        }

        function getChartColors() {
            return {
                primary: '#689B8A',
                secondary: '#F9CB99',
                accent: '#280A3E',
                success: '#10b981',
                danger: '#ef4444',
                warning: '#f59e0b',
                text: theme === 'dark' ? '#e0e0e0' : '#333'
            };
        }

        function createPriceChart() {
            const fund = getCurrentFund();
            if (!fund || !fund.priceHistory || fund.priceHistory.length === 0) return;

            destroyChart('priceChart');
            const colors = getChartColors();
            const sorted = [...fund.priceHistory].sort((a, b) => new Date(a.date) - new Date(b.date));
            const ctx = document.getElementById('priceChart');
            if (!ctx) return;

            chartInstances['priceChart'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sorted.map(p => new Date(p.date).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US')),
                    datasets: [{
                        label: fund.name,
                        data: sorted.map(p => p.price),
                        borderColor: colors.primary,
                        backgroundColor: 'rgba(104, 155, 138, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: colors.secondary,
                        pointBorderColor: colors.primary,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: colors.text, padding: 15, font: { size: 14, weight: 'bold' } }
                        },
                        tooltip: { backgroundColor: colors.accent, padding: 12 }
                    },
                    scales: {
                        y: { beginAtZero: false, grid: { color: theme === 'dark' ? '#444' : '#ddd' }, ticks: { color: colors.text } },
                        x: { grid: { display: false }, ticks: { color: colors.text } }
                    }
                }
            });
        }

        function createPortfolioChart() {
            destroyChart('portfolioChart');
            const colors = getChartColors();
            const colorPalette = [colors.primary, colors.secondary, colors.warning, colors.info = '#3b82f6', colors.danger];
            
            const data = funds.map(f => {
                const m = calculateMetrics(f);
                return m.value;
            });

            const ctx = document.getElementById('portfolioChart');
            if (!ctx) return;

            chartInstances['portfolioChart'] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: funds.map(f => f.code),
                    datasets: [{
                        data: data,
                        backgroundColor: colorPalette.slice(0, funds.length),
                        borderColor: theme === 'dark' ? '#2a1f35' : 'white',
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: colors.text, padding: 15, font: { size: 13 } }
                        },
                        tooltip: {
                            backgroundColor: colors.accent,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(2);
                                    return `${context.label}: ${context.parsed.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function createMonthlyChart() {
            destroyChart('monthlyChart');
            const colors = getChartColors();
            const monthlyData = {};

            funds.forEach(fund => {
                fund.transactions.forEach(tx => {
                    const date = new Date(tx.date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    if (!monthlyData[monthKey]) monthlyData[monthKey] = 0;
                    const amount = tx.units * tx.price;
                    const fee = tx.type === 'buy' ? amount * (fund.subscriptionFee / 100) : amount * (fund.redemptionFee / 100);
                    monthlyData[monthKey] += tx.type === 'buy' ? (amount - fee) : (amount - fee);
                });
            });

            const sortedMonths = Object.keys(monthlyData).sort();
            const ctx = document.getElementById('monthlyChart');
            if (!ctx) return;

            chartInstances['monthlyChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedMonths.map(m => {
                        const [year, month] = m.split('-');
                        return new Date(year, month - 1).toLocaleDateString(lang === 'ar' ? 'ar-EG' : 'en-US', { year: 'numeric', month: 'long' });
                    }),
                    datasets: [{
                        label: 'المعاملات الشهرية',
                        data: sortedMonths.map(m => monthlyData[m]),
                        backgroundColor: colors.primary,
                        borderColor: colors.accent,
                        borderWidth: 2,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'x',
                    plugins: {
                        legend: { labels: { color: colors.text, font: { size: 13 } } }
                    },
                    scales: {
                        y: { grid: { color: theme === 'dark' ? '#444' : '#ddd' }, ticks: { color: colors.text } },
                        x: { grid: { display: false }, ticks: { color: colors.text } }
                    }
                }
            });
        }

        function createReturnChart() {
            destroyChart('returnChart');
            const colors = getChartColors();
            const fundReturns = funds.map(fund => {
                const m = calculateMetrics(fund);
                return m.returnPct;
            });

            const ctx = document.getElementById('returnChart');
            if (!ctx) return;

            chartInstances['returnChart'] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: funds.map(f => f.code),
                    datasets: [{
                        label: 'نسبة العائد %',
                        data: fundReturns,
                        backgroundColor: fundReturns.map(r => r >= 0 ? colors.success : colors.danger),
                        borderColor: colors.text,
                        borderWidth: 1,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'x',
                    plugins: {
                        legend: { labels: { color: colors.text, font: { size: 13 } } },
                        tooltip: {
                            backgroundColor: colors.accent,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.y.toFixed(2)}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: theme === 'dark' ? '#444' : '#ddd' },
                            ticks: {
                                color: colors.text,
                                callback: function(value) {
                                    return value.toFixed(0) + '%';
                                }
                            }
                        },
                        x: { grid: { display: false }, ticks: { color: colors.text } }
                    }
                }
            });
        }

        function updateStatistics() {
            const totalTx = funds.reduce((sum, f) => sum + f.transactions.length, 0);
            let best = { code: '--', value: -999 };
            let worst = { code: '--', value: 999 };

            funds.forEach(f => {
                const m = calculateMetrics(f);
                if (m.returnPct > best.value) best = { code: f.code, value: m.returnPct };
                if (m.returnPct < worst.value) worst = { code: f.code, value: m.returnPct };
            });

            document.getElementById('stats-funds-count').textContent = funds.length;
            document.getElementById('stats-tx-count').textContent = totalTx;
            document.getElementById('stats-best-fund').textContent = best.value === -999 ? '--' : `${best.code} (${best.value.toFixed(2)}%)`;
            document.getElementById('stats-worst-fund').textContent = worst.value === 999 ? '--' : `${worst.code} (${worst.value.toFixed(2)}%)`;
        }

        function updateAllCharts() {
            createPriceChart();
            createPortfolioChart();
            createMonthlyChart();
            createReturnChart();
            updateStatistics();
        }

        // ============ EXPORT/IMPORT ============
        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportJSON() {
            const data = { funds, timestamp: new Date().toISOString() };
            downloadFile(JSON.stringify(data, null, 2), `investment-backup-${new Date().toISOString().split('T')[0]}.json`, 'application/json');
        }

        function exportCSV() {
            let csv = 'الصندوق,الكود,التاريخ,النوع,الوثائق,السعر,المبلغ,الرسوم\n';
            funds.forEach(f => {
                f.transactions.forEach(tx => {
                    const amount = tx.units * tx.price;
                    const fee = tx.type === 'buy' ? amount * (f.subscriptionFee / 100) : amount * (f.redemptionFee / 100);
                    csv += `"${f.name}","${f.code}","${tx.date}","${tx.type === 'buy' ? 'شراء' : 'بيع'}",${tx.units},${tx.price},${amount},${fee}\n`;
                });
            });
            downloadFile(csv, `investment-backup-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
        }

        function exportExcel() {
            const data = [];
            funds.forEach(f => {
                f.transactions.forEach(tx => {
                    const amount = tx.units * tx.price;
                    const fee = tx.type === 'buy' ? amount * (f.subscriptionFee / 100) : amount * (f.redemptionFee / 100);
                    data.push({
                        'الصندوق': f.name,
                        'الكود': f.code,
                        'التاريخ': tx.date,
                        'النوع': tx.type === 'buy' ? 'شراء' : 'بيع',
                        'الوثائق': tx.units,
                        'السعر': tx.price,
                        'المبلغ': amount,
                        'الرسوم': fee,
                        'السعر الحالي': f.price
                    });
                });
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'الاستثمارات');
            XLSX.writeFile(wb, `investment-backup-${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        function exportPDF() {
            const element = document.getElementById('dashboard');
            const opt = {
                margin: 10,
                filename: `investment-report-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, backgroundColor: '#F2EDD1' },
                jsPDF: { orientation: 'p', unit: 'mm', format: 'a4' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function importFile() {
            const file = document.getElementById('import-file').files[0];
            if (!file) {
                alert('اختر ملف أولاً');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const fileType = file.name.split('.').pop().toLowerCase();
                    if (fileType === 'json') {
                        const data = JSON.parse(e.target.result);
                        funds = data.funds || [];
                    } else if (fileType === 'csv') {
                        Papa.parse(e.target.result, {
                            complete: (results) => {
                                funds = [];
                                results.data.slice(1).forEach(row => {
                                    if (row.length < 3) return;
                                    const fundName = row[0];
                                    const fundCode = row[1];
                                    let fund = funds.find(f => f.name === fundName && f.code === fundCode);
                                    if (!fund) {
                                        fund = {
                                            id: Date.now().toString() + Math.random(),
                                            name: fundName,
                                            code: fundCode,
                                            price: parseFloat(row[8]) || 0,
                                            subscriptionFee: 0,
                                            redemptionFee: 0,
                                            transactions: [],
                                            priceHistory: []
                                        };
                                        funds.push(fund);
                                    }
                                    if (row[2] && row[3]) {
                                        fund.transactions.push({
                                            date: row[2],
                                            type: row[3].includes('شراء') ? 'buy' : 'sell',
                                            units: parseInt(row[4]) || 0,
                                            price: parseFloat(row[5]) || 0
                                        });
                                    }
                                });
                                currentFundId = funds[0]?.id;
                                saveData();
                                renderAll();
                                alert('تم الاستيراد بنجاح');
                            }
                        });
                        return;
                    } else if (fileType === 'xlsx') {
                        const workbook = XLSX.read(e.target.result, { type: 'binary' });
                        const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                        const data = XLSX.utils.sheet_to_json(worksheet);
                        funds = [];
                        data.forEach(row => {
                            const fundName = row['الصندوق'] || row['Fund'] || '';
                            const fundCode = row['الكود'] || row['Code'] || '';
                            let fund = funds.find(f => f.name === fundName && f.code === fundCode);
                            if (!fund) {
                                fund = {
                                    id: Date.now().toString() + Math.random(),
                                    name: fundName,
                                    code: fundCode,
                                    price: parseFloat(row['السعر الحالي'] || row['Current Price']) || 0,
                                    subscriptionFee: 0,
                                    redemptionFee: 0,
                                    transactions: [],
                                    priceHistory: []
                                };
                                funds.push(fund);
                            }
                            fund.transactions.push({
                                date: row['التاريخ'] || row['Date'] || new Date().toISOString().split('T')[0],
                                type: (row['النوع'] || row['Type'] || '').includes('شراء') ? 'buy' : 'sell',
                                units: parseInt(row['الوثائق'] || row['Units']) || 0,
                                price: parseFloat(row['السعر'] || row['Price']) || 0
                            });
                        });
                    }
                    currentFundId = funds[0]?.id;
                    saveData();
                    renderAll();
                    alert('تم الاستيراد بنجاح');
                } catch (err) {
                    alert('خطأ في الملف: ' + err.message);
                }
            };

            if (file.name.endsWith('.xlsx')) {
                reader.readAsBinaryString(file);
            } else {
                reader.readAsText(file);
            }
        }

        function clearAllData() {
            if (!confirm('هل تريد حذف جميع البيانات؟')) return;
            funds = [];
            currentFundId = null;
            saveData();
            renderAll();
        }

        // ============ DATA ============
        function saveData() {
            localStorage.setItem('investment_app', JSON.stringify({ funds, currentFundId }));
        }

        function loadData() {
            const data = JSON.parse(localStorage.getItem('investment_app') || '{"funds":[],"currentFundId":null}');
            funds = data.funds || [];
            currentFundId = data.currentFundId || funds[0]?.id;
            
            if (funds.length === 0) {
                funds = [{
                    id: '1',
                    name: 'صندوق عزيموت',
                    code: 'AZM',
                    price: 16.5,
                    subscriptionFee: 1,
                    redemptionFee: 2,
                    transactions: [{ date: '2025-01-15', type: 'buy', units: 100, price: 15.5 }],
                    priceHistory: [
                        { date: '2025-01-15', price: 15.5 },
                        { date: new Date().toISOString().split('T')[0], price: 16.5 }
                    ]
                }];
                currentFundId = '1';
            }
        }

        // ============ HELPERS ============
        function getCurrentFund() {
            return funds.find(f => f.id === currentFundId);
        }

        function renderAll() {
            renderFundSelector();
            document.getElementById('fund-select').addEventListener('change', (e) => {
                currentFundId = e.target.value;
                updateFundDisplay();
                updatePortfolio();
                renderTransactionsTable();
                saveData();
            });
            updatePortfolio();
            renderTransactionsTable();
            renderFundsTable();
        }

        // ============ START ============
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>